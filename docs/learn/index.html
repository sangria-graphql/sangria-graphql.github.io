<!DOCTYPE html>
<html lang="en">

<head>
  <!-- meta stuff -->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Sangria - Scala GraphQL Implementation">
  <meta name="keywords" content="sangria,scala,graphql" />

  <link rel="shortcut icon" type="image/png" href="/assets/img/favicon.png">

  <link rel="canonical" href="https://sangria-graphql.github.io" />

  <meta name="description" content="Sangria - Scala GraphQL Implementation">

  <meta property="og:type" content="article">
  <meta property="og:url" content="http://sangria-graphql.github.io">
  <meta property="og:title" content="Sangria - Scala GraphQL Implementation">
  <meta property="og:description" content="Learn Sangria">
  <meta property="og:image:url" content="http://sangria-graphql.github.io/assets/img/share-sangria.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@easyangel">
  <meta name="twitter:creator" content="@easyangel">
  <meta name="twitter:title" content="Sangria - Scala GraphQL Implementation">
  <meta name="twitter:description" content="Learn Sangria">
  <meta name="twitter:image" content="http://sangria-graphql.github.io/assets/img/share-sangria.png">

  <!-- /meta stuff -->

  <title>Learn Sangria</title>

  <!-- Bootstrap core CSS -->
  <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="/assets/css/syntax.css" rel="stylesheet">
  <link href="/assets/css/sidebar.css" rel="stylesheet">

  
    <link href="/assets/bootstrap/css/bootstrap-flatly.min.css"" rel="stylesheet">
  

  <link href="/assets/css/main.css" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,400i,700,700i|Roboto:100,300,300i,700" rel="stylesheet">

  <script src="//use.typekit.net/wng7fcn.js"></script>
  <script>try{Typekit.load();}catch(e){}</script>

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>



<body data-animate-header="false" class="">

  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <a href="/">
        <img class="logo" src="/assets/img/sangria-logo-1.svg" />
      </a>

      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>

    <div class="navbar-collapse collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li class=""><a href="/getting-started">Getting Started</a></li>
        <li><a href="https://github.com/sangria-graphql/sangria-playground">Try</a></li>
        <li><a href="https://github.com/OlegIlyenko/graphql-toolbox">Toolbox</a></li>
        <li class=""><a href="/download">Download</a></li>
        <li class="active"><a href="/learn">Learn</a></li>
        <li class=""><a href="/community">Community</a></li>
        <li><a target="_blank" href="https://github.com/sangria-graphql" title="Sangria at GitHub"><i class="fa fa-github fa-lg"></i></a></li>
      </ul>
    </div>
  </div>
</div>


  <div class="secondary-spacer"></div>

<div class="container">
  <div class="row">
    <div class="col-md-9 main-content main-section">
      <h2 id="overview">Overview</h2>

<p><strong>Sangria</strong> is a Scala <a href="http://facebook.github.io/graphql/">GraphQL</a> implementation.</p>

<p>Here is how you can add it to your SBT project:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"org.sangria-graphql"</span> <span class="o">%%</span> <span class="s">"sangria"</span> <span class="o">%</span> <span class="s">"4.0.0"</span>
</code></pre></div></div>

<p>You can find an example application that uses akka-http with <em>sangria</em> here:</p>

<p><a href="https://github.com/sangria-graphql/sangria-akka-http-example">https://github.com/sangria-graphql/sangria-akka-http-example</a></p>

<p>I would also recommend that you check out <a href="https://github.com/sangria-graphql/sangria-playground">https://github.com/sangria-graphql/sangria-playground</a>.
It is an example of a GraphQL server written with Play framework and Sangria. It also serves as a playground,
where you can interactively execute GraphQL queries and play with some examples.</p>

<p><a href="http://dev.apollodata.com/">Apollo Client</a> is a full featured, simple to use GraphQL client with convenient integrations for popular view layers. Apollo Client is an easy way to get started with Sangria as they’re 100% compatible.</p>

<p>If you want to use sangria with the react-relay framework, then you also need to include <a href="https://github.com/sangria-graphql/sangria-relay">sangria-relay</a>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"org.sangria-graphql"</span> <span class="o">%%</span> <span class="s">"sangria-relay"</span> <span class="o">%</span> <span class="s">"2.0.0"</span>
</code></pre></div></div>

<p>Sangria-relay Playground (<a href="https://github.com/sangria-graphql/sangria-relay-playground">https://github.com/sangria-graphql/sangria-relay-playground</a>) is a nice place to start if you would like to see it in action.</p>

<p>I would also recommend that you check out <a href="/community/#videos">“Videos” section of the community page</a>.
It has a lot of nice introduction videos.</p>

<h2 id="query-parser-and-renderer">Query Parser and Renderer</h2>

<p>Example usage:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sangria.ast.Document</span>
<span class="k">import</span> <span class="nn">sangria.parser.QueryParser</span>
<span class="k">import</span> <span class="nn">sangria.renderer.QueryRenderer</span>

<span class="k">import</span> <span class="nn">scala.util.Success</span>

<span class="k">val</span> <span class="nv">query</span> <span class="k">=</span>
  <span class="s">"""
    query FetchLukeAndLeiaAliased(
          $someVar: Int = 1.23
          $anotherVar: Int = 123) @include(if: true) {
      luke: human(id: "1000")@include(if: true){
        friends(sort: NAME)
      }

      leia: human(id: "10103\n \u00F6 ö") {
        name
      }

      ... on User {
        birth{day}
      }

      ...Foo
    }

    fragment Foo on User @foo(bar: 1) {
      baz
    }
  """</span>

<span class="c1">// Parse GraphQL query</span>
<span class="nv">QueryParser</span><span class="o">.</span><span class="py">parse</span><span class="o">(</span><span class="n">query</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">document</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="c1">// Pretty rendering of the GraphQL query as a `String`</span>
    <span class="nf">println</span><span class="o">(</span><span class="nv">document</span><span class="o">.</span><span class="py">renderPretty</span><span class="o">)</span>

  <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">error</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Syntax error: ${error.getMessage}"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Alternatively you can use <code class="language-plaintext highlighter-rouge">graphql</code> macro, which will ensure that your query is syntactically correct at compile time:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sangria.macros._</span>

<span class="k">val</span> <span class="nv">queryAst</span><span class="k">:</span> <span class="kt">Document</span> <span class="o">=</span>
  <span class="n">graphql</span><span class="s">"""
    {
      name
      friends {
        id
        name
      }
    }
  """</span>
</code></pre></div></div>

<p>You can also parse and render the GraphQL input values independently from a query document:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sangria.renderer.QueryRenderer</span>
<span class="k">import</span> <span class="nn">sangria.macros._</span>
<span class="k">import</span> <span class="nn">sangria.ast</span>

<span class="k">val</span> <span class="nv">parsed</span><span class="k">:</span> <span class="kt">ast.Value</span> <span class="o">=</span>
  <span class="n">graphqlInput</span><span class="s">"""
    {
      id: "1234345"
      version: 2 # changed 2 times
      deliveries: [
        {id: 123, received: false, note: null, state: OPEN}
      ]
    }
  """</span>

<span class="nf">println</span><span class="o">(</span><span class="nv">parsed</span><span class="o">.</span><span class="py">renderPretty</span><span class="o">)</span>
</code></pre></div></div>

<h2 id="schema-definition">Schema Definition</h2>

<p>Here is an example of GraphQL schema DSL:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sangria.schema._</span>

<span class="k">val</span> <span class="nv">EpisodeEnum</span> <span class="k">=</span> <span class="nc">EnumType</span><span class="o">(</span>
  <span class="s">"Episode"</span><span class="o">,</span>
  <span class="nc">Some</span><span class="o">(</span><span class="s">"One of the films in the Star Wars Trilogy"</span><span class="o">),</span>
  <span class="nc">List</span><span class="o">(</span>
    <span class="nc">EnumValue</span><span class="o">(</span><span class="s">"NEWHOPE"</span><span class="o">,</span>
      <span class="n">value</span> <span class="k">=</span> <span class="nv">TestData</span><span class="o">.</span><span class="py">Episode</span><span class="o">.</span><span class="py">NEWHOPE</span><span class="o">,</span>
      <span class="n">description</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="s">"Released in 1977."</span><span class="o">)),</span>
    <span class="nc">EnumValue</span><span class="o">(</span><span class="s">"EMPIRE"</span><span class="o">,</span>
      <span class="n">value</span> <span class="k">=</span> <span class="nv">TestData</span><span class="o">.</span><span class="py">Episode</span><span class="o">.</span><span class="py">EMPIRE</span><span class="o">,</span>
      <span class="n">description</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="s">"Released in 1980."</span><span class="o">)),</span>
    <span class="nc">EnumValue</span><span class="o">(</span><span class="s">"JEDI"</span><span class="o">,</span>
      <span class="n">value</span> <span class="k">=</span> <span class="nv">TestData</span><span class="o">.</span><span class="py">Episode</span><span class="o">.</span><span class="py">JEDI</span><span class="o">,</span>
      <span class="n">description</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="s">"Released in 1983."</span><span class="o">))))</span>

<span class="k">val</span> <span class="nv">Character</span><span class="k">:</span> <span class="kt">InterfaceType</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">TestData.Character</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">InterfaceType</span><span class="o">(</span>
    <span class="s">"Character"</span><span class="o">,</span>
    <span class="s">"A character in the Star Wars Trilogy"</span><span class="o">,</span>
    <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">fields</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">TestData.Character</span><span class="o">](</span>
      <span class="nc">Field</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span>
        <span class="nc">Some</span><span class="o">(</span><span class="s">"The id of the character."</span><span class="o">),</span>
        <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">id</span><span class="o">),</span>
      <span class="nc">Field</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">),</span>
        <span class="nc">Some</span><span class="o">(</span><span class="s">"The name of the character."</span><span class="o">),</span>
        <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">name</span><span class="o">),</span>
      <span class="nc">Field</span><span class="o">(</span><span class="s">"friends"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ListType</span><span class="o">(</span><span class="nc">OptionType</span><span class="o">(</span><span class="nc">Character</span><span class="o">))),</span>
        <span class="nc">Some</span><span class="o">(</span><span class="s">"The friends of the character, or an empty list if they have none."</span><span class="o">),</span>
        <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="nc">DeferFriends</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">friends</span><span class="o">)),</span>
      <span class="nc">Field</span><span class="o">(</span><span class="s">"appearsIn"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ListType</span><span class="o">(</span><span class="nc">OptionType</span><span class="o">(</span><span class="nc">EpisodeEnum</span><span class="o">))),</span>
        <span class="nc">Some</span><span class="o">(</span><span class="s">"Which movies they appear in."</span><span class="o">),</span>
        <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">appearsIn</span> <span class="nf">map</span> <span class="o">(</span><span class="n">e</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">e</span><span class="o">)))</span>
    <span class="o">))</span>

<span class="k">val</span> <span class="nv">Human</span> <span class="k">=</span>
  <span class="nc">ObjectType</span><span class="o">(</span>
    <span class="s">"Human"</span><span class="o">,</span>
    <span class="s">"A humanoid creature in the Star Wars universe."</span><span class="o">,</span>
    <span class="n">interfaces</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">Human</span><span class="o">](</span><span class="nc">Character</span><span class="o">),</span>
    <span class="n">fields</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">Human</span><span class="o">](</span>
      <span class="nc">Field</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span>
        <span class="nc">Some</span><span class="o">(</span><span class="s">"The id of the human."</span><span class="o">),</span>
        <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">id</span><span class="o">),</span>
      <span class="nc">Field</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">),</span>
        <span class="nc">Some</span><span class="o">(</span><span class="s">"The name of the human."</span><span class="o">),</span>
        <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">name</span><span class="o">),</span>
      <span class="nc">Field</span><span class="o">(</span><span class="s">"friends"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ListType</span><span class="o">(</span><span class="nc">OptionType</span><span class="o">(</span><span class="nc">Character</span><span class="o">))),</span>
        <span class="nc">Some</span><span class="o">(</span><span class="s">"The friends of the human, or an empty list if they have none."</span><span class="o">),</span>
        <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="nc">DeferFriends</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">friends</span><span class="o">)),</span>
      <span class="nc">Field</span><span class="o">(</span><span class="s">"appearsIn"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ListType</span><span class="o">(</span><span class="nc">OptionType</span><span class="o">(</span><span class="nc">EpisodeEnum</span><span class="o">))),</span>
        <span class="nc">Some</span><span class="o">(</span><span class="s">"Which movies they appear in."</span><span class="o">),</span>
        <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">appearsIn</span> <span class="nf">map</span> <span class="o">(</span><span class="n">e</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">e</span><span class="o">))),</span>
      <span class="nc">Field</span><span class="o">(</span><span class="s">"homePlanet"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">),</span>
        <span class="nc">Some</span><span class="o">(</span><span class="s">"The home planet of the human, or null if unknown."</span><span class="o">),</span>
        <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">homePlanet</span><span class="o">)</span>
    <span class="o">))</span>

<span class="k">val</span> <span class="nv">Droid</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">(</span>
  <span class="s">"Droid"</span><span class="o">,</span>
  <span class="s">"A mechanical creature in the Star Wars universe."</span><span class="o">,</span>
  <span class="n">interfaces</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">Droid</span><span class="o">](</span><span class="nc">Character</span><span class="o">),</span>
  <span class="n">fields</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">Droid</span><span class="o">](</span>
    <span class="nc">Field</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span>
      <span class="nc">Some</span><span class="o">(</span><span class="s">"The id of the droid."</span><span class="o">),</span>
      <span class="n">tags</span> <span class="k">=</span> <span class="nc">ProjectionName</span><span class="o">(</span><span class="s">"_id"</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
      <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">id</span><span class="o">),</span>
    <span class="nc">Field</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">),</span>
      <span class="nc">Some</span><span class="o">(</span><span class="s">"The name of the droid."</span><span class="o">),</span>
      <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="nv">Future</span><span class="o">.</span><span class="py">successful</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">name</span><span class="o">)),</span>
    <span class="nc">Field</span><span class="o">(</span><span class="s">"friends"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ListType</span><span class="o">(</span><span class="nc">OptionType</span><span class="o">(</span><span class="nc">Character</span><span class="o">))),</span>
      <span class="nc">Some</span><span class="o">(</span><span class="s">"The friends of the droid, or an empty list if they have none."</span><span class="o">),</span>
      <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="nc">DeferFriends</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">friends</span><span class="o">)),</span>
    <span class="nc">Field</span><span class="o">(</span><span class="s">"appearsIn"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ListType</span><span class="o">(</span><span class="nc">OptionType</span><span class="o">(</span><span class="nc">EpisodeEnum</span><span class="o">))),</span>
      <span class="nc">Some</span><span class="o">(</span><span class="s">"Which movies they appear in."</span><span class="o">),</span>
      <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">appearsIn</span> <span class="nf">map</span> <span class="o">(</span><span class="n">e</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">e</span><span class="o">))),</span>
    <span class="nc">Field</span><span class="o">(</span><span class="s">"primaryFunction"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">),</span>
      <span class="nc">Some</span><span class="o">(</span><span class="s">"The primary function of the droid."</span><span class="o">),</span>
      <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">primaryFunction</span><span class="o">)</span>
  <span class="o">))</span>

<span class="k">val</span> <span class="nv">ID</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="n">description</span> <span class="k">=</span> <span class="s">"id of the character"</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">EpisodeArg</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"episode"</span><span class="o">,</span> <span class="nc">OptionInputType</span><span class="o">(</span><span class="nc">EpisodeEnum</span><span class="o">),</span>
  <span class="n">description</span> <span class="k">=</span> <span class="s">"If omitted, returns the hero of the whole saga. If provided, returns the hero of that particular episode."</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">Query</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">[</span><span class="kt">CharacterRepo</span>, <span class="kt">Unit</span><span class="o">](</span>
  <span class="s">"Query"</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="kt">CharacterRepo</span>, <span class="kt">Unit</span><span class="o">](</span>
    <span class="nc">Field</span><span class="o">(</span><span class="s">"hero"</span><span class="o">,</span> <span class="nc">Character</span><span class="o">,</span>
      <span class="n">arguments</span> <span class="k">=</span> <span class="nc">EpisodeArg</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
      <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">getHero</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">argOpt</span><span class="o">(</span><span class="nc">EpisodeArg</span><span class="o">))),</span>
    <span class="nc">Field</span><span class="o">(</span><span class="s">"human"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">Human</span><span class="o">),</span>
      <span class="n">arguments</span> <span class="k">=</span> <span class="nc">ID</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
      <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">getHuman</span><span class="o">(</span><span class="n">ctx</span> <span class="n">arg</span> <span class="nc">ID</span><span class="o">)),</span>
    <span class="nc">Field</span><span class="o">(</span><span class="s">"droid"</span><span class="o">,</span> <span class="nc">Droid</span><span class="o">,</span>
      <span class="n">arguments</span> <span class="k">=</span> <span class="nc">ID</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
      <span class="n">resolve</span> <span class="k">=</span> <span class="nc">Projector</span><span class="o">((</span><span class="n">ctx</span><span class="o">,</span> <span class="n">f</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">getDroid</span><span class="o">(</span><span class="n">ctx</span> <span class="n">arg</span> <span class="nc">ID</span><span class="o">).</span><span class="py">get</span><span class="o">))</span>
  <span class="o">))</span>

<span class="k">val</span> <span class="nv">StarWarsSchema</span> <span class="k">=</span> <span class="nc">Schema</span><span class="o">(</span><span class="nc">Query</span><span class="o">)</span>
</code></pre></div></div>

<h3 id="actions">Actions</h3>

<p>The <code class="language-plaintext highlighter-rouge">resolve</code> argument of a <code class="language-plaintext highlighter-rouge">Field</code> expects a function of type <code class="language-plaintext highlighter-rouge">Context[Ctx, Val] =&gt; Action[Ctx, Res]</code>.
As you can see, the result of the <code class="language-plaintext highlighter-rouge">resolve</code> is an <code class="language-plaintext highlighter-rouge">Action</code> type which can take different shapes.
Here is the list of supported actions:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Value</code> - a simple value result. If you want to indicate an error, you need to throw an exception</li>
  <li><code class="language-plaintext highlighter-rouge">TryValue</code> - a <code class="language-plaintext highlighter-rouge">scala.util.Try</code> result</li>
  <li><code class="language-plaintext highlighter-rouge">FutureValue</code> - a <code class="language-plaintext highlighter-rouge">Future</code> result</li>
  <li><code class="language-plaintext highlighter-rouge">PartialValue</code> - a partially successful result with a list of errors</li>
  <li><code class="language-plaintext highlighter-rouge">PartialFutureValue</code> - a <code class="language-plaintext highlighter-rouge">Future</code> of partially successful result</li>
  <li><code class="language-plaintext highlighter-rouge">DeferredValue</code> - used to return a <code class="language-plaintext highlighter-rouge">Deferred</code> result (see the <a href="#deferred-value-resolution">Deferred Values and Resolver</a> section for more details)</li>
  <li><code class="language-plaintext highlighter-rouge">DeferredFutureValue</code> - the same as <code class="language-plaintext highlighter-rouge">DeferredValue</code> but allows you to return <code class="language-plaintext highlighter-rouge">Deferred</code> inside of a <code class="language-plaintext highlighter-rouge">Future</code></li>
  <li><code class="language-plaintext highlighter-rouge">UpdateCtx</code> - allows you to transform a <code class="language-plaintext highlighter-rouge">Ctx</code> object. The transformed context object would be available for nested sub-objects and subsequent sibling fields in case of mutation (since execution of mutation queries is strictly sequential). You can find an example of its usage in the <a href="#authentication-and-authorisation">Authentication and Authorisation</a> section.</li>
</ul>

<p>Normally the library is able to automatically infer the <code class="language-plaintext highlighter-rouge">Action</code> type, so that you don’t need to specify it explicitly.</p>

<h3 id="projections">Projections</h3>

<p>Sangria also introduces the concept of projections. If you are fetching your data from the database (like let’s say MongoDB), then it can be
very helpful to know which fields are needed for the query ahead-of-time in order to make an efficient projection in the DB query.</p>

<p><code class="language-plaintext highlighter-rouge">Projector</code> allows you to do precisely this. It wraps a <code class="language-plaintext highlighter-rouge">resolve</code> function and enhances it
with the list of projected fields (limited by depth). The <code class="language-plaintext highlighter-rouge">ProjectionName</code> field tag allows you to customize projected
field names (this is helpful if your DB field names are different from the GraphQL field names).
The <code class="language-plaintext highlighter-rouge">ProjectionExclude</code> field tag, on the other hand, allows you to exclude a field from the list of projected field names.</p>

<h3 id="input-and-context-objects">Input and Context Objects</h3>

<p>Many schema elements, like <code class="language-plaintext highlighter-rouge">ObjectType</code>, <code class="language-plaintext highlighter-rouge">Field</code> or <code class="language-plaintext highlighter-rouge">Schema</code> itself, take two type parameters: <code class="language-plaintext highlighter-rouge">Ctx</code> and <code class="language-plaintext highlighter-rouge">Val</code>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Val</code> - represent values that are returned by the <code class="language-plaintext highlighter-rouge">resolve</code> function and given to the <code class="language-plaintext highlighter-rouge">resolve</code> function as a part of the <code class="language-plaintext highlighter-rouge">Context</code>. In the schema example,
<code class="language-plaintext highlighter-rouge">Val</code> can be a <code class="language-plaintext highlighter-rouge">Human</code>, <code class="language-plaintext highlighter-rouge">Droid</code>, <code class="language-plaintext highlighter-rouge">String</code>, etc.</li>
  <li><code class="language-plaintext highlighter-rouge">Ctx</code> - represents some contextual object that flows across the whole execution (and doesn’t change in most of the cases). It can be provided to execution by the user
in order to help fulfill the GraphQL query. A typical example of such a context object is a service or repository object that is able to access
a database. In the example schema, some of the fields (like <code class="language-plaintext highlighter-rouge">droid</code> or <code class="language-plaintext highlighter-rouge">human</code>) make use of it in order to access the character repository.</li>
</ul>

<h3 id="providing-additional-types">Providing Additional Types</h3>

<p>After a schema is defined, the library tries to discover all of the supported GraphQL types by traversing the schema. Sometimes you have a situation where not all
GraphQL types are explicitly reachable from the root of the schema. For instance, if the example schema had only the <code class="language-plaintext highlighter-rouge">hero</code> field in the <code class="language-plaintext highlighter-rouge">Query</code> type, then
it would not be possible to automatically discover the <code class="language-plaintext highlighter-rouge">Human</code> and the <code class="language-plaintext highlighter-rouge">Droid</code> type, since only the <code class="language-plaintext highlighter-rouge">Character</code> interface type is referenced inside of the schema.</p>

<p>If you have a similar situation, then you need to provide additional types like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">HeroOnlyQuery</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">[</span><span class="kt">CharacterRepo</span>, <span class="kt">Unit</span><span class="o">](</span>
  <span class="s">"HeroOnlyQuery"</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="kt">CharacterRepo</span>, <span class="kt">Unit</span><span class="o">](</span>
    <span class="nc">Field</span><span class="o">(</span><span class="s">"hero"</span><span class="o">,</span> <span class="nv">TestSchema</span><span class="o">.</span><span class="py">Character</span><span class="o">,</span>
      <span class="n">arguments</span> <span class="k">=</span> <span class="nv">TestSchema</span><span class="o">.</span><span class="py">EpisodeArg</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
      <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">getHero</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">argOpt</span><span class="o">(</span><span class="nv">TestSchema</span><span class="o">.</span><span class="py">EpisodeArg</span><span class="o">)))</span>
  <span class="o">))</span>

<span class="k">val</span> <span class="nv">heroOnlySchema</span> <span class="k">=</span> <span class="nc">Schema</span><span class="o">(</span><span class="nc">HeroOnlyQuery</span><span class="o">,</span>
  <span class="n">additionalTypes</span> <span class="k">=</span> <span class="nv">TestSchema</span><span class="o">.</span><span class="py">Human</span> <span class="o">::</span> <span class="nv">TestSchema</span><span class="o">.</span><span class="py">Droid</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
</code></pre></div></div>

<p>Alternatively you can use <code class="language-plaintext highlighter-rouge">manualPossibleTypes</code> on the <code class="language-plaintext highlighter-rouge">Field</code> and <code class="language-plaintext highlighter-rouge">InterfaceType</code> to achieve the same effect.</p>

<h3 id="circular-references-and-recursive-types">Circular References and Recursive Types</h3>

<p>In some cases you need to define a GraphQL schema that contains recursive types or has circular references in the object graph. Sangria supports such schemas
by allowing you to provide a no-arg function that creates <code class="language-plaintext highlighter-rouge">ObjectType</code> fields instead of an eager list of fields. Here is an example of interdependent types:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">A</span><span class="o">(</span><span class="n">b</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">B</span><span class="o">],</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">B</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">size</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

<span class="k">lazy</span> <span class="k">val</span> <span class="nv">AType</span><span class="k">:</span> <span class="kt">ObjectType</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">(</span><span class="s">"A"</span><span class="o">,</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">fields</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">A</span><span class="o">](</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">name</span><span class="o">),</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"b"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">BType</span><span class="o">),</span> <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">b</span><span class="o">)))</span>

<span class="k">lazy</span> <span class="k">val</span> <span class="nv">BType</span><span class="k">:</span> <span class="kt">ObjectType</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">(</span><span class="s">"B"</span><span class="o">,</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="n">fields</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">B</span><span class="o">](</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"size"</span><span class="o">,</span> <span class="nc">IntType</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">size</span><span class="o">),</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="nc">AType</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">a</span><span class="o">)))</span>
</code></pre></div></div>

<p>In most cases you also need to define (at least one of) these types with <code class="language-plaintext highlighter-rouge">lazy val</code>.</p>

<h3 id="schema-rendering">Schema Rendering</h3>

<p>You can render a schema or an introspection result in human-readable form (SDL syntax) with <code class="language-plaintext highlighter-rouge">SchemaRenderer</code>. Here is an example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">SchemaRenderer</span><span class="o">.</span><span class="py">renderSchema</span><span class="o">(</span><span class="nv">SchemaDefinition</span><span class="o">.</span><span class="py">StarWarsSchema</span><span class="o">)</span>
</code></pre></div></div>

<p>For a StarWars schema it will produce the following results:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>interface Character {
  id: String!
  name: String
  friends: [Character]
  appearsIn: [Episode]
}

type Droid implements Character {
  id: String!
  name: String
  friends: [Character]
  appearsIn: [Episode]
  primaryFunction: String
}

enum Episode {
  NEWHOPE
  EMPIRE
  JEDI
}

type Human implements Character {
  id: String!
  name: String
  friends: [Character]
  appearsIn: [Episode]
  homePlanet: String
}

type Query {
  hero(episode: Episode): Character!
  human(id: String!): Human
  droid(id: String!): Droid!
}
</code></pre></div></div>

<h2 id="macro-based-graphql-type-derivation">Macro-Based GraphQL Type Derivation</h2>

<p>Defining schema with <code class="language-plaintext highlighter-rouge">ObjectType</code>, <code class="language-plaintext highlighter-rouge">InputObjectType</code> and <code class="language-plaintext highlighter-rouge">EnumType</code> can become quite verbose. They provide maximum flexibility, but sometimes you just have a simple case class which you would like to expose via GraphQL API.</p>

<p>For this, sangria provides a set of macros that are able to derive GraphQL types from normal Scala classes, case classes and enums:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">deriveObjectType[Ctx, Val]</code> - constructs an <code class="language-plaintext highlighter-rouge">ObjectType[Ctx, Val]</code> with fields found in <code class="language-plaintext highlighter-rouge">Val</code> class (case class accessors and members annotated with <code class="language-plaintext highlighter-rouge">@GraphQLField</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">deriveContextObjectType[Ctx, Target, Val]</code> - constructs an <code class="language-plaintext highlighter-rouge">ObjectType[Ctx, Val]</code> with fields found in <code class="language-plaintext highlighter-rouge">Target</code> class (case class accessors and members annotated with <code class="language-plaintext highlighter-rouge">@GraphQLField</code>). You also need to provide it a function <code class="language-plaintext highlighter-rouge">Ctx =&gt; Target</code> which the macro will use to get an instance of <code class="language-plaintext highlighter-rouge">Target</code> type from a user context.</li>
  <li><code class="language-plaintext highlighter-rouge">deriveInputObjectType[T]</code> - constructs an <code class="language-plaintext highlighter-rouge">InputObjectType[T]</code> with fields found in <code class="language-plaintext highlighter-rouge">T</code> case class (only supports case class accessors)</li>
  <li><code class="language-plaintext highlighter-rouge">deriveEnumType[T]</code> - constructs an <code class="language-plaintext highlighter-rouge">EnumType[T]</code> with values found in <code class="language-plaintext highlighter-rouge">T</code> enumeration. It supports Scala <code class="language-plaintext highlighter-rouge">Enumeration</code> as well as sealed hierarchies of case objects.</li>
</ul>

<p>You need the following import to use them:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sangria.macros.derive._</span>
</code></pre></div></div>

<p>The use of these macros is completely optional, they just provide a bit of convenience when you need it. <a href="#schema-definition">Schema Definition DSL</a> is the primary way to define a schema.</p>

<p>You can also influence the derivation by either providing a list of settings to the macro or using <code class="language-plaintext highlighter-rouge">@GraphQL*</code> annotations (these are <code class="language-plaintext highlighter-rouge">StaticAnnotation</code>s and only used to customize a macro code generation - they are erased at the runtime). This provides a very flexible way to derive GraphQL types based on your domain model - you can customize almost any aspect of the resulting GraphQL type (change names, add descriptions, add fields, deprecate fields, etc.).</p>

<p>In order to discover other GraphQL types, the macros use implicits. So if you derive interdependent types, make sure to make them implicitly available in the scope.</p>

<h3 id="objecttype-derivation">ObjectType Derivation</h3>

<p><code class="language-plaintext highlighter-rouge">deriveObjectType</code> and <code class="language-plaintext highlighter-rouge">deriveContextObjectType</code> support arbitrary case classes as well as normal classes/traits.</p>

<p>Here is an example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">permissions</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">password</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">UserType</span> <span class="k">=</span> <span class="n">deriveObjectType</span><span class="o">[</span><span class="kt">MyCtx</span>, <span class="kt">User</span><span class="o">](</span>
  <span class="nc">ObjectTypeName</span><span class="o">(</span><span class="s">"AuthUser"</span><span class="o">),</span>
  <span class="nc">ObjectTypeDescription</span><span class="o">(</span><span class="s">"A user of the system."</span><span class="o">),</span>
  <span class="nc">RenameField</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="s">"identifier"</span><span class="o">),</span>
  <span class="nc">DocumentField</span><span class="o">(</span><span class="s">"permissions"</span><span class="o">,</span> <span class="s">"User permissions"</span><span class="o">,</span>
    <span class="n">deprecationReason</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="s">"Will not be exposed in future"</span><span class="o">)),</span>
  <span class="nc">ExcludeFields</span><span class="o">(</span><span class="s">"password"</span><span class="o">),</span>
  <span class="nc">AddFields</span><span class="o">(</span>
    <span class="nc">Field</span><span class="o">(</span><span class="s">"reverse_name"</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">name</span><span class="o">.</span><span class="py">reverse</span><span class="o">)</span>
 <span class="err"> </span><span class="o">))</span>
</code></pre></div></div>

<p>It will generate an <code class="language-plaintext highlighter-rouge">ObjectType</code> which is equivalent to this one:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ObjectType</span><span class="o">(</span><span class="s">"AuthUser"</span><span class="o">,</span> <span class="s">"A user of the system."</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="kt">MyCtx</span>, <span class="kt">User</span><span class="o">](</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"identifier"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">id</span><span class="o">),</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"permissions"</span><span class="o">,</span> <span class="nc">ListType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">),</span>
    <span class="n">description</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="s">"User permissions"</span><span class="o">),</span>
    <span class="n">deprecationReason</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="s">"Will not be exposed in future"</span><span class="o">),</span>
    <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">permissions</span><span class="o">),</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"reverse_name"</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">name</span><span class="o">.</span><span class="py">reverse</span><span class="o">)))</span>
</code></pre></div></div>

<h4 id="deriving-methods-with-arguments">Deriving Methods with Arguments</h4>

<p>You can also use class methods as GraphQL fields. This will also correctly generate appropriate <code class="language-plaintext highlighter-rouge">Argument</code>s.</p>

<p>Let’s look at the example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">firstName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">lastName</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>

<span class="k">trait</span> <span class="nc">Mutation</span> <span class="o">{</span>
  <span class="nd">@GraphQLField</span>
  <span class="k">def</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">firstName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">lastName</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">user</span> <span class="k">=</span> <span class="nc">User</span><span class="o">(</span><span class="n">firstName</span><span class="o">,</span> <span class="n">lastName</span><span class="o">)</span>

    <span class="nf">add</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>
    <span class="n">user</span>
  <span class="o">}</span>

  <span class="c1">// ...</span>
<span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">MyCtx</span><span class="o">(</span><span class="n">mutation</span><span class="k">:</span> <span class="kt">Mutation</span><span class="o">)</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">UserType</span> <span class="k">=</span> <span class="n">deriveObjectType</span><span class="o">[</span><span class="kt">MyCtx</span>, <span class="kt">User</span><span class="o">]()</span>
<span class="k">val</span> <span class="nv">MutationType</span> <span class="k">=</span> <span class="n">deriveContextObjectType</span><span class="o">[</span><span class="kt">MyCtx</span>, <span class="kt">Mutation</span>, <span class="kt">Unit</span><span class="o">](</span><span class="nv">_</span><span class="o">.</span><span class="py">mutation</span><span class="o">)</span>
</code></pre></div></div>

<p>Resulting mutation type would be equivalent to this one:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">FirstNameArg</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"firstName"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">LastNameArg</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"lastName"</span><span class="o">,</span> <span class="nc">OptionInputType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">))</span>

<span class="k">val</span> <span class="nv">MutationType</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">(</span><span class="s">"Mutation"</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="kt">MyCtx</span>, <span class="kt">Unit</span><span class="o">](</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"addUser"</span><span class="o">,</span> <span class="nc">UserType</span><span class="o">,</span>
    <span class="n">arguments</span> <span class="k">=</span> <span class="nc">FirstNameArg</span> <span class="o">::</span> <span class="nc">LastNameArg</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
    <span class="n">resolve</span> <span class="k">=</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="nv">c</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">mutation</span><span class="o">.</span><span class="py">addUser</span><span class="o">(</span>
      <span class="nv">c</span><span class="o">.</span><span class="py">arg</span><span class="o">(</span><span class="nc">FirstNameArg</span><span class="o">),</span> <span class="nv">c</span><span class="o">.</span><span class="py">arg</span><span class="o">(</span><span class="nc">LastNameArg</span><span class="o">)))))</span>
</code></pre></div></div>

<p>You can also define a method argument of type <code class="language-plaintext highlighter-rouge">Context[Ctx, Val]</code> - it will not be treated as an argument, but instead a field execution context would be provided to a method in this argument.</p>

<p>Default values of method arguments would be ignored. If you would like to provide a default value to an <code class="language-plaintext highlighter-rouge">Argument</code>, please use <code class="language-plaintext highlighter-rouge">@GraphQLDefault</code> instead.</p>

<p>Instead of using the <code class="language-plaintext highlighter-rouge">@GraphQLField</code> annotation, you can also provide the <code class="language-plaintext highlighter-rouge">IncludeMethods</code> setting as an argument to the macro.</p>

<h3 id="inputobjecttype-derivation">InputObjectType Derivation</h3>

<p><code class="language-plaintext highlighter-rouge">deriveInputObjectType</code> supports only case classes. Here is an example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">permissions</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">password</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">UserType</span> <span class="k">=</span> <span class="n">deriveInputObjectType</span><span class="o">[</span><span class="kt">User</span><span class="o">](</span>
  <span class="nc">InputObjectTypeName</span><span class="o">(</span><span class="s">"AuthUser"</span><span class="o">),</span>
  <span class="nc">InputObjectTypeDescription</span><span class="o">(</span><span class="s">"A user of the system."</span><span class="o">),</span>
  <span class="nc">DocumentInputField</span><span class="o">(</span><span class="s">"permissions"</span><span class="o">,</span> <span class="s">"User permissions"</span><span class="o">),</span>
  <span class="nc">RenameInputField</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="s">"identifier"</span><span class="o">),</span>
  <span class="nc">ExcludeInputFields</span><span class="o">(</span><span class="s">"password"</span><span class="o">))</span>
</code></pre></div></div>

<p>It will generate an <code class="language-plaintext highlighter-rouge">InputObjectType</code> which is equivalent to this one:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">InputObjectType</span><span class="o">[</span><span class="kt">User</span><span class="o">](</span><span class="s">"AuthUser"</span><span class="o">,</span> <span class="s">"A user of the system."</span><span class="o">,</span> <span class="nc">List</span><span class="o">(</span>
  <span class="nc">InputField</span><span class="o">(</span><span class="s">"identifier"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">),</span>
  <span class="nc">InputField</span><span class="o">(</span><span class="s">"permissions"</span><span class="o">,</span> <span class="nc">ListInputType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">),</span>
    <span class="n">description</span> <span class="k">=</span> <span class="s">"User permissions"</span><span class="o">)))</span>
</code></pre></div></div>

<p>You can use <code class="language-plaintext highlighter-rouge">@GraphQLDefault</code> as well as normal Scala default values to provide a default value for an <code class="language-plaintext highlighter-rouge">InputField</code>.
The <code class="language-plaintext highlighter-rouge">@GraphQLDefault</code> annotation will be used as a default of both are defined.</p>

<h3 id="enumtype-derivation">EnumType Derivation</h3>

<p><code class="language-plaintext highlighter-rouge">deriveEnumType</code> supports Scala <code class="language-plaintext highlighter-rouge">Enumeration</code> as well as sealed hierarchies of case objects.</p>

<p>First let’s look at <code class="language-plaintext highlighter-rouge">Enumeration</code> example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Color</span> <span class="k">extends</span> <span class="nc">Enumeration</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">Red</span><span class="o">,</span> <span class="nc">LightGreen</span><span class="o">,</span> <span class="nc">DarkBlue</span> <span class="k">=</span> <span class="nc">Value</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">ColorType</span> <span class="k">=</span> <span class="n">deriveEnumType</span><span class="o">[</span><span class="kt">Color.Value</span><span class="o">](</span>
  <span class="nc">IncludeValues</span><span class="o">(</span><span class="s">"Red"</span><span class="o">,</span> <span class="s">"DarkBlue"</span><span class="o">))</span>
</code></pre></div></div>

<p>It will generate an <code class="language-plaintext highlighter-rouge">EnumType</code> which is equivalent to this one:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">EnumType</span><span class="o">(</span><span class="s">"Color"</span><span class="o">,</span> <span class="n">values</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
  <span class="nc">EnumValue</span><span class="o">(</span><span class="s">"Red"</span><span class="o">,</span> <span class="n">value</span> <span class="k">=</span> <span class="nv">Color</span><span class="o">.</span><span class="py">Red</span><span class="o">),</span>
  <span class="nc">EnumValue</span><span class="o">(</span><span class="s">"DarkBlue"</span><span class="o">,</span> <span class="n">value</span> <span class="k">=</span> <span class="nv">Color</span><span class="o">.</span><span class="py">DarkBlue</span><span class="o">)))</span>
</code></pre></div></div>

<p>And here is an example of sealed hierarchy of case objects:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Fruit</span>

<span class="k">case</span> <span class="k">object</span> <span class="nc">RedApple</span> <span class="k">extends</span> <span class="nc">Fruit</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">SuperBanana</span> <span class="k">extends</span> <span class="nc">Fruit</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">MegaOrange</span> <span class="k">extends</span> <span class="nc">Fruit</span>

<span class="k">sealed</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">ExoticFruit</span><span class="o">(</span><span class="k">val</span> <span class="nv">score</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Fruit</span>

<span class="k">case</span> <span class="k">object</span> <span class="nc">Guave</span> <span class="k">extends</span> <span class="nc">ExoticFruit</span><span class="o">(</span><span class="mi">123</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">FruitType</span> <span class="k">=</span> <span class="n">deriveEnumType</span><span class="o">[</span><span class="kt">Fruit</span><span class="o">](</span>
  <span class="nc">EnumTypeName</span><span class="o">(</span><span class="s">"Foo"</span><span class="o">),</span>
  <span class="nc">EnumTypeDescription</span><span class="o">(</span><span class="s">"It's foo"</span><span class="o">))</span>
</code></pre></div></div>

<p>It will generate an <code class="language-plaintext highlighter-rouge">EnumType</code> which is equivalent to this one:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">EnumType</span><span class="o">(</span><span class="s">"Foo"</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">"It's foo"</span><span class="o">),</span> <span class="nc">List</span><span class="o">(</span>
  <span class="nc">EnumValue</span><span class="o">(</span><span class="s">"RedApple"</span><span class="o">,</span> <span class="n">value</span> <span class="k">=</span> <span class="nc">RedApple</span><span class="o">),</span>
  <span class="nc">EnumValue</span><span class="o">(</span><span class="s">"SuperBanana"</span><span class="o">,</span> <span class="n">value</span> <span class="k">=</span> <span class="nc">SuperBanana</span><span class="o">),</span>
  <span class="nc">EnumValue</span><span class="o">(</span><span class="s">"MegaOrange"</span><span class="o">,</span> <span class="n">value</span> <span class="k">=</span> <span class="nc">MegaOrange</span><span class="o">),</span>
  <span class="nc">EnumValue</span><span class="o">(</span><span class="s">"Guave"</span><span class="o">,</span> <span class="n">value</span> <span class="k">=</span> <span class="nc">Guave</span><span class="o">)))</span>
</code></pre></div></div>

<div class="bs-callout bs-callout-info"><h4>Co-locate deriveEnumType with actual sealed trait</h4><p>
It is important to use <code class="language-plaintext highlighter-rouge">deriveEnumType</code> in the <strong>same source file</strong> where you have defined your sealed trait <strong>after</strong> all trait children are defined!
Otherwise macro will not be able to find all of the enum values.
</p></div>

<h3 id="dealing-with-recursive-types">Dealing With Recursive Types</h3>

<p>Sometimes you need to model recursive and interdependent types. The macro needs a little bit of help: you must replace fields that use recursive types and define them manually.</p>

<p>Here is an example of an <code class="language-plaintext highlighter-rouge">ObjectType</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">A</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">B</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">B</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">a</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">B</span><span class="o">)</span>

<span class="k">implicit</span> <span class="k">lazy</span> <span class="k">val</span> <span class="nv">AType</span> <span class="k">=</span> <span class="n">deriveObjectType</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">A</span><span class="o">](</span>
  <span class="nc">ReplaceField</span><span class="o">(</span><span class="s">"b"</span><span class="o">,</span> <span class="nc">Field</span><span class="o">(</span><span class="s">"b"</span><span class="o">,</span> <span class="nc">BType</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">b</span><span class="o">)))</span>

<span class="k">implicit</span> <span class="k">lazy</span> <span class="k">val</span> <span class="nv">BType</span><span class="k">:</span> <span class="kt">ObjectType</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="nf">deriveObjectType</span><span class="o">(</span>
  <span class="nc">ReplaceField</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="nc">Field</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="nc">AType</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">a</span><span class="o">)),</span>
  <span class="nc">ReplaceField</span><span class="o">(</span><span class="s">"b"</span><span class="o">,</span> <span class="nc">Field</span><span class="o">(</span><span class="s">"b"</span><span class="o">,</span> <span class="nc">BType</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">b</span><span class="o">)))</span>
</code></pre></div></div>

<p>An example of <code class="language-plaintext highlighter-rouge">InputObjectType</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">A</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">B</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">a</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span>

<span class="k">implicit</span> <span class="k">lazy</span> <span class="k">val</span> <span class="nv">AType</span><span class="k">:</span> <span class="kt">InputObjectType</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">deriveInputObjectType</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span>
  <span class="nc">ReplaceInputField</span><span class="o">(</span><span class="s">"b"</span><span class="o">,</span> <span class="nc">InputField</span><span class="o">(</span><span class="s">"b"</span><span class="o">,</span> <span class="nc">OptionInputType</span><span class="o">(</span><span class="nc">BType</span><span class="o">))))</span>

<span class="k">implicit</span> <span class="k">lazy</span> <span class="k">val</span> <span class="nv">BType</span><span class="k">:</span> <span class="kt">InputObjectType</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="n">deriveInputObjectType</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span>
  <span class="nc">ReplaceInputField</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="nc">InputField</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="nc">AType</span><span class="o">)),</span>
  <span class="nc">ReplaceInputField</span><span class="o">(</span><span class="s">"b"</span><span class="o">,</span> <span class="nc">InputField</span><span class="o">(</span><span class="s">"b"</span><span class="o">,</span> <span class="nc">OptionInputType</span><span class="o">(</span><span class="nc">BType</span><span class="o">))))</span>
</code></pre></div></div>

<h3 id="customizing-types-with-annotations">Customizing Types With Annotations</h3>

<p>You can use the following annotations to change different aspects of the resulting GraphQL types:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">@GraphQLName</code> - use a different name for a type, field, enum value or an argument</li>
  <li><code class="language-plaintext highlighter-rouge">@GraphQLDescription</code> - provide a description for a type, field, enum value or an argument</li>
  <li><code class="language-plaintext highlighter-rouge">@GraphQLDeprecated</code> - deprecate an <code class="language-plaintext highlighter-rouge">ObjectType</code> field or an enum value</li>
  <li><code class="language-plaintext highlighter-rouge">@GraphQLFieldTags</code> - provide field tags or an <code class="language-plaintext highlighter-rouge">ObjectType</code> field</li>
  <li><code class="language-plaintext highlighter-rouge">@GraphQLExclude</code> - exclude a field, enum value or an argument</li>
  <li><code class="language-plaintext highlighter-rouge">@GraphQLField</code> - include a member of a class (<code class="language-plaintext highlighter-rouge">val</code> or <code class="language-plaintext highlighter-rouge">def</code>) in the resulting <code class="language-plaintext highlighter-rouge">ObjectType</code>. This will also create the appropriate <code class="language-plaintext highlighter-rouge">Argument</code> list if the method takes some arguments</li>
  <li><code class="language-plaintext highlighter-rouge">@GraphQLDefault</code> - provide a default value for an <code class="language-plaintext highlighter-rouge">InputField</code> or an <code class="language-plaintext highlighter-rouge">Argument</code></li>
</ul>

<p>Here is an example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@GraphQLName</span><span class="o">(</span><span class="s">"AuthUser"</span><span class="o">)</span>
<span class="nd">@GraphQLDescription</span><span class="o">(</span><span class="s">"A user of the system."</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span>
  <span class="nd">@GraphQLDescription</span><span class="o">(</span><span class="s">"User ID."</span><span class="o">)</span>
  <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>

  <span class="nd">@GraphQLName</span><span class="o">(</span><span class="s">"userPermissions"</span><span class="o">)</span>
  <span class="nd">@GraphQLDeprecated</span><span class="o">(</span><span class="s">"Will not be exposed in future"</span><span class="o">)</span>
  <span class="n">permissions</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span>

  <span class="nd">@GraphQLExclude</span>
  <span class="n">password</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">UserType</span> <span class="k">=</span> <span class="n">deriveObjectType</span><span class="o">[</span><span class="kt">MyCtx</span>, <span class="kt">User</span><span class="o">]()</span>
<span class="k">val</span> <span class="nv">UserInputType</span> <span class="k">=</span> <span class="n">deriveInputObjectType</span><span class="o">[</span><span class="kt">User</span><span class="o">](</span>
  <span class="nc">InputObjectTypeName</span><span class="o">(</span><span class="s">"UserInput"</span><span class="o">))</span>
</code></pre></div></div>

<p>As you can see, <code class="language-plaintext highlighter-rouge">InputObjectTypeName</code> is also used in this case. Macro settings always take precedence over the annotations.</p>

<h2 id="schema-materialization">Schema Materialization</h2>

<p>If you have an introspection result (coming from remote server, for instance) or an SDL-based schema definition, then you can create an executable in-memory schema representation out of it.</p>

<h3 id="based-on-introspection">Based on introspection</h3>

<p>If you already got a full introspection result from a server, you can recreate an in-memory representation of the schema with <code class="language-plaintext highlighter-rouge">IntrospectionSchemaMaterializer</code>. This feature has a lot of potential for client-side tools: testing, mocking, creating proxy/facade GraphQL servers, etc.</p>

<p>Here is a simple example of how you can use this feature (using circe in this particular example):</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">io.circe._</span>
<span class="k">import</span> <span class="nn">sangria.marshalling.circe._</span>

<span class="k">val</span> <span class="nv">introspectionResults</span><span class="k">:</span> <span class="kt">Json</span> <span class="o">=</span> <span class="o">???</span> <span class="c1">// coming from other server or file</span>
<span class="k">val</span> <span class="nv">clientSchema</span><span class="k">:</span> <span class="kt">Schema</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Any</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">Schema</span><span class="o">.</span><span class="py">buildFromIntrospection</span><span class="o">(</span><span class="n">introspectionResults</span><span class="o">)</span>
</code></pre></div></div>

<p>It takes the result of a full introspection query (loaded from the server, file, etc.) and recreates the schema definition with stubs for
resolve methods. You can customize a lot of aspects of the materialization by providing a custom <code class="language-plaintext highlighter-rouge">IntrospectionSchemaBuilder</code>
implementation (you can also extend <code class="language-plaintext highlighter-rouge">DefaultIntrospectionSchemaBuilder</code> class). This means that you can, for instance, plug in some
generic field resolution logic or provide generic logic for custom scalars. Without these customizations, the materialized schema would
only be able to execute introspection queries.</p>

<h3 id="based-on-sdl-definitions">Based on SDL definitions</h3>

<p>In addition to normal query syntax, GraphQL allows you to define the schema itself. This is how the syntax look like:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Character</span> <span class="p">{</span>
  <span class="nl">id</span><span class="p">:</span> <span class="nx">Int</span><span class="o">!</span>
  <span class="nx">name</span><span class="p">:</span> <span class="nb">String</span><span class="o">!</span>
<span class="p">}</span>

<span class="dl">"""</span><span class="s2">
The human character
</span><span class="dl">"""</span>
<span class="nx">type</span> <span class="nx">Human</span> <span class="kr">implements</span> <span class="nx">Character</span> <span class="p">{</span>
  <span class="nl">id</span><span class="p">:</span> <span class="nx">Int</span><span class="o">!</span>
  <span class="nx">name</span><span class="p">:</span> <span class="nb">String</span><span class="o">!</span>
  <span class="nx">height</span><span class="p">:</span> <span class="nx">Float</span>
<span class="p">}</span>

<span class="dl">"""</span><span class="s2">
The root query type
</span><span class="dl">"""</span>
<span class="nx">type</span> <span class="nx">Query</span> <span class="p">{</span>
  <span class="dl">"</span><span class="s2">The main hero or the saga</span><span class="dl">"</span>
  <span class="nx">hero</span><span class="p">:</span> <span class="nx">Character</span>
<span class="p">}</span>

<span class="nx">schema</span> <span class="p">{</span>
  <span class="nl">query</span><span class="p">:</span> <span class="nx">Query</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You can recreate an in-memory representation of the schema with <code class="language-plaintext highlighter-rouge">AstSchemaMaterializer</code> (just like with the introspection-based one).
This feature has a lot of potential for client-side tools: testing, mocking, creating proxy/facade GraphQL servers, etc.</p>

<p>Here is a simple example of how you can use this feature:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">ast</span> <span class="k">=</span>
  <span class="n">graphql</span><span class="s">"""
    schema {
      query: Hello
    }

    type Hello {
      bar: Bar
    }

    type Bar {
      isColor: Boolean
    }
  """</span>

<span class="k">val</span> <span class="nv">clientSchema</span><span class="k">:</span> <span class="kt">Schema</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Any</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">Schema</span><span class="o">.</span><span class="py">buildFromAst</span><span class="o">(</span><span class="n">ast</span><span class="o">)</span>
</code></pre></div></div>

<p>It takes a schema AST (in this example the <code class="language-plaintext highlighter-rouge">graphql</code> macro is used, but you can also use <code class="language-plaintext highlighter-rouge">QueryParser.parse</code> to parse the schema dynamically)
and recreates the schema definition with stubs for resolve methods. You can customize a lot of aspects of the materialization by providing a
custom <code class="language-plaintext highlighter-rouge">AstSchemaBuilder</code> implementation (you can also extend <code class="language-plaintext highlighter-rouge">DefaultAstSchemaBuilder</code> class). This means that you can, for instance,
plug in some generic field resolution logic or provide generic logic for custom scalars. Without these customizations, the materialized
schema would only be able to execute introspection queries.</p>

<h3 id="high-level-sdl-based-schema-builder">High-level SDL-based Schema Builder</h3>

<p><code class="language-plaintext highlighter-rouge">AstSchemaBuilder</code> and <code class="language-plaintext highlighter-rouge">DefaultAstSchemaBuilder</code> provide a lot of flexibility in how you build the schema based on the SDL AST, but the are
also quite low-level API and hard to work with directly. Sangria provides more higher-level API that is based on <code class="language-plaintext highlighter-rouge">resolve</code> functions that are
defined in the scope of the whole schema based on the directives and other SDL elements. <code class="language-plaintext highlighter-rouge">ResolverBasedAstSchemaBuilder</code> or <code class="language-plaintext highlighter-rouge">AstSchemaBuilder.resolverBased</code>
allow you to do this. They take a list of <code class="language-plaintext highlighter-rouge">AstSchemaResolver</code>s as an argument. Each resolver might contribute specific logic in the generated schema.</p>

<p>Let’s look a the simple example that primarily uses JSON as a data type (quite typical for GraphQL API that aggregates other JSON API).
The schema definition looks like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">schemaAst</span> <span class="k">=</span>
  <span class="n">gql</span><span class="s">"""
    enum Color {
      Red, Green, Blue
    }

    interface Fruit {
      id: ID!
    }

    type Apple implements Fruit {
      id: ID!
      color: Color
    }

    type Banana implements Fruit {
      id: ID!
      length: Int
    }

    type Query @addSpecial {
      fruit: Fruit
      bananas: [Fruit] @generateBananas(count: 3)
    }
  """</span>
</code></pre></div></div>

<p>It contains several interesting elements which we need to implement in the schema builder:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Fruit</code> is an interface type, so we need to properly define an instance check in order to select appropriate <code class="language-plaintext highlighter-rouge">ObjectType</code>
based on the <code class="language-plaintext highlighter-rouge">type</code> JSON field (in this example)</li>
  <li><code class="language-plaintext highlighter-rouge">@generateBananas</code> directive defines the resolution logic for <code class="language-plaintext highlighter-rouge">bananas</code> field. We need to define a resolver for it and generate
a simple list with size <code class="language-plaintext highlighter-rouge">count</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">@addSpecial</code> directive needs to add new field in the <code class="language-plaintext highlighter-rouge">Query</code> type.</li>
  <li>For all other fields in the schema we need to define default behavior that just transforms context JSON value in appropriate
GraphQL representation.</li>
</ol>

<p>Given all these requirements, we can defined a schema builder like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">CountArg</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"count"</span><span class="o">,</span> <span class="nc">IntType</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">GenerateBananasDir</span> <span class="k">=</span> <span class="nc">Directive</span><span class="o">(</span><span class="s">"generateBananas"</span><span class="o">,</span>
  <span class="n">arguments</span> <span class="k">=</span> <span class="nc">CountArg</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
  <span class="n">locations</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="nv">DL</span><span class="o">.</span><span class="py">FieldDefinition</span><span class="o">))</span>

<span class="k">val</span> <span class="nv">AddSpecialDir</span> <span class="k">=</span> <span class="nc">Directive</span><span class="o">(</span><span class="s">"addSpecial"</span><span class="o">,</span>
  <span class="n">locations</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="nv">DL</span><span class="o">.</span><span class="py">Object</span><span class="o">))</span>

<span class="k">val</span> <span class="nv">builder</span> <span class="k">=</span> <span class="nv">AstSchemaBuilder</span><span class="o">.</span><span class="py">resolverBased</span><span class="o">[</span><span class="kt">Unit</span><span class="o">](</span>
  <span class="c1">// Requirement #1 - provides appropriate instance check based on the `type` JSON field</span>
  <span class="nv">InstanceCheck</span><span class="o">.</span><span class="py">field</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">JsValue</span><span class="o">],</span>

  <span class="c1">// Requirement #2 - defined a resolution logic based on the `@generateBananas` directive</span>
  <span class="nc">DirectiveResolver</span><span class="o">(</span><span class="nc">GenerateBananasDir</span><span class="o">,</span> <span class="n">c</span> <span class="k">=&gt;</span>
    <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="nv">c</span><span class="o">.</span><span class="py">arg</span><span class="o">(</span><span class="nc">CountArg</span><span class="o">))</span> <span class="nf">map</span> <span class="o">(</span><span class="n">id</span> <span class="k">=&gt;</span> <span class="nc">JsObject</span><span class="o">(</span>
      <span class="s">"type"</span> <span class="o">-&gt;</span> <span class="nc">JsString</span><span class="o">(</span><span class="s">"Banana"</span><span class="o">),</span>
      <span class="s">"id"</span> <span class="o">-&gt;</span> <span class="nc">JsString</span><span class="o">(</span><span class="nv">id</span><span class="o">.</span><span class="py">toString</span><span class="o">),</span>
      <span class="s">"length"</span> <span class="o">-&gt;</span> <span class="nc">JsNumber</span><span class="o">(</span><span class="n">id</span> <span class="o">*</span> <span class="mi">10</span><span class="o">)))),</span>

  <span class="c1">// Requirement #3 - add extra field based on the `@addSpecial` directive</span>
  <span class="nc">DirectiveFieldProvider</span><span class="o">(</span><span class="nc">AddSpecialDir</span><span class="o">,</span> <span class="n">c</span> <span class="k">=&gt;</span>
    <span class="nc">MaterializedField</span><span class="o">(</span><span class="nc">StandaloneOrigin</span><span class="o">,</span>
      <span class="nc">Field</span><span class="o">(</span><span class="s">"specialFruit"</span><span class="o">,</span> <span class="nv">c</span><span class="o">.</span><span class="py">objectType</span><span class="o">(</span><span class="s">"Banana"</span><span class="o">),</span> <span class="n">resolve</span> <span class="k">=</span>
        <span class="nv">ResolverBasedAstSchemaBuilder</span><span class="o">.</span><span class="py">extractFieldValue</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">JsValue</span><span class="o">]))</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">),</span>

  <span class="c1">// Requirement #4 - provides default behaviour for all other fields</span>
  <span class="nv">FieldResolver</span><span class="o">.</span><span class="py">defaultInput</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">JsValue</span><span class="o">])</span>
</code></pre></div></div>

<p>Now that we have the schema builder, we can define the schema itself:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">schema</span> <span class="k">=</span> <span class="nv">Schema</span><span class="o">.</span><span class="py">buildFromAst</span><span class="o">(</span><span class="n">schemaAst</span><span class="o">,</span>
  <span class="nv">builder</span><span class="o">.</span><span class="py">validateSchemaWithException</span><span class="o">(</span><span class="n">schemaAst</span><span class="o">))</span>
</code></pre></div></div>

<p>Here we are also using <code class="language-plaintext highlighter-rouge">builder.validateSchemaWithException</code> to validate the AST and ensure that all directives are known and correct (
<code class="language-plaintext highlighter-rouge">builder.validateSchema</code> will just return a list of violations).</p>

<p>Now we are ready to execute the schema against a query and provide it with initial root JSON value:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">query</span> <span class="k">=</span>
  <span class="n">gql</span><span class="s">"""
    {
      fruit {
        id

        ... on Apple {color}
        ... on Banana {length}
      }

      bananas {
        ... on Banana {length}
      }

      specialFruit {id}
    }
  """</span>

<span class="k">val</span> <span class="nv">initialData</span> <span class="k">=</span>
  <span class="s">"""
    {
      "fruit": {
        "type": "Apple",
        "id": "1",
        "color": "Red"
      },
      "specialFruit": {
        "type": "Apple",
        "id": "42",
        "color": "Blue"
      }
    }
  """</span><span class="o">.</span><span class="py">parseJson</span>

<span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="n">root</span> <span class="k">=</span> <span class="n">initialData</span><span class="o">)</span>
</code></pre></div></div>

<p>The result of an execution would be JSON like this one:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"fruit"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Red"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"bananas"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nl">"length"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"length"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"length"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="p">}],</span><span class="w">
    </span><span class="nl">"specialFruit"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"42"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ResolverBasedAstSchemaBuilder</code> provides a lot of features. All supported resolvers are subtypes of <code class="language-plaintext highlighter-rouge">AstSchemaResolver</code>, so you can check
these if you would like to learn about other features, like providing additional types with <code class="language-plaintext highlighter-rouge">AdditionalTypes</code>, handling scalar values with
<code class="language-plaintext highlighter-rouge">ScalarResolver</code>, etc.</p>

<p>Sometimes it might be very useful to analyze the schema AST document in order to collect information about some of the used directives in advance (before building the schema).
This can be achieved with <code class="language-plaintext highlighter-rouge">ResolverBasedAstSchemaBuilder.resolveDirectives</code>. Here is a small example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">ValueArg</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"value"</span><span class="o">,</span> <span class="nc">IntType</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">NumDir</span> <span class="k">=</span> <span class="nc">Directive</span><span class="o">(</span><span class="s">"num"</span><span class="o">,</span>
  <span class="n">arguments</span> <span class="k">=</span> <span class="nc">ValueArg</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
  <span class="n">locations</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="nv">DirectiveLocation</span><span class="o">.</span><span class="py">Schema</span><span class="o">,</span> <span class="nv">DirectiveLocation</span><span class="o">.</span><span class="py">Object</span><span class="o">))</span>

<span class="k">val</span> <span class="nv">collectedValue</span> <span class="k">=</span> <span class="nv">schemaAst</span><span class="o">.</span><span class="py">analyzer</span><span class="o">.</span><span class="py">resolveDirectives</span><span class="o">(</span>
  <span class="nc">GenericDirectiveResolver</span><span class="o">(</span><span class="nc">NumDir</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">c</span> <span class="n">arg</span> <span class="nc">ValueArg</span><span class="o">))).</span><span class="py">sum</span>
</code></pre></div></div>

<p>In this example, the resulting <code class="language-plaintext highlighter-rouge">collectedValue</code> will contain the sum of all numbers collected via <code class="language-plaintext highlighter-rouge">@num</code> directive.</p>

<p>For another example of SDL-based schema materialization, please see the next section. I would also recommend to look at
<a href="https://github.com/OlegIlyenko/graphql-toolbox/blob/master/app/controllers/Materializer.scala">Materializer class</a> in
<a href="https://github.com/OlegIlyenko/graphql-toolbox">graphql-toolbox project</a>. It contains much bigger and more comprehensive example.</p>

<p>If you have previously worked with <a href="https://github.com/apollographql/graphql-tools">apollo-tools</a> and would like to know how SDL-based schema definition translates to sangria, then
<code class="language-plaintext highlighter-rouge">ResolverBasedAstSchemaBuilder</code> is a good place to start. Some apollo-tools examples use exact type/field name matches in order to define the
resolve functions. You can achieve the same in sangria by using <code class="language-plaintext highlighter-rouge">FieldResolver</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">builder</span> <span class="k">=</span> <span class="n">resolverBased</span><span class="o">[</span><span class="kt">Any</span><span class="o">](</span>
  <span class="nv">FieldResolver</span><span class="o">.</span><span class="py">map</span><span class="o">(</span>
    <span class="s">"Query"</span> <span class="o">-&gt;</span> <span class="nc">Map</span><span class="o">(</span>
      <span class="s">"posts"</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="o">...)),</span>
    <span class="s">"Mutation"</span> <span class="o">-&gt;</span> <span class="nc">Map</span><span class="o">(</span>
      <span class="s">"upvotePost"</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="o">...)),</span>
    <span class="s">"Post"</span> <span class="o">-&gt;</span> <span class="nc">Map</span><span class="o">(</span>
      <span class="s">"author"</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="o">...),</span>
      <span class="s">"comments"</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="o">...))),</span>
  <span class="nv">AnyFieldResolver</span><span class="o">.</span><span class="py">defaultInput</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">JsValue</span><span class="o">])</span>
</code></pre></div></div>

<p>Though general recommendation is to use <code class="language-plaintext highlighter-rouge">DirectiveResolver</code> instead of explicit <code class="language-plaintext highlighter-rouge">FieldResolver</code> if possible, since it provides more robust
mechanism to define the resolution logic.</p>

<h3 id="schema-materialization-example">Schema Materialization Example</h3>

<p>Schema materialization can be overwhelming at first, so let’s go though a small example that combines static schema defined with scala code and
dynamic SDL-based schema extensions.</p>

<p>First we need to define some model classes and repository that we will use in this example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Article</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">title</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">text</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">author</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>

<span class="k">class</span> <span class="nc">Repo</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">loadArticle</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Article</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Some</span><span class="o">(</span><span class="nc">Article</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">s</span><span class="s">"Test Article #$id"</span><span class="o">,</span> <span class="s">"blah blah blah..."</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">"Bob"</span><span class="o">)))</span>

  <span class="k">def</span> <span class="nf">loadComments</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">List</span><span class="o">(</span><span class="nc">JsObject</span><span class="o">(</span>
      <span class="s">"text"</span> <span class="o">-&gt;</span> <span class="nc">JsString</span><span class="o">(</span><span class="s">"First!"</span><span class="o">),</span>
      <span class="s">"author"</span> <span class="o">-&gt;</span> <span class="nc">JsObject</span><span class="o">(</span>
        <span class="s">"name"</span> <span class="o">-&gt;</span> <span class="nc">JsString</span><span class="o">(</span><span class="s">"Jane"</span><span class="o">),</span>
        <span class="s">"lastComment"</span> <span class="o">-&gt;</span> <span class="nc">JsObject</span><span class="o">(</span>
          <span class="s">"text"</span> <span class="o">-&gt;</span> <span class="nc">JsString</span><span class="o">(</span><span class="s">"Boring..."</span><span class="o">)))))</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In order to demonstrate different approaches, we represent <code class="language-plaintext highlighter-rouge">Article</code> as a case class and <code class="language-plaintext highlighter-rouge">comments</code> as a JSON
value (using spray-json in this example).</p>

<p>Now let’s define static part of the schema:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">ArticleType</span> <span class="k">=</span> <span class="n">deriveObjectType</span><span class="o">[</span><span class="kt">Repo</span>, <span class="kt">Article</span><span class="o">]()</span>

<span class="k">val</span> <span class="nv">IdArg</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">QueryType</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">(</span><span class="s">"Query"</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="kt">Repo</span>, <span class="kt">Unit</span><span class="o">](</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"article"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ArticleType</span><span class="o">),</span>
    <span class="n">arguments</span> <span class="k">=</span> <span class="nc">IdArg</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
    <span class="n">resolve</span> <span class="k">=</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="nv">c</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">loadArticle</span><span class="o">(</span><span class="n">c</span> <span class="n">arg</span> <span class="nc">IdArg</span><span class="o">))))</span>

<span class="k">val</span> <span class="nv">staticSchema</span> <span class="k">=</span> <span class="nc">Schema</span><span class="o">(</span><span class="nc">QueryType</span><span class="o">)</span>
</code></pre></div></div>

<p>Nothing special going on here - just a standard schema definition. It becomes more interesting when we add schema extentions into the mix:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">extensions</span> <span class="k">=</span>
  <span class="n">gql</span><span class="s">"""
    extend type Article {
      comments: [Comment]! @loadComments
    }

    type Comment {
      text: String!
      author: CommentAuthor!
    }

    type CommentAuthor {
      name: String!
      lastComment: Comment
    }
  """</span>

<span class="k">val</span> <span class="nv">schema</span> <span class="k">=</span> <span class="nv">staticSchema</span><span class="o">.</span><span class="py">extend</span><span class="o">(</span><span class="n">extensions</span><span class="o">,</span> <span class="n">builder</span><span class="o">)</span>
</code></pre></div></div>

<p>This code will extend an <code class="language-plaintext highlighter-rouge">Article</code> GraphQL type and add <code class="language-plaintext highlighter-rouge">comments</code> field. Also notice that <code class="language-plaintext highlighter-rouge">Comment</code> and <code class="language-plaintext highlighter-rouge">CommentAuthor</code> types
are mutually recursive. In order simplify the builder logic, we also use <code class="language-plaintext highlighter-rouge">@loadComments</code> directive. The only missing piece
of the puzzle is the <code class="language-plaintext highlighter-rouge">builder</code> itself:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">LoadCommentsDir</span> <span class="k">=</span> <span class="nc">Directive</span><span class="o">(</span><span class="s">"loadComments"</span><span class="o">,</span>
  <span class="n">locations</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="nv">DirectiveLocation</span><span class="o">.</span><span class="py">FieldDefinition</span><span class="o">))</span>

<span class="k">val</span> <span class="nv">builder</span> <span class="k">=</span> <span class="nv">AstSchemaBuilder</span><span class="o">.</span><span class="py">resolverBased</span><span class="o">[</span><span class="kt">Repo</span><span class="o">](</span>
  <span class="nc">DirectiveResolver</span><span class="o">(</span><span class="nc">LoadCommentsDir</span><span class="o">,</span> <span class="nv">_</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">loadComments</span><span class="o">),</span>
  <span class="nv">FieldResolver</span><span class="o">.</span><span class="py">defaultInput</span><span class="o">[</span><span class="kt">Repo</span>, <span class="kt">JsValue</span><span class="o">])</span>
</code></pre></div></div>

<p>As you can see, we are using <code class="language-plaintext highlighter-rouge">@loadComments</code> directive to define a special <code class="language-plaintext highlighter-rouge">resolve</code> function logic that loads all of the comments.
In general it is recommended approach to handle field logic in the builder
(an alternative would be to rely of the field/type names with <code class="language-plaintext highlighter-rouge">FieldResolver {case (TypeName("Article"), FieldName("comments")) =&gt; ...}</code> which is quite fragile).</p>

<p>All other fields are defined in terms of <code class="language-plaintext highlighter-rouge">resolveJson</code> function. It just adopts contextual value (which is JSON in our example)
to the field’s return type. This implementation is by no means complete - it just shows a short example.
For production application you would need to improve this logic according to the needs of the application.</p>

<p>Now we are ready to execute query against out new shiny schema:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">query</span> <span class="k">=</span>
  <span class="n">gql</span><span class="s">"""
    {
      article(id: "42") {
        title
        text
        comments {
          text
          author {
            name
            lastComment {
              text
            }
          }
        }
      }
    }
  """</span>

<span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Repo</span><span class="o">)</span>
</code></pre></div></div>

<p>Result of the execution would look like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"article"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Test Article #42"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"blah blah blah..."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"comments"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First!"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"author"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Jane"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"lastComment"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Boring..."</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="query-execution">Query Execution</h2>

<p>Here is an example of how you can execute example schema:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sangria.execution.Executor</span>

<span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="nv">TestSchema</span><span class="o">.</span><span class="py">StarWarsSchema</span><span class="o">,</span> <span class="n">queryAst</span><span class="o">,</span>
  <span class="n">userContext</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CharacterRepo</span><span class="o">,</span>
  <span class="n">deferredResolver</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">FriendsResolver</span><span class="o">,</span>
  <span class="n">variables</span> <span class="k">=</span> <span class="n">vars</span><span class="o">)</span>
</code></pre></div></div>

<p>The result of the execution is a <code class="language-plaintext highlighter-rouge">Future</code> of marshaled GraphQL result (see <a href="#result-marshalling-and-input-unmarshalling">Result Marshalling and Input Unmarshalling</a> section for more details)</p>

<h3 id="prepared-queries">Prepared Queries</h3>

<p>In some situations, you may need to make a static query analysis and postpone the actual execution of the query. Later on, you may need to execute this query several times. A typical example is subscription queries: you first validate and prepare a query, and then you execute it several times for every event. This is precisely what <code class="language-plaintext highlighter-rouge">PreparedQuery</code> allows you to do.</p>

<p>Let’s look at the example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">preparedQueryFuture</span> <span class="k">=</span> <span class="nv">Executor</span><span class="o">.</span><span class="py">prepare</span><span class="o">(</span><span class="nc">StarWarsSchema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span>
  <span class="k">new</span> <span class="nc">CharacterRepo</span><span class="o">,</span>
  <span class="n">deferredResolver</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">FriendsResolver</span><span class="o">)</span>

<span class="nv">preparedQueryFuture</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">preparedQuery</span> <span class="k">=&gt;</span>
  <span class="nv">preparedQuery</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">userContext</span> <span class="k">=</span> <span class="n">someCustomCtx</span><span class="o">,</span> <span class="n">root</span> <span class="k">=</span> <span class="n">event</span><span class="o">))</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Executor.prepare</code> will return you a <code class="language-plaintext highlighter-rouge">Future</code> with a prepared query which you can execute several times later, possibly providing different <code class="language-plaintext highlighter-rouge">userContext</code> or <code class="language-plaintext highlighter-rouge">root</code> values. In addition to <code class="language-plaintext highlighter-rouge">execute</code>, <code class="language-plaintext highlighter-rouge">PreparedQuery</code> also gives you a lot of information about the query itself: operation, root <code class="language-plaintext highlighter-rouge">QueryType</code>, top-level fields with arguments, etc.</p>

<h3 id="alternative-execution-scheme">Alternative Execution Scheme</h3>

<p>The <code class="language-plaintext highlighter-rouge">Future</code> of marshaled result is not the only possible result of a query execution. By importing different implementation of <code class="language-plaintext highlighter-rouge">ExecutionScheme</code> you can
change the result type of an execution. Here is an example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sangria.execution.ExecutionScheme.Extended</span>

<span class="k">val</span> <span class="nv">result</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">ExecutionResult</span><span class="o">[</span><span class="kt">Ctx</span>, <span class="kt">JsValue</span><span class="o">]]</span> <span class="k">=</span>
  <span class="k">val</span> <span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Extended</code> execution scheme gives you the result of the execution together with additional information about the execution itself (like, for instance, the list of exceptions that happened during the execution).</p>

<p>Following execution schemes are available:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Default</code> - The default one. Returns a <code class="language-plaintext highlighter-rouge">Future</code> of marshaled result</li>
  <li><code class="language-plaintext highlighter-rouge">Extended</code> - Returns a <code class="language-plaintext highlighter-rouge">Future</code> containing <code class="language-plaintext highlighter-rouge">ExecutionResult</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Stream</code> - Returns a stream of results. Very useful for subscription and batch queries, where the result is an <code class="language-plaintext highlighter-rouge">Observable</code> or a <code class="language-plaintext highlighter-rouge">Source</code></li>
  <li><code class="language-plaintext highlighter-rouge">StreamExtended</code> - Returns a stream of <code class="language-plaintext highlighter-rouge">ExecutionResult</code>s</li>
</ul>

<h3 id="batch-executor">Batch Executor</h3>

<div class="bs-callout bs-callout-info"><h4>Experimental</h4><p>
Please use this feature with caution! It might be removed in future releases or have big semantic changes. In particular in the way how variables are inferred and merged.
</p></div>

<p>Batch executor allow you to execute several inter-dependent queries and get an execution result as a stream.
Dependencies are expressed via variables and <code class="language-plaintext highlighter-rouge">@export</code> directive. It provides following features:</p>

<ul>
  <li>Allows specifying multiple <code class="language-plaintext highlighter-rouge">operationNames</code> when executing a GraphQL query document.
All operations would be executed in order inferred from the dependencies between queries.</li>
  <li>Support for <code class="language-plaintext highlighter-rouge">@export(as: "foo")</code> directive. This directive allows you to save the results of
the query execution and then use it as a variable in a different query within the same document.
This provides a way to define data dependencies between queries.</li>
  <li>When used with <code class="language-plaintext highlighter-rouge">@export</code> directive, the variables would be automatically inferred by the execution
engine, so you don’t need to declare them explicitly</li>
  <li>You still can declare variables explicitly and completely disable variable inference with <code class="language-plaintext highlighter-rouge">inferVariableDefinitions</code> flag</li>
</ul>

<p>Batch executor implementation is inspired by this talk:</p>

<div class="video">
  <iframe width="560" height="315" src="https://www.youtube.com/embed/ViXL0YQnioU?start=626&amp;end=769" frameborder="0" allowfullscreen=""></iframe>
  <div class="video-description">
    <span class="video-title">GraphQL Future at react-europe 2016</span> <span class="video-by-name"><span class="video-by">by</span> <span class="video-name">Laney Kuenzel &amp; Lee Byron </span></span>
  </div>
</div>

<p>You can use any <a href="#alternative-execution-scheme">execution scheme</a> with batch executor, but <code class="language-plaintext highlighter-rouge">Stream</code> and <code class="language-plaintext highlighter-rouge">StreamExtended</code> are recommended
since they will return execution results for all of the queries as a stream.</p>

<p>In the example below we are using monix for streaming and spray-json for data serialization. Also notice that we need to explicitly
add <code class="language-plaintext highlighter-rouge">BatchExecutor.ExportDirective</code> directive and use <code class="language-plaintext highlighter-rouge">BatchExecutor.executeBatch</code> instead of standard executor:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">monix.execution.Scheduler.Implicits.global</span>

<span class="k">import</span> <span class="nn">sangria.execution.ExecutionScheme.Stream</span>
<span class="k">import</span> <span class="nn">sangria.marshalling.sprayJson._</span>
<span class="k">import</span> <span class="nn">sangria.streaming.monix._</span>

<span class="k">val</span> <span class="nv">schema</span> <span class="k">=</span> <span class="nc">Schema</span><span class="o">(...,</span> <span class="n">directives</span> <span class="k">=</span> <span class="nc">BuiltinDirectives</span> <span class="o">:+</span> <span class="nv">BatchExecutor</span><span class="o">.</span><span class="py">ExportDirective</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">result</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">BatchExecutor</span><span class="o">.</span><span class="py">executeBatch</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span>
    <span class="n">operationNames</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">"StoryComments"</span><span class="o">,</span> <span class="s">"NewsFeed"</span><span class="o">))</span>
</code></pre></div></div>

<p>You can also use <code class="language-plaintext highlighter-rouge">BatchExecutor.OperationNameExtension</code> middleware to include an operation name in the execution results (as an extension).
This will make it easier for a client to distinguish between different execution results coming from the same response stream.</p>

<p>Here is an example of request that will execute 2 queries in batch:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">GET</span> <span class="o">/</span><span class="nx">graphql</span><span class="p">?</span><span class="nx">batchOperations</span><span class="o">=</span><span class="p">[</span><span class="nx">StoryComments</span><span class="p">,</span> <span class="nx">NewsFeed</span><span class="p">]</span>

<span class="nx">query</span> <span class="nx">NewsFeed</span> <span class="p">{</span>
  <span class="nx">feed</span> <span class="p">{</span>
    <span class="nx">stories</span> <span class="p">{</span>
      <span class="nx">id</span> <span class="p">@</span><span class="nd">export</span><span class="p">(</span><span class="k">as</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ids</span><span class="dl">"</span><span class="p">)</span>
      <span class="nx">actor</span>
      <span class="nx">message</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">query</span> <span class="nx">StoryComments</span> <span class="p">{</span>
  <span class="nx">stories</span><span class="p">(</span><span class="nx">ids</span><span class="p">:</span> <span class="nx">$ids</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">comments</span> <span class="p">{</span>
      <span class="nx">actor</span>
      <span class="nx">message</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In this example <code class="language-plaintext highlighter-rouge">NewsFeed</code> query would be executed first and all story comments would be loaded in a separate query execution step (<code class="language-plaintext highlighter-rouge">StoryComments</code>).
This allows client to load all required data with one efficient request to the server, but data would be sent back to the client in chunks.</p>

<h2 id="query-and-schema-analysis">Query And Schema Analysis</h2>

<p>Sangria provides a lot of generic tools to work with a GraphQL query and schema. Aside from the actual query execution, you may need to
do different things like analyze a query for breaking changes, introspection usage, deprecated field usage, validate query/schema without
executing it, etc. This section describes some of the tools that will help you with these tasks.</p>

<h3 id="query-validation">Query Validation</h3>

<p>Query validation consists of validation rules. You can pick and choose which rules you would like to use for a query validation. You
can even create your own validation rules and validate queries against them. The list of standard validation rules is available in <code class="language-plaintext highlighter-rouge">QueryValidator.allRules</code>.
In order to validate queries against the list of rules you need to use <code class="language-plaintext highlighter-rouge">RuleBasedQueryValidator</code>. The default query validator which uses all standard rules
is available under <code class="language-plaintext highlighter-rouge">QueryValidator.default</code>. Here is an example of how you can use it:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">violations</span> <span class="k">=</span> <span class="nv">QueryValidator</span><span class="o">.</span><span class="py">default</span><span class="o">.</span><span class="py">validateQuery</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">)</span>
</code></pre></div></div>

<p>You can also customise the list of validation rules when you are executing the query by providing a custom query validator like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="n">queryValidator</span> <span class="k">=</span> <span class="o">...)</span>
</code></pre></div></div>

<p>For instance, it can be useful to disable validation for production setup, where you have validated all possible queries upfront and would
like to save on CPU cycles during the execution.</p>

<p>Query validation can also be used for SDL validation. Let’s say we have following type definitions:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">type</span> <span class="nx">User</span> <span class="p">@</span><span class="nd">auth</span><span class="p">(</span><span class="nx">token</span><span class="p">:</span> <span class="dl">"</span><span class="s2">TEST</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
  <span class="nl">name</span><span class="p">:</span> <span class="nb">String</span>
  <span class="nx">isAdmin</span><span class="p">:</span> <span class="nb">Boolean</span> <span class="p">@</span><span class="nd">permission</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ADMIN</span><span class="dl">"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can validate it against a stub schema like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">validationSchema</span> <span class="k">=</span>
  <span class="nv">Schema</span><span class="o">.</span><span class="py">buildStubFromAst</span><span class="o">(</span>
    <span class="n">gql</span><span class="s">"""
      directive @permission(name: String) on FIELD_DEFINITION
      directive @auth(token: String!) on OBJECT
    """</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">errors</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Violation</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">QueryValidator</span><span class="o">.</span><span class="py">default</span><span class="o">.</span><span class="py">validateQuery</span><span class="o">(</span><span class="n">validationSchema</span><span class="o">,</span>
    <span class="n">gql</span><span class="s">"""
      type User @auth(token: "TEST") {
        name: String
        isAdmin: Boolean @permission(name: "ADMIN")
      }
    """</span><span class="o">)</span>
</code></pre></div></div>

<p>If we make a mistake somewhere (misplace the directive or forget to provide a directive argument):</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">errors</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Violation</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">QueryValidator</span><span class="o">.</span><span class="py">default</span><span class="o">.</span><span class="py">validateQuery</span><span class="o">(</span><span class="n">validationSchema</span><span class="o">,</span>
    <span class="n">gql</span><span class="s">"""
      type User @auth {
        name: String @auth(token: "TEST")
        isAdmin: Boolean
      }
    """</span><span class="o">)</span>
</code></pre></div></div>

<p>we will get following validation errors:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Directive</span> <span class="dl">'</span><span class="s1">auth</span><span class="dl">'</span> <span class="nx">may</span> <span class="nx">not</span> <span class="nx">be</span> <span class="nx">used</span> <span class="nx">on</span> <span class="nx">field</span> <span class="nx">definition</span><span class="p">.</span> <span class="p">(</span><span class="nx">line</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">column</span> <span class="mi">22</span><span class="p">):</span>
        <span class="nx">name</span><span class="p">:</span> <span class="nb">String</span> <span class="p">@</span><span class="nd">auth</span><span class="p">(</span><span class="nx">token</span><span class="p">:</span> <span class="dl">"</span><span class="s2">TEST</span><span class="dl">"</span><span class="p">)</span>
                     <span class="o">^</span>

<span class="nx">Field</span> <span class="dl">'</span><span class="s1">auth</span><span class="dl">'</span> <span class="nx">argument</span> <span class="dl">'</span><span class="s1">token</span><span class="dl">'</span> <span class="k">of</span> <span class="nx">type</span> <span class="dl">'</span><span class="s1">String!</span><span class="dl">'</span> <span class="nx">is</span> <span class="nx">required</span> <span class="nx">but</span> <span class="nx">not</span> <span class="nx">provided</span><span class="p">.</span> <span class="p">(</span><span class="nx">line</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">column</span> <span class="mi">17</span><span class="p">):</span>
      <span class="nx">type</span> <span class="nx">User</span> <span class="p">@</span><span class="nd">auth</span> <span class="p">{</span>
                <span class="o">^</span>
</code></pre></div></div>

<h3 id="input-document-validation">Input Document Validation</h3>

<p><code class="language-plaintext highlighter-rouge">QueryValidator</code> also able to validate <code class="language-plaintext highlighter-rouge">InputDocument</code>. Here is a small example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">schema</span> <span class="k">=</span> <span class="nv">Schema</span><span class="o">.</span><span class="py">buildStubFromAst</span><span class="o">(</span>
  <span class="n">gql</span><span class="s">"""
    enum Color {
      RED
      GREEN
      BLUE
    }

    input Foo {
      baz: Color!
    }

    input Config {
      foo: String
      bar: Int
      list: [Foo]
    }
  """</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">inp</span> <span class="k">=</span>
  <span class="n">gqlInpDoc</span><span class="s">"""
    {
      foo: "bar"
      bar: "foo"
      list: [
        {baz: RED}
        {baz: FOO_BAR}
        {test: 1}
        {}
      ]
    }

    {
      doo: "hello"
    }
  """</span>

<span class="k">val</span> <span class="nv">errors</span> <span class="k">=</span> <span class="nv">QueryValidator</span><span class="o">.</span><span class="py">default</span><span class="o">.</span><span class="py">validateInputDocument</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">inp</span><span class="o">,</span> <span class="s">"Config"</span><span class="o">)</span>
</code></pre></div></div>

<p>In contrast to standard validation, you also need to provide an input type against which you would like to validate the input
document. Validation will result in following errors:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">At</span> <span class="nx">path</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span> <span class="nx">Int</span> <span class="nx">value</span> <span class="nx">expected</span> <span class="p">(</span><span class="nx">line</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">column</span> <span class="mi">13</span><span class="p">):</span>
            <span class="nx">bar</span><span class="p">:</span> <span class="dl">"</span><span class="s2">foo</span><span class="dl">"</span>
            <span class="o">^</span>

<span class="nx">At</span> <span class="nx">path</span> <span class="dl">'</span><span class="s1">list[1].baz</span><span class="dl">'</span> <span class="nx">Enum</span> <span class="nx">value</span> <span class="dl">'</span><span class="s1">FOO_BAR</span><span class="dl">'</span> <span class="nx">is</span> <span class="kc">undefined</span> <span class="k">in</span> <span class="kr">enum</span> <span class="nx">type</span> <span class="dl">'</span><span class="s1">Color</span><span class="dl">'</span><span class="p">.</span> <span class="nx">Known</span> <span class="nx">values</span> <span class="nx">are</span><span class="p">:</span> <span class="nx">RED</span><span class="p">,</span> <span class="nx">GREEN</span><span class="p">,</span> <span class="nx">BLUE</span><span class="p">.</span> <span class="p">(</span><span class="nx">line</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">column</span> <span class="mi">13</span><span class="p">):</span>
            <span class="nx">list</span><span class="p">:</span> <span class="p">[</span>
            <span class="o">^</span>
 <span class="p">(</span><span class="nx">line</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">column</span> <span class="mi">19</span><span class="p">):</span>
            <span class="nx">list</span><span class="p">:</span> <span class="p">[</span>
                  <span class="o">^</span>
 <span class="p">(</span><span class="nx">line</span> <span class="mi">7</span><span class="p">,</span> <span class="nx">column</span> <span class="mi">16</span><span class="p">):</span>
              <span class="p">{</span><span class="nl">baz</span><span class="p">:</span> <span class="nx">FOO_BAR</span><span class="p">}</span>
               <span class="o">^</span>

<span class="nx">At</span> <span class="nx">path</span> <span class="dl">'</span><span class="s1">list[2].test</span><span class="dl">'</span> <span class="nx">Field</span> <span class="dl">'</span><span class="s1">test</span><span class="dl">'</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">defined</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">input</span> <span class="nx">type</span> <span class="dl">'</span><span class="s1">Foo</span><span class="dl">'</span><span class="p">.</span> <span class="p">(</span><span class="nx">line</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">column</span> <span class="mi">13</span><span class="p">):</span>
            <span class="nx">list</span><span class="p">:</span> <span class="p">[</span>
            <span class="o">^</span>

<span class="p">...</span>
</code></pre></div></div>

<h3 id="schema-validation">Schema Validation</h3>

<p>Just like query validation, schema validation consists of validation rules. You can pick and choose which rules you would like to use for a schema validation. You
can even create your own validation rules and validate schema against them. The list of standard validation rules is available in <code class="language-plaintext highlighter-rouge">SchemaValidationRule.default</code>.</p>

<p>You can also customise the list of validation rules when you are creating a schema by providing a custom list of rules like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Schema</span><span class="o">(</span><span class="nc">QueryType</span><span class="o">,</span> <span class="n">validationRules</span> <span class="k">=</span> <span class="o">...)</span>
</code></pre></div></div>

<h3 id="verification-with-query-reducers">Verification With Query Reducers</h3>

<p>Query reducers provide a lot useful analysis tools, but they require 2 bits of information in addition to a query: <code class="language-plaintext highlighter-rouge">operationName</code> and <code class="language-plaintext highlighter-rouge">variables</code>.
Still, you can execute query reducers against query without executing it by using <code class="language-plaintext highlighter-rouge">Executor.prepare</code>. <code class="language-plaintext highlighter-rouge">prepare</code> will not execute the query,
but instead it will prepare query for execution ensuring that query is validated and all query reducers are successful.</p>

<p>Here is how you can ensure that query complexity does not exceed the threshold:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">variables</span><span class="k">:</span> <span class="kt">Json</span> <span class="o">=</span>  <span class="o">...</span>

<span class="k">val</span> <span class="nv">prepared</span> <span class="k">=</span>
  <span class="nv">query</span><span class="o">.</span><span class="py">operations</span><span class="o">.</span><span class="py">keySet</span><span class="o">.</span><span class="py">map</span> <span class="o">{</span> <span class="n">operationName</span> <span class="k">=&gt;</span>
    <span class="nv">Executor</span><span class="o">.</span><span class="py">prepare</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span>
      <span class="n">operationName</span> <span class="k">=</span> <span class="n">operationName</span><span class="o">,</span>
      <span class="n">variables</span> <span class="k">=</span> <span class="n">variables</span><span class="o">,</span>
      <span class="n">queryReducers</span> <span class="k">=</span>
        <span class="nv">QueryReducer</span><span class="o">.</span><span class="py">rejectComplexQueries</span><span class="o">(</span><span class="mi">1000</span><span class="o">,</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">TooExpansiveQuery</span><span class="o">))</span> <span class="o">::</span> <span class="nc">Nil</span>
  <span class="o">}</span>

<span class="k">val</span> <span class="nv">validated</span> <span class="k">=</span> <span class="nv">Future</span><span class="o">.</span><span class="py">sequence</span><span class="o">(</span><span class="n">prepared</span><span class="o">).</span><span class="py">map</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Done</span><span class="o">)</span>
</code></pre></div></div>

<p>You will need to initialize all required variable values with some stubs. All variable variable values that represent things that potentially
may increase query complexity, like list limits, should be set to values that represent the worst-case scenario (like max limit).</p>

<p>If you don’t have the variables or don’t want to work with the stub value, then you can use another mechanism that does not require variables.
<code class="language-plaintext highlighter-rouge">QueryReducerExecutor.reduceQueryWithoutVariables</code> provides a convenient way to achieve this. In its signature it is similar to
<code class="language-plaintext highlighter-rouge">Executor.prepare</code>, but it does not require <code class="language-plaintext highlighter-rouge">variables</code> and designed to validate and execute query reducers for queries that are
being analyzed ahead of time (e.g. in the context of persistent queries).</p>

<h3 id="astvisitor">AstVisitor</h3>

<p><code class="language-plaintext highlighter-rouge">AstVisitor</code> provides an easy way to traverse and possibly transform all <code class="language-plaintext highlighter-rouge">AstNode</code>s in a query. Here is how basic usage looks like:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">queryWithoutComments</span> <span class="k">=</span>
  <span class="nv">AstVisitor</span><span class="o">.</span><span class="py">visit</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">AstVisitor</span> <span class="o">{</span>
    <span class="k">case</span> <span class="k">_:</span> <span class="kt">Comment</span> <span class="o">=&gt;</span> <span class="nv">VisitorCommand</span><span class="o">.</span><span class="py">Delete</span>
  <span class="o">})</span>
</code></pre></div></div>

<p>This visit will create a new query <code class="language-plaintext highlighter-rouge">Document</code> that does not contain any comments.</p>

<p><code class="language-plaintext highlighter-rouge">AstVisitor</code> also provides several variations of <code class="language-plaintext highlighter-rouge">visit</code> function that allow you to visit AST nodes with type info (from schema definition) and state.</p>

<p>If you would like to analyse field (and all of it’s selections/nested fields) inside of a <code class="language-plaintext highlighter-rouge">resolve</code> function, you can access it with <code class="language-plaintext highlighter-rouge">Context.astFields</code> and then use
<code class="language-plaintext highlighter-rouge">AstVisitor</code> to analyse it. You may also consider using <a href="#projections">projections feature</a> for this.</p>

<h3 id="document-analyzer">Document Analyzer</h3>

<p>Sangria provides several high-level tools to analyse AST <code class="language-plaintext highlighter-rouge">Document</code> without reliance on schema. They are defined in <code class="language-plaintext highlighter-rouge">DocumentAnalyzer</code>
(which you can also access via <code class="language-plaintext highlighter-rouge">query.analyzer</code>).</p>

<p>Here is an example of how you can separate query operations:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">query</span> <span class="k">=</span>
  <span class="n">gql</span><span class="s">"""
    query One {
      ...A
    }

    query Two {
      foo
      bar
      ...B
      ...C
    }

    fragment A on T {
      field
      ...C
    }

    fragment B on T {
      fieldX
    }

    fragment C on T {
      fieldC
    }
  """</span>

<span class="nv">query</span><span class="o">.</span><span class="py">analyzer</span><span class="o">.</span><span class="py">separateOperations</span><span class="o">.</span><span class="py">values</span><span class="o">.</span><span class="py">foreach</span> <span class="o">{</span> <span class="n">document</span> <span class="k">=&gt;</span>
  <span class="nf">println</span><span class="o">(</span><span class="nv">document</span><span class="o">.</span><span class="py">renderPretty</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">separateOperations</code> will create two <code class="language-plaintext highlighter-rouge">Document</code>s that look like this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">query</span> <span class="nx">One</span> <span class="p">{</span>
  <span class="p">...</span><span class="nx">A</span>
<span class="p">}</span>

<span class="nx">fragment</span> <span class="nx">A</span> <span class="nx">on</span> <span class="nx">T</span> <span class="p">{</span>
  <span class="nx">field</span>
  <span class="p">...</span><span class="nx">C</span>
<span class="p">}</span>

<span class="nx">fragment</span> <span class="nx">C</span> <span class="nx">on</span> <span class="nx">T</span> <span class="p">{</span>
  <span class="nx">fieldC</span>
<span class="p">}</span>
</code></pre></div></div>

<p>and</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">query</span> <span class="nx">Two</span> <span class="p">{</span>
  <span class="nx">foo</span>
  <span class="nx">bar</span>
  <span class="p">...</span><span class="nx">B</span>
  <span class="p">...</span><span class="nx">C</span>
<span class="p">}</span>

<span class="nx">fragment</span> <span class="nx">B</span> <span class="nx">on</span> <span class="nx">T</span> <span class="p">{</span>
  <span class="nx">fieldX</span>
<span class="p">}</span>

<span class="nx">fragment</span> <span class="nx">C</span> <span class="nx">on</span> <span class="nx">T</span> <span class="p">{</span>
  <span class="nx">fieldC</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="schema-based-document-analyzer">Schema Based Document Analyzer</h3>

<p>While <code class="language-plaintext highlighter-rouge">DocumentAnalyzer</code> does not rely on a schema information to analyse the query <code class="language-plaintext highlighter-rouge">Document</code>, <code class="language-plaintext highlighter-rouge">SchemaBasedDocumentAnalyzer</code> uses schema
provide much deeper query analysis. It can be used to discover things like deprecated field, introspection, variable usage.</p>

<p>Here is an example of how you can find all deprecated field and enum value usages:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">schema</span><span class="o">.</span><span class="py">analyzer</span><span class="o">(</span><span class="n">query</span><span class="o">).</span><span class="py">deprecatedUsages</span>
</code></pre></div></div>

<h3 id="schema-comparison">Schema Comparison</h3>

<p>Schema comparator provides an easy way to compare schemas between each other. You can, of course, compare unrelated schemas and get all of the differences as a list.
Where it becomes really useful, is when you compare different versions of the same schema.</p>

<p>In this example I compare a schema loaded from staging environment against the schema from a production environment:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">prodSchema</span> <span class="k">=</span> <span class="nv">Schema</span><span class="o">.</span><span class="py">buildFromIntrospection</span><span class="o">(</span>
  <span class="nf">loadSchema</span><span class="o">(</span><span class="s">"http://prod.my-company.com/graphql"</span><span class="o">))</span>

<span class="k">val</span> <span class="nv">stagingSchema</span> <span class="k">=</span> <span class="nv">Schema</span><span class="o">.</span><span class="py">buildFromIntrospection</span><span class="o">(</span>
  <span class="nf">loadSchema</span><span class="o">(</span><span class="s">"http://staging.my-company.com/graphql"</span><span class="o">))</span>

<span class="k">val</span> <span class="nv">changes</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">SchemaChange</span><span class="o">]</span> <span class="k">=</span> <span class="n">stagingSchema</span> <span class="n">compare</span> <span class="n">prodSchema</span>
</code></pre></div></div>

<p>Given this list of changes, we can do a few interesting thing with it. For instance, we can stop the deployment
to production if staging environment contains <strong>breaking changes</strong> (you can run this somewhere in your CI environment):</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">breakingChanges</span> <span class="k">=</span> <span class="nv">changes</span><span class="o">.</span><span class="py">filter</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">breakingChange</span><span class="o">)</span>

<span class="nf">if</span> <span class="o">(</span><span class="nv">breakingChanges</span><span class="o">.</span><span class="py">nonEmpty</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">rendered</span> <span class="k">=</span> <span class="n">breakingChanges</span>
    <span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">change</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="s">" * ${change.description}"</span><span class="o">)</span>
    <span class="o">.</span><span class="py">mkString</span><span class="o">(</span><span class="s">"\n"</span><span class="o">,</span> <span class="s">"\n"</span><span class="o">,</span> <span class="s">""</span><span class="o">)</span>

  <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">(</span>
    <span class="n">s</span><span class="s">"Staging environment has breaking changes in GraphQL schema! $rendered"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>You can also create <strong>release notes</strong> for all of the changes:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">releaseNotes</span> <span class="k">=</span>
  <span class="nf">if</span> <span class="o">(</span><span class="nv">changes</span><span class="o">.</span><span class="py">nonEmpty</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">rendered</span> <span class="k">=</span> <span class="n">changes</span>
      <span class="o">.</span><span class="py">map</span> <span class="o">{</span> <span class="n">change</span> <span class="k">=&gt;</span>
        <span class="k">val</span> <span class="nv">breaking</span> <span class="k">=</span>
          <span class="nf">if</span><span class="o">(</span><span class="nv">change</span><span class="o">.</span><span class="py">breakingChange</span><span class="o">)</span> <span class="s">" (breaking change)"</span>
          <span class="k">else</span> <span class="s">""</span>

        <span class="n">s</span><span class="s">" * ${change.description}$breaking"</span>
      <span class="o">}</span>
      <span class="o">.</span><span class="py">mkString</span><span class="o">(</span><span class="s">"\n"</span><span class="o">,</span> <span class="s">"\n"</span><span class="o">,</span> <span class="s">""</span><span class="o">)</span>

    <span class="n">s</span><span class="s">"Release Notes: $rendered"</span>
  <span class="o">}</span> <span class="k">else</span> <span class="s">"No Changes"</span>
</code></pre></div></div>

<h2 id="stream-based-subscriptions">Stream-based Subscriptions</h2>

<p>As described in <a href="#prepared-queries">previous section</a>, you can handle subscription queries with prepared queries.
This approach provides a lot of flexibility, but also means that you need to manually analyze subscription fields and appropriately
execute query for every event.</p>

<p>Stream-based subscriptions provide much easier and, in many respects, superior approach of handling subscription queries.
In order to use it, you first need to choose one of available stream implementations:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">sangria.streaming.akkaStreams._</code> - <a href="http://doc.akka.io/docs/akka/current/scala/stream/index.html">akka-streams</a> implementation based on <code class="language-plaintext highlighter-rouge">Source[T, NotUsed]</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">"org.sangria-graphql" %% "sangria-akka-streams" % "1.0.2"</code></li>
      <li>Requires an implicit <code class="language-plaintext highlighter-rouge">akka.stream.Materializer</code> to be available in scope</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">sangria.streaming.rxscala._</code> - <a href="http://reactivex.io/rxscala">RxScala</a> implementation based on <code class="language-plaintext highlighter-rouge">Observable[T]</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">"org.sangria-graphql" %% "sangria-rxscala" % "1.0.0"</code></li>
      <li>Requires an implicit <code class="language-plaintext highlighter-rouge">scala.concurrent.ExecutionContext</code> to be available in scope</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">sangria.streaming.monix._</code> - <a href="https://monix.io">monix</a> implementation based on <code class="language-plaintext highlighter-rouge">Observable[T]</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">"org.sangria-graphql" %% "sangria-monix" % "2.0.0"</code></li>
      <li>Requires an implicit <code class="language-plaintext highlighter-rouge">monix.execution.Scheduler</code> to be available in scope</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">sangria.streaming.future._</code> - very simple implementation based on <code class="language-plaintext highlighter-rouge">Future[T]</code> which is treated as a stream with a single element
    <ul>
      <li>Requires an implicit <code class="language-plaintext highlighter-rouge">scala.concurrent.ExecutionContext</code> to be available in scope</li>
    </ul>
  </li>
</ul>

<p>You can also easily create your own integration by implementing and providing an implicit instance of <code class="language-plaintext highlighter-rouge">SubscriptionStream[S]</code> type class.</p>

<div class="bs-callout bs-callout-info"><h4>Example project</h4><p>
If you prefer a hands-on approach, then you can take a look at <a href="https://github.com/sangria-graphql/sangria-subscriptions-example">sangria-subscriptions-example</a> project. It demonstrates most of the concepts that are described in this section.
</p></div>

<p>After you have imported a concrete stream implementation, you can define a subscription type fields with <code class="language-plaintext highlighter-rouge">Field.subs</code>.
Here is an example that uses monix:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">monix.execution.Scheduler.Implicits.global</span>
<span class="k">import</span> <span class="nn">monix.reactive.Observable</span>
<span class="k">import</span> <span class="nn">sangria.streaming.monix._</span>

<span class="k">val</span> <span class="nv">SubscriptionType</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">(</span><span class="s">"Subscription"</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">Unit</span><span class="o">](</span>
  <span class="nv">Field</span><span class="o">.</span><span class="py">subs</span><span class="o">(</span><span class="s">"userEvents"</span><span class="o">,</span> <span class="nc">UserEventType</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="k">_</span> <span class="k">=&gt;</span>
    <span class="nc">Observable</span><span class="o">(</span><span class="nc">UserCreated</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"Bob"</span><span class="o">),</span> <span class="nc">UserNameChanged</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"John"</span><span class="o">)).</span><span class="py">map</span><span class="o">(</span><span class="nf">action</span><span class="o">(</span><span class="k">_</span><span class="o">))),</span>

  <span class="nv">Field</span><span class="o">.</span><span class="py">subs</span><span class="o">(</span><span class="s">"messageEvents"</span><span class="o">,</span> <span class="nc">MessageEventType</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="k">_</span> <span class="k">=&gt;</span>
    <span class="nc">Observable</span><span class="o">(</span><span class="nc">MessagePosted</span><span class="o">(</span><span class="n">userId</span> <span class="k">=</span> <span class="mi">20</span><span class="o">,</span> <span class="n">text</span> <span class="k">=</span> <span class="s">"Hello!"</span><span class="o">)).</span><span class="py">map</span><span class="o">(</span><span class="nf">action</span><span class="o">(</span><span class="k">_</span><span class="o">)))</span>
<span class="o">))</span>
</code></pre></div></div>

<p>Please note that every element in a stream should be an <code class="language-plaintext highlighter-rouge">Action[Ctx, Val]</code>. An <code class="language-plaintext highlighter-rouge">action</code> helper function is used in this case to
transform every element of a stream into an <code class="language-plaintext highlighter-rouge">Action</code>. Also, it is important that either all fields of a <code class="language-plaintext highlighter-rouge">SubscriptionType</code> or none of them are
created with the <code class="language-plaintext highlighter-rouge">Field.subs</code> function (otherwise it would not be possible to merge them in a single stream).</p>

<p>Now you can execute subscription queries and get back a stream of query execution results like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">monix.execution.Scheduler.Implicits.global</span>
<span class="k">import</span> <span class="nn">sangria.streaming.monix._</span>
<span class="k">import</span> <span class="nn">sangria.execution.ExecutionScheme.Stream</span>

<span class="k">val</span> <span class="nv">schema</span> <span class="k">=</span> <span class="nc">Schema</span><span class="o">(</span><span class="nc">QueryType</span><span class="o">,</span> <span class="n">subscription</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">SubscriptionType</span><span class="o">))</span>

<span class="k">val</span> <span class="nv">query</span> <span class="k">=</span>
  <span class="n">graphql</span><span class="s">"""
    subscription {
      userEvents {
        id
        __typename

        ... on UserCreated {
          name
        }
      }

      messageEvents {
        __typename

        ... on MessagePosted {
          user {
            id
            name
          }

          text
        }
      }
    }
  """</span>

<span class="k">val</span> <span class="nv">stream</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">)</span>
</code></pre></div></div>

<p>We are importing <code class="language-plaintext highlighter-rouge">ExecutionScheme.Stream</code> to instruct the executor to return a stream of results instead of a <code class="language-plaintext highlighter-rouge">Future</code> of a single result.
The stream will emit the following elements (the order may be different):</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"userEvents"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"__typename"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UserCreated"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bob"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"messageEvents"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"__typename"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MessagePosted"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Test User"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hello!"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"userEvents"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"__typename"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UserNameChanged"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Only the top-level subscription fields have special semantics associated with them (in this respect it is similar to the mutation queries).
The execution engine merges the requested field streams into a single stream which is then returned as a result of the execution.
All other fields (2nd level, 3rd level, etc.) have normal semantics and would be fully resolved.</p>

<div class="bs-callout bs-callout-info"><h4>Work In Progress</h4><p>
Please note, that the semantics of subscription queries is not standardized or fully defined at the moment. It may change in future, so use this feature with caution.
</p></div>

<h2 id="deferred-value-resolution">Deferred Value Resolution</h2>

<p>In the example schema, you probably noticed that some of the resolve functions return <code class="language-plaintext highlighter-rouge">DeferFriends</code>. It is defined like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">DeferFriends</span><span class="o">(</span><span class="n">friends</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Deferred</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Character</span><span class="o">]]</span>
</code></pre></div></div>

<p>The defer mechanism allows you to postpone the execution of particular fields and then batch them together in order to optimise object retrieval.
This can be very useful when you want to avoid an N+1 problem. In the example schema all of the characters have a list of friends, but they only have their IDs.
You need to fetch them from somewhere in order to progress query execution.
Retrieving every friend one-by-one would be very inefficient, since you potentially need to access an external database
in order to do so. The defer mechanism allows you to batch all these friend list retrieval requests in one efficient request to the DB.
In order to do it, you need to implement a <code class="language-plaintext highlighter-rouge">DeferredResolver</code> that will get a list of deferred values:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FriendsResolver</span> <span class="k">extends</span> <span class="nc">DeferredResolver</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">resolve</span><span class="o">(</span><span class="n">deferred</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Deferred</span><span class="o">[</span><span class="kt">Any</span><span class="o">]],</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">Any</span><span class="o">,</span> <span class="n">queryState</span><span class="k">:</span> <span class="kt">Any</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span> <span class="k">=</span>
    <span class="c1">// Here goes your resolution logic</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">resolve</code> function gives you a list of <code class="language-plaintext highlighter-rouge">Deferred[A]</code> values and expects you to return a list of resolved values <code class="language-plaintext highlighter-rouge">Future[B]</code>.</p>

<p>It is important to note that the resulting list must have the same size. This allows an executor to figure out the relation
between deferred values and results. The order of results also plays an important role.
(Fetch API, which is described below, uses <code class="language-plaintext highlighter-rouge">HasId</code> type class to match the entities, so the contract/restriction only relevant for <code class="language-plaintext highlighter-rouge">DeferredResolver</code>)</p>

<p>After you have defined a <code class="language-plaintext highlighter-rouge">DeferredResolver[T]</code>, you can provide it to an executor like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="n">deferredResolver</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">FriendsResolver</span><span class="o">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">DeferredResolver</code> will do its best to batch as many deferred values as possible. Let’s look at this example query to see how it works:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="nx">hero</span> <span class="p">{</span>
    <span class="nx">friends</span> <span class="p">{</span>
      <span class="nx">friends</span> <span class="p">{</span>
        <span class="nx">friends</span> <span class="p">{</span>
          <span class="nx">friends</span> <span class="p">{</span>
            <span class="nx">name</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="nl">more</span><span class="p">:</span> <span class="nx">friends</span> <span class="p">{</span>
        <span class="nx">friends</span> <span class="p">{</span>
          <span class="nx">friends</span> <span class="p">{</span>
            <span class="nx">name</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>During an execution of this query, the amount of produced <code class="language-plaintext highlighter-rouge">Deferred</code> values grows exponentially. Still <code class="language-plaintext highlighter-rouge">DeferredResolver.resolve</code> method
would be called only <strong>4</strong> times by the executor because the query has only 4 levels of fields that return deferred values (<code class="language-plaintext highlighter-rouge">friends</code> in this case).</p>

<h3 id="transforming-the-deferred-value">Transforming the Deferred Value</h3>

<p>It is quite common requirement to transform the resolved deferred value before it is used by the execution engine. This can be easily achieved
with <code class="language-plaintext highlighter-rouge">map</code> method on the <code class="language-plaintext highlighter-rouge">DeferredValue</code> action. here is an example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Field</span><span class="o">(</span><span class="s">"products"</span><span class="o">,</span> <span class="nc">ListType</span><span class="o">(</span><span class="nc">ProductType</span><span class="o">),</span>
  <span class="n">resolve</span> <span class="k">=</span> <span class="n">c</span> <span class="k">=&gt;</span>
    <span class="nc">DeferredValue</span><span class="o">(</span><span class="nv">fetcherProd</span><span class="o">.</span><span class="py">deferSeqOpt</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">products</span><span class="o">))</span>
      <span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">fetchedProducts</span> <span class="k">=&gt;</span> <span class="o">...)),</span>
</code></pre></div></div>

<p>In some cases you need to report errors that happened during deferred value resolution, but still preserving successful result. You can do
it by using <code class="language-plaintext highlighter-rouge">mapWithErrors</code> instead of <code class="language-plaintext highlighter-rouge">map</code>.</p>

<p>Functions like <code class="language-plaintext highlighter-rouge">defer</code> or <code class="language-plaintext highlighter-rouge">deferSeq</code> will trigger internal errors if one of the deferred values cannot be resolved (tags with id <code class="language-plaintext highlighter-rouge">1</code>, <code class="language-plaintext highlighter-rouge">2</code>, and <code class="language-plaintext highlighter-rouge">3</code> are requested but the deferred resolver only returns tags with id <code class="language-plaintext highlighter-rouge">1</code> and <code class="language-plaintext highlighter-rouge">3</code> for example), whereas their <code class="language-plaintext highlighter-rouge">Opt</code> counterparts (<code class="language-plaintext highlighter-rouge">deferOpt</code>, <code class="language-plaintext highlighter-rouge">deferSeqOpt</code>, etc.), although having the same signatures, will ignore the missing values silently.</p>

<h3 id="deferredresolver-state">DeferredResolver State</h3>

<p>In some cases you may need to have some state inside of a <code class="language-plaintext highlighter-rouge">DeferredResolver</code> for every query execution. This, for instance, is necessary when you
implement a cache inside of the resolver.</p>

<p>Internally, an executor manages <code class="language-plaintext highlighter-rouge">DeferredResolver</code> state and provides it via the <code class="language-plaintext highlighter-rouge">queryState</code> argument to a <code class="language-plaintext highlighter-rouge">resolve</code> method. You can provide an initial
state by overriding the <code class="language-plaintext highlighter-rouge">initialQueryState</code> method:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyResolver</span><span class="o">[</span><span class="kt">Ctx</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">DeferredResolver</span><span class="o">[</span><span class="kt">Ctx</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">initialQueryState</span><span class="k">:</span> <span class="kt">Any</span> <span class="o">=</span> <span class="nc">TrieMap</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Any</span><span class="o">]()</span>

  <span class="k">def</span> <span class="nf">resolve</span><span class="o">(</span><span class="n">deferred</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Deferred</span><span class="o">[</span><span class="kt">Any</span><span class="o">]],</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">Ctx</span><span class="o">,</span> <span class="n">queryState</span><span class="k">:</span> <span class="kt">Any</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span> <span class="k">=</span>
    <span class="c1">// resolve deferred values by using cache from `queryState`</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="customizing-deferredresolver-behaviour">Customizing DeferredResolver Behaviour</h3>

<p>As was mentioned before, <code class="language-plaintext highlighter-rouge">DeferredResolver</code> will do its best to collect and batch as many <code class="language-plaintext highlighter-rouge">Deferred</code> values as possible. This means that it
will even wait for a <code class="language-plaintext highlighter-rouge">Future</code> to produce some values in order to find out whether they produce some deferred values.</p>

<p>In some cases this is not desired. You can override the following methods in order to customize this behaviour and define independent
deferred value groups:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">includeDeferredFromField</code> - A function that decides whether deferred values from a particular field should be collected or processed independently.</li>
  <li><code class="language-plaintext highlighter-rouge">groupDeferred</code> - Provides a way to group deferred values in batches that would be processed independently. Useful for separating cheap and expensive deferred values.</li>
</ul>

<h3 id="high-level-fetch-api">High-level Fetch API</h3>

<p><code class="language-plaintext highlighter-rouge">DeferredResolver</code> provides a very flexible mechanism to batch retrieval of objects from the external services or databases, but it provides a
very low-level, unsafe, but efficient API for this. You certainly can use it directly, especially in more non-trivial cases, but most of the time
you probably will work with isolated entity objects which you would like to load by ID or some relation to other entities. This is where <code class="language-plaintext highlighter-rouge">Fetcher</code>
comes into play.</p>

<p><code class="language-plaintext highlighter-rouge">Fetcher</code> provides a high-level API for deferred value resolution and is implemented as a specialized version of <code class="language-plaintext highlighter-rouge">DeferredResolver</code>.
This API provides the following features:</p>

<ul>
  <li>Deferred value resolution based on entity IDs</li>
  <li>Deferred value resolution based on entity relations</li>
  <li>Deduplication of the entities based on the ID</li>
  <li>Caching support</li>
  <li>Support for <code class="language-plaintext highlighter-rouge">maxBatchSize</code></li>
  <li>Supports a fallback to an existing <code class="language-plaintext highlighter-rouge">DeferredResolver</code></li>
</ul>

<p>Examples in this section will use the following data model of products and categories:</p>

<div class="example-tables">
  <div class="left-table">
    <span class="table-title">Products</span>
    <table>
      <thead><tr>
        <th>ID</th>
        <th>Name</th>
      </tr></thead>
      <tbody>
        <tr>
          <td>1</td>
          <td>Rusty sword</td>
        </tr>
        <tr>
          <td>2</td>
          <td>Health potion</td>
        </tr>
        <tr>
          <td>3</td>
          <td>Small mana potion</td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="right-table">
    <span class="table-title">Categories</span>
    <table>
      <thead><tr>
        <th>ID</th>
        <th>Name</th>
        <th>Parent</th>
        <th>Products</th>
      </tr></thead>
      <tbody>
        <tr>
          <td>1</td>
          <td>Root</td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td>2</td>
          <td>Equipment</td>
          <td>1</td>
          <td>[1]</td>
        </tr>
        <tr>
          <td>3</td>
          <td>Potions</td>
          <td>1</td>
          <td>[2, 3]</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<p>As you can see, the product table (which also can be a document in a document DB or just JSON which is returned from an external service call)
just has product information. Category, on the the other hand, also contains 2 relations - to the products within this category and to a parent category.
First let’s look at how we can fetch entities by ID, and then we will look at how we can use a relation information for this.</p>

<p>First of all you need to define a Fetcher:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">products</span> <span class="k">=</span>
  <span class="nc">Fetcher</span><span class="o">((</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">MyCtx</span><span class="o">,</span> <span class="n">ids</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span> <span class="k">=&gt;</span>
    <span class="nv">ctx</span><span class="o">.</span><span class="py">loadProductsById</span><span class="o">(</span><span class="n">ids</span><span class="o">))</span>

<span class="k">val</span> <span class="nv">categories</span> <span class="k">=</span>
  <span class="nc">Fetcher</span><span class="o">((</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">MyCtx</span><span class="o">,</span> <span class="n">ids</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span> <span class="k">=&gt;</span>
    <span class="nv">ctx</span><span class="o">.</span><span class="py">loadCategoriesById</span><span class="o">(</span><span class="n">ids</span><span class="o">))</span>
</code></pre></div></div>

<p>Now you should be able to define a <code class="language-plaintext highlighter-rouge">DeferredResolver</code> based on these fetchers:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">resolver</span><span class="k">:</span> <span class="kt">DeferredResolver</span><span class="o">[</span><span class="kt">MyCtx</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">DeferredResolver</span><span class="o">.</span><span class="py">fetchers</span><span class="o">(</span><span class="n">products</span><span class="o">,</span> <span class="n">categories</span><span class="o">)</span>
</code></pre></div></div>

<p>Every time you need to load a particular entity by ID, you can use the fetcher to create a <code class="language-plaintext highlighter-rouge">Deferred</code> value for you:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Field</span><span class="o">(</span><span class="s">"category"</span><span class="o">,</span> <span class="nc">CategoryType</span><span class="o">,</span>
  <span class="n">arguments</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="nc">IntType</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
  <span class="n">resolve</span> <span class="k">=</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="nv">categories</span><span class="o">.</span><span class="py">defer</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">arg</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="s">"id"</span><span class="o">)))</span>

<span class="nc">Field</span><span class="o">(</span><span class="s">"categoryMaybe"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">CategoryType</span><span class="o">),</span>
  <span class="n">arguments</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="nc">IntType</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
  <span class="n">resolve</span> <span class="k">=</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="nv">categories</span><span class="o">.</span><span class="py">deferOpt</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">arg</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="s">"id"</span><span class="o">)))</span>

<span class="nc">Field</span><span class="o">(</span><span class="s">"productsWithinCategory"</span><span class="o">,</span> <span class="nc">ListType</span><span class="o">(</span><span class="nc">ProductType</span><span class="o">),</span>
  <span class="n">resolve</span> <span class="k">=</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="nv">categories</span><span class="o">.</span><span class="py">deferSeqOpt</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">products</span><span class="o">))</span>
</code></pre></div></div>

<p>The deferred resolution mechanism will take care of the rest and will fetch products and categories in the most efficient way.</p>

<h4 id="transforming-fetched-entities-with-deferredvalue">Transforming Fetched Entities with <code class="language-plaintext highlighter-rouge">DeferredValue</code></h4>

<p>Fetched entities can be further transformed as part of the deferred resolution
mechanism by wrapping the deferred value in <code class="language-plaintext highlighter-rouge">DeferredValue</code> and using its <code class="language-plaintext highlighter-rouge">map</code>
method.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Field</span><span class="o">(</span><span class="s">"categoryName"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">),</span>
  <span class="n">resolve</span> <span class="k">=</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="nc">DeferredValue</span><span class="o">(</span><span class="nv">categories</span><span class="o">.</span><span class="py">deferOpt</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">categoryId</span><span class="o">)).</span><span class="py">map</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">name</span><span class="o">))</span>
</code></pre></div></div>

<h4 id="hasid-type-class">HasId Type Class</h4>

<p>In order to extract the ID from entities, the Fetch API uses the <code class="language-plaintext highlighter-rouge">HasId</code> type class:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Product</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">Product</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">hasId</span> <span class="k">=</span> <span class="nc">HasId</span><span class="o">[</span><span class="kt">Product</span>, <span class="kt">String</span><span class="o">](</span><span class="nv">_</span><span class="o">.</span><span class="py">id</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>If you don’t want to define an implicit instance, you can also provide it directly to the fetcher like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Fetcher</span><span class="o">((</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">MyCtx</span><span class="o">,</span> <span class="n">ids</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">=&gt;</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">loadProductsById</span><span class="o">(</span><span class="n">ids</span><span class="o">))(</span><span class="nc">HasId</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">id</span><span class="o">))</span>
</code></pre></div></div>

<h4 id="fetching-relations">Fetching Relations</h4>

<p>The Fetch API is also able to fetch entities based on their relation to other entities. In our example category has 2 relations, so let’s define these relations:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">byParent</span> <span class="k">=</span> <span class="nc">Relation</span><span class="o">[</span><span class="kt">Category</span>, <span class="kt">Int</span><span class="o">](</span><span class="s">"byParent"</span><span class="o">,</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="nc">Seq</span><span class="o">(</span><span class="nv">c</span><span class="o">.</span><span class="py">parent</span><span class="o">))</span>
<span class="k">val</span> <span class="nv">byProduct</span> <span class="k">=</span> <span class="nc">Relation</span><span class="o">[</span><span class="kt">Category</span>, <span class="kt">Int</span><span class="o">](</span><span class="s">"byProduct"</span><span class="o">,</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="nv">c</span><span class="o">.</span><span class="py">products</span><span class="o">)</span>
</code></pre></div></div>

<p>You need to use <code class="language-plaintext highlighter-rouge">Fetcher.rel</code> to define a <code class="language-plaintext highlighter-rouge">Fetcher</code> that supports relations:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">categories</span> <span class="k">=</span> <span class="nv">Fetcher</span><span class="o">.</span><span class="py">rel</span><span class="o">(</span>
  <span class="o">(</span><span class="n">repo</span><span class="o">,</span> <span class="n">ids</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nv">repo</span><span class="o">.</span><span class="py">loadCategories</span><span class="o">(</span><span class="n">ids</span><span class="o">),</span>
  <span class="o">(</span><span class="n">repo</span><span class="o">,</span> <span class="n">ids</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nv">repo</span><span class="o">.</span><span class="py">loadCategoriesByRelation</span><span class="o">(</span><span class="n">ids</span><span class="o">))</span>
</code></pre></div></div>

<p>In case of relation batch function <code class="language-plaintext highlighter-rouge">ids</code> would be of type <code class="language-plaintext highlighter-rouge">RelationIds[Res]</code> which contains the list of IDs for every relation type.</p>

<p>Now you should be able to use the category fetcher to create <code class="language-plaintext highlighter-rouge">Deferred</code> values like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Field</span><span class="o">(</span><span class="s">"categoriesByProduct"</span><span class="o">,</span> <span class="nc">ListType</span><span class="o">(</span><span class="nc">CategoryType</span><span class="o">),</span>
  <span class="n">arguments</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"productId"</span><span class="o">,</span> <span class="nc">IntType</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
  <span class="n">resolve</span> <span class="k">=</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="nv">categories</span><span class="o">.</span><span class="py">deferRelSeq</span><span class="o">(</span><span class="n">byProduct</span><span class="o">,</span> <span class="nv">c</span><span class="o">.</span><span class="py">arg</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="s">"productId"</span><span class="o">)))</span>

<span class="nc">Field</span><span class="o">(</span><span class="s">"categoryChildren"</span><span class="o">,</span> <span class="nc">ListType</span><span class="o">(</span><span class="nc">CategoryType</span><span class="o">),</span>
  <span class="n">resolve</span> <span class="k">=</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="nv">categories</span><span class="o">.</span><span class="py">deferRelSeq</span><span class="o">(</span><span class="n">byParent</span><span class="o">,</span> <span class="nv">c</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">id</span><span class="o">))</span>
</code></pre></div></div>

<h4 id="caching">Caching</h4>

<p>The Fetch API supports caching. You just need to define a fetcher with <code class="language-plaintext highlighter-rouge">Fetcher.caching</code> or <code class="language-plaintext highlighter-rouge">relCaching</code> and all of the entities will be cached on a per-query basis.
This means that every query execution gets its own isolated cache instance.</p>

<p>You can provide an alternative cache implementation via <code class="language-plaintext highlighter-rouge">FetcherConfig</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">cache</span> <span class="k">=</span> <span class="nv">FetcherCache</span><span class="o">.</span><span class="py">simple</span>

<span class="k">val</span> <span class="nv">categories</span> <span class="k">=</span> <span class="nc">Fetcher</span><span class="o">(</span>
  <span class="n">config</span> <span class="k">=</span> <span class="nv">FetcherConfig</span><span class="o">.</span><span class="py">caching</span><span class="o">(</span><span class="n">cache</span><span class="o">),</span>
  <span class="n">fetch</span> <span class="k">=</span> <span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">ids</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">loadCategoriesById</span><span class="o">(</span><span class="n">ids</span><span class="o">))</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">FetcherCache</code> will cache not only the entities themselves, but also relation information between entities.</p>

<h4 id="limiting-batch-size">Limiting Batch Size</h4>

<p>In some cases you may want to split bigger batches into a set of batches of particular size. You can do this by providing an appropriate <code class="language-plaintext highlighter-rouge">FetcherConfig</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">cache</span> <span class="k">=</span> <span class="nv">FetcherCache</span><span class="o">.</span><span class="py">simple</span>

<span class="k">val</span> <span class="nv">categories</span> <span class="k">=</span> <span class="nc">Fetcher</span><span class="o">(</span>
  <span class="n">config</span> <span class="k">=</span> <span class="nv">FetcherConfig</span><span class="o">.</span><span class="py">maxBatchSize</span><span class="o">(</span><span class="mi">10</span><span class="o">),</span>
  <span class="n">fetch</span> <span class="k">=</span> <span class="o">(</span><span class="n">repo</span><span class="o">,</span> <span class="n">ids</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nv">repo</span><span class="o">.</span><span class="py">loadCategories</span><span class="o">(</span><span class="n">ids</span><span class="o">))</span>
</code></pre></div></div>

<h4 id="fallback-to-existing-deferredresolver">Fallback to Existing DeferredResolver</h4>

<p>If you already have an existing <code class="language-plaintext highlighter-rouge">DeferredResolver</code>, you can still use it in combination with fetchers:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DeferredResolver</span><span class="o">.</span><span class="py">fetchersWithFallback</span><span class="o">(</span><span class="k">new</span> <span class="nc">ExitingDeferredResolver</span><span class="o">,</span> <span class="n">products</span><span class="o">,</span> <span class="n">categoies</span><span class="o">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">includeDeferredFromField</code> and <code class="language-plaintext highlighter-rouge">groupDeferred</code> would always be delegated to a fallback.</p>

<h2 id="protection-against-malicious-queries">Protection Against Malicious Queries</h2>

<p>GraphQL is a very flexible data query language. Unfortunately with flexibility comes also a danger of misuse by malicious clients.
Since typical GraphQL schemas contain recursive types and circular dependencies, clients are able to send infinitely deep queries
which may have high impact on server performance. That’s because it’s important to analyze query complexity before executing it.
Sangria provides two mechanisms to protect your GraphQL server from malicious or expensive queries which are described in the next sections.</p>

<h3 id="query-complexity-analysis">Query Complexity Analysis</h3>

<p>Query complexity analysis makes a rough estimation of the query complexity before it is executed. The complexity is a <code class="language-plaintext highlighter-rouge">Double</code> number that is
calculated according to the simple rule described below.</p>

<p>Every field in the query gets a default score <code class="language-plaintext highlighter-rouge">1</code> (including <code class="language-plaintext highlighter-rouge">ObjectType</code> nodes). The “complexity” of the query is the sum of all field scores.</p>

<p>So the following instance query:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">query</span> <span class="nx">Test</span> <span class="p">{</span>
  <span class="nx">droid</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1000</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">id</span>
    <span class="nx">serialNumber</span>
  <span class="p">}</span>

  <span class="nx">pets</span><span class="p">(</span><span class="nx">limit</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">name</span>
    <span class="nx">age</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>will have complexity <code class="language-plaintext highlighter-rouge">6</code>. You probably noticed, that score is a bit unfair since the <code class="language-plaintext highlighter-rouge">pets</code> field is actually a list which can contain a max of 20
elements in the response.</p>

<p>You can customize the field score with a <code class="language-plaintext highlighter-rouge">complexity</code> argument in order to solve these kinds of issues:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Field</span><span class="o">(</span><span class="s">"pets"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ListType</span><span class="o">(</span><span class="nc">PetType</span><span class="o">)),</span>
  <span class="n">arguments</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"limit"</span><span class="o">,</span> <span class="nc">IntType</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
  <span class="n">complexity</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">((</span><span class="n">ctx</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">childScore</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="mf">25.0D</span> <span class="o">+</span> <span class="nv">args</span><span class="o">.</span><span class="py">arg</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="s">"limit"</span><span class="o">)</span> <span class="o">*</span> <span class="n">childScore</span><span class="o">),</span>
  <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="o">...)</span>
</code></pre></div></div>

<p>Now the query will get a score of <code class="language-plaintext highlighter-rouge">68</code> which is a much better estimation.</p>

<p>In order to analyze the complexity of a query, you need to add a corresponding <code class="language-plaintext highlighter-rouge">QueryReducer</code> to the <code class="language-plaintext highlighter-rouge">Executor</code>.
In this example <code class="language-plaintext highlighter-rouge">rejectComplexQueries</code> will reject all queries with complexity higher than <code class="language-plaintext highlighter-rouge">1000</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">rejectComplexQueries</span> <span class="k">=</span> <span class="nv">QueryReducer</span><span class="o">.</span><span class="py">rejectComplexQueries</span><span class="o">[</span><span class="kt">Any</span><span class="o">](</span><span class="mi">1000</span><span class="o">,</span> <span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">ctx</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span><span class="n">s</span><span class="s">"Too complex query"</span><span class="o">))</span>

<span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="n">queryReducers</span> <span class="k">=</span> <span class="n">rejectComplexQueries</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
</code></pre></div></div>

<p>If you just want to estimate the complexity and then perform different actions, then there is another helper function for this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">complReducer</span> <span class="k">=</span> <span class="nv">QueryReducer</span><span class="o">.</span><span class="py">measureComplexity</span><span class="o">[</span><span class="kt">MyCtx</span><span class="o">]</span> <span class="o">{</span> <span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">ctx</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="c1">// do some analysis</span>
  <span class="n">ctx</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The complexity of a full introspection query (used by tools like GraphiQL) is around <code class="language-plaintext highlighter-rouge">100</code>.</p>

<h3 id="limiting-query-depth">Limiting Query Depth</h3>

<p>There is also another simpler mechanism to protect against malicious queries: limiting query depth. It can be done by providing
the <code class="language-plaintext highlighter-rouge">maxQueryDepth</code> argument to the <code class="language-plaintext highlighter-rouge">Executor</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">executor</span> <span class="k">=</span> <span class="nc">Executor</span><span class="o">(</span><span class="n">schema</span> <span class="k">=</span> <span class="nc">MySchema</span><span class="o">,</span> <span class="n">maxQueryDepth</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">7</span><span class="o">))</span>
</code></pre></div></div>

<h2 id="error-handling">Error Handling</h2>

<p>Bad things can happen during the query execution. When errors happen, then <code class="language-plaintext highlighter-rouge">Future</code> would be resolved with some exception. Sangria allows you to distinguish between different types of errors that happen before actual query execution:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QueryReducingError</code> - an error happened in the query reducer. If you are throwing some exceptions within a custom <code class="language-plaintext highlighter-rouge">QueryReducer</code>, then they would be wrapped in <code class="language-plaintext highlighter-rouge">QueryReducingError</code></li>
  <li><code class="language-plaintext highlighter-rouge">QueryAnalysisError</code> - signifies issues in the query or variables. This means that client has made some error. If you are exposing a GraphQL HTTP endpoint, then you may want to return a 400 status code in this case.</li>
  <li><code class="language-plaintext highlighter-rouge">ErrorWithResolver</code> - unexpected errors before query execution</li>
</ul>

<p>All mentioned, exception classes expose a <code class="language-plaintext highlighter-rouge">resolveError</code> method which you can use to render an error in GraphQL-compliant format.</p>

<p>Let’s see how you can handle these error in a small example. In most cases it makes a lot of sense to return a 400 HTTP status code if the query validation failed:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="o">...)</span>
  <span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="nc">Ok</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
  <span class="o">.</span><span class="py">recover</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">error</span><span class="k">:</span> <span class="kt">QueryAnalysisError</span> <span class="o">=&gt;</span> <span class="nc">BadRequest</span><span class="o">(</span><span class="nv">error</span><span class="o">.</span><span class="py">resolveError</span><span class="o">)</span>
    <span class="k">case</span> <span class="n">error</span><span class="k">:</span> <span class="kt">ErrorWithResolver</span> <span class="o">=&gt;</span> <span class="nc">InternalServerError</span><span class="o">(</span><span class="nv">error</span><span class="o">.</span><span class="py">resolveError</span><span class="o">)</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>This code will produce status code 400 in case of any error caused by client (query validation, invalid operation name, error in query reducer, etc.).</p>

<h3 id="custom-exceptionhandler">Custom ExceptionHandler</h3>

<p>When some unexpected error happens in the <code class="language-plaintext highlighter-rouge">resolve</code> function, sangria handles it according to the <a href="https://facebook.github.io/graphql/#sec-Errors">rules defined in the spec</a>.
If an exception implements the <code class="language-plaintext highlighter-rouge">UserFacingError</code> trait, then the error message would be visible in the response.
Otherwise the error message is obfuscated and the response will contain <code class="language-plaintext highlighter-rouge">"Internal server error"</code>.</p>

<p>In order to define custom error handling mechanisms, you need to provide an <code class="language-plaintext highlighter-rouge">ExceptionHandler</code> to <code class="language-plaintext highlighter-rouge">Executor</code>. Here is an example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">exceptionHandler</span> <span class="k">=</span> <span class="nc">ExceptionHandler</span> <span class="o">{</span>
  <span class="nf">case</span> <span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">e</span><span class="k">:</span> <span class="kt">IllegalStateException</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">HandledException</span><span class="o">(</span><span class="nv">e</span><span class="o">.</span><span class="py">getMessage</span><span class="o">)</span>
<span class="o">}</span>

<span class="nc">Executor</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">exceptionHandler</span> <span class="k">=</span> <span class="n">exceptionHandler</span><span class="o">).</span><span class="py">execute</span><span class="o">(</span><span class="n">doc</span><span class="o">)</span>
</code></pre></div></div>

<p>This example provides an error <code class="language-plaintext highlighter-rouge">message</code> (which would be shown instead of “Internal server error”).</p>

<p>You can also add additional fields in the error object like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">exceptionHandler</span> <span class="k">=</span> <span class="nc">ExceptionHandler</span> <span class="o">{</span>
  <span class="nf">case</span> <span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">e</span><span class="k">:</span> <span class="kt">IllegalStateException</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">HandledException</span><span class="o">(</span><span class="nv">e</span><span class="o">.</span><span class="py">getMessage</span><span class="o">,</span>
      <span class="nc">Map</span><span class="o">(</span>
      <span class="s">"foo"</span> <span class="o">-&gt;</span> <span class="nv">m</span><span class="o">.</span><span class="py">arrayNode</span><span class="o">(</span><span class="nc">Seq</span><span class="o">(</span>
        <span class="nv">m</span><span class="o">.</span><span class="py">scalarNode</span><span class="o">(</span><span class="s">"bar"</span><span class="o">,</span> <span class="s">"String"</span><span class="o">,</span> <span class="nv">Set</span><span class="o">.</span><span class="py">empty</span><span class="o">),</span>
        <span class="nv">m</span><span class="o">.</span><span class="py">scalarNode</span><span class="o">(</span><span class="s">"1234"</span><span class="o">,</span> <span class="s">"Int"</span><span class="o">,</span> <span class="nv">Set</span><span class="o">.</span><span class="py">empty</span><span class="o">))),</span>
      <span class="s">"baz"</span> <span class="o">-&gt;</span> <span class="nv">m</span><span class="o">.</span><span class="py">scalarNode</span><span class="o">(</span><span class="s">"Test"</span><span class="o">,</span> <span class="s">"String"</span><span class="o">,</span> <span class="nv">Set</span><span class="o">.</span><span class="py">empty</span><span class="o">)))</span>
<span class="o">}</span>
</code></pre></div></div>

<p>You can also provide a list of handled errors to <code class="language-plaintext highlighter-rouge">HandledException</code>. This will result in several error elements in the execution result.</p>

<p>In addition to handling errors coming from <code class="language-plaintext highlighter-rouge">resolve</code> function, <code class="language-plaintext highlighter-rouge">ExceptionHandler</code> also allows to handle <code class="language-plaintext highlighter-rouge">Violation</code>s and <code class="language-plaintext highlighter-rouge">UserFacingError</code>s:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">onException</code> - all unexpected exceptions coming from the <code class="language-plaintext highlighter-rouge">resolve</code> functions</li>
  <li><code class="language-plaintext highlighter-rouge">onViolation</code> - handles violations (things like validation errors, argument/variable coercion, etc.)</li>
  <li><code class="language-plaintext highlighter-rouge">onUserFacingError</code> - handles standard sangria errors (errors like invalid operation name, max query depth, etc.)</li>
</ul>

<p>Here is an example if handling a violation, changing the message and adding extra fields:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">exceptionHandler</span> <span class="k">=</span> <span class="nc">ExceptionHandler</span> <span class="o">(</span><span class="n">onViolation</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nf">case</span> <span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">v</span><span class="k">:</span> <span class="kt">UndefinedFieldViolation</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nc">HandledException</span><span class="o">(</span><span class="s">"Field is missing!!! D:"</span><span class="o">,</span>
      <span class="nc">Map</span><span class="o">(</span>
        <span class="s">"fieldName"</span> <span class="o">-&gt;</span> <span class="nv">m</span><span class="o">.</span><span class="py">scalarNode</span><span class="o">(</span><span class="nv">v</span><span class="o">.</span><span class="py">fieldName</span><span class="o">,</span> <span class="s">"String"</span><span class="o">,</span> <span class="nv">Set</span><span class="o">.</span><span class="py">empty</span><span class="o">),</span>
        <span class="s">"errorCode"</span> <span class="o">-&gt;</span> <span class="nv">m</span><span class="o">.</span><span class="py">scalarNode</span><span class="o">(</span><span class="s">"OOPS"</span><span class="o">,</span> <span class="s">"String"</span><span class="o">,</span> <span class="nv">Set</span><span class="o">.</span><span class="py">empty</span><span class="o">)))</span>
<span class="o">})</span>
</code></pre></div></div>

<h2 id="result-marshalling-and-input-unmarshalling">Result Marshalling and Input Unmarshalling</h2>

<p>GraphQL query execution needs to know how to serialize the result of execution and how to deserialize arguments/variables.
The specification itself does not define the data format, instead it uses abstract concepts like map and list.
Sangria does not hard-code the serialization mechanism. Instead it provides two traits for this:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ResultMarshaller</code> - knows how to serialize results of execution</li>
  <li><code class="language-plaintext highlighter-rouge">InputUnmarshaller[Node]</code> - knows how to deserialize the arguments/variables</li>
</ul>

<p>At the moment Sangria provides implementations for these libraries:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">sangria.marshalling.queryAst._</code> - native Query Value AST serialization</li>
  <li><code class="language-plaintext highlighter-rouge">sangria.marshalling.sprayJson._</code> - spray-json serialization
    <ul>
      <li><code class="language-plaintext highlighter-rouge">"org.sangria-graphql" %% "sangria-spray-json" % "1.0.2"</code></li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">sangria.marshalling.playJson._</code> - play-json serialization
    <ul>
      <li><code class="language-plaintext highlighter-rouge">"org.sangria-graphql" %% "sangria-play-json" % "2.0.1"</code></li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">sangria.marshalling.circe._</code> - circe serialization
    <ul>
      <li><code class="language-plaintext highlighter-rouge">"org.sangria-graphql" %% "sangria-circe" % "1.3.0"</code></li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">sangria.marshalling.argonaut._</code> - argonaut serialization
    <ul>
      <li><code class="language-plaintext highlighter-rouge">"org.sangria-graphql" %% "sangria-argonaut" % "1.0.1"</code></li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">sangria.marshalling.json4s.native._</code> - json4s-native serialization
    <ul>
      <li><code class="language-plaintext highlighter-rouge">"org.sangria-graphql" %% "sangria-json4s-native" % "1.0.1"</code></li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">sangria.marshalling.json4s.jackson._</code> - json4s-jackson serialization
    <ul>
      <li><code class="language-plaintext highlighter-rouge">"org.sangria-graphql" %% "sangria-json4s-jackson" % "1.0.1"</code></li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">sangria.marshalling.msgpack._</code> - <a href="http://msgpack.org/">MessagePack</a> serialization
    <ul>
      <li><code class="language-plaintext highlighter-rouge">"org.sangria-graphql" %% "sangria-msgpack" % "2.0.0"</code></li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">sangria.marshalling.ion._</code> - <a href="http://amznlabs.github.io/ion-docs/index.html">Amazon Ion</a> serialization
    <ul>
      <li><code class="language-plaintext highlighter-rouge">"org.sangria-graphql" %% "sangria-ion" % "2.0.0"</code></li>
    </ul>
  </li>
</ul>

<p>In order to use one of these, just import it and the result of execution will be of the correct type:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sangria.marshalling.sprayJson._</span>

<span class="k">val</span> <span class="nv">result</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="nv">TestSchema</span><span class="o">.</span><span class="py">StarWarsSchema</span><span class="o">,</span> <span class="n">queryAst</span><span class="o">,</span>
  <span class="n">variables</span> <span class="k">=</span> <span class="n">vars</span>
  <span class="n">userContext</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CharacterRepo</span><span class="o">,</span>
  <span class="n">deferredResolver</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">FriendsResolver</span><span class="o">)</span>
</code></pre></div></div>

<h3 id="toinput-type-class">ToInput Type-Class</h3>

<p>Default values should now have an instance of the <code class="language-plaintext highlighter-rouge">ToInput</code> type-class which is defined for all supported input types like Scala map-like data structures, different JSON ASTs, etc. It even supports things like <code class="language-plaintext highlighter-rouge">Writes</code> from play-json or <code class="language-plaintext highlighter-rouge">JsonFormat</code> from spray-json by default. This means that you can use your domain objects (like <code class="language-plaintext highlighter-rouge">User</code> or <code class="language-plaintext highlighter-rouge">Apple</code>) as a default value for input fields or arguments as long as you have <code class="language-plaintext highlighter-rouge">Writes</code> or <code class="language-plaintext highlighter-rouge">JsonFormat</code> defined for them.</p>

<p>The mechanism is very extensible: you just need to define an implicit <code class="language-plaintext highlighter-rouge">ToInput[T]</code> for a class you want to use as a default value.</p>

<h3 id="frominput-type-class">FromInput Type-Class</h3>

<p><code class="language-plaintext highlighter-rouge">FromInput</code> provides high-level and low-level ways to deserialize arbitrary input objects, just like <code class="language-plaintext highlighter-rouge">ToInput</code>.</p>

<p>In order to use this feature, you need to provide a type parameter to the <code class="language-plaintext highlighter-rouge">InputObjectType</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Article</span><span class="o">(</span><span class="n">title</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">text</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>

<span class="k">val</span> <span class="nv">ArticleType</span><span class="k">:</span> <span class="kt">InputObjectType</span><span class="o">[</span><span class="kt">Article</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">InputObjectType</span><span class="o">[</span><span class="kt">Article</span><span class="o">](</span><span class="s">"Article"</span><span class="o">,</span> <span class="nc">List</span><span class="o">(</span>
    <span class="nc">InputField</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">),</span>
    <span class="nc">InputField</span><span class="o">(</span><span class="s">"text"</span><span class="o">,</span> <span class="nc">OptionInputType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">))</span>
  <span class="o">))</span>

<span class="k">val</span> <span class="nv">arg</span><span class="k">:</span> <span class="kt">Argument</span><span class="o">[</span><span class="kt">Article</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Argument</span><span class="o">[</span><span class="kt">Article</span> <span class="kt">@@</span> <span class="kt">InputObjectResult</span><span class="o">](</span><span class="s">"article"</span><span class="o">,</span> <span class="nc">ArticleType</span><span class="o">)</span>
</code></pre></div></div>

<p>This code will not compile unless you define an implicit instance of <code class="language-plaintext highlighter-rouge">FromInput</code> for the <code class="language-plaintext highlighter-rouge">Article</code> case class:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">implicit</span> <span class="k">val</span> <span class="nv">manual</span><span class="k">:</span> <span class="kt">FromInput</span><span class="o">[</span><span class="kt">Article</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">FromInput</span><span class="o">[</span><span class="kt">Article</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">marshaller</span> <span class="k">=</span> <span class="nv">CoercedScalaResultMarshaller</span><span class="o">.</span><span class="py">default</span>
  <span class="k">def</span> <span class="nf">fromResult</span><span class="o">(</span><span class="n">node</span><span class="k">:</span> <span class="kt">marshaller.Node</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">ad</span> <span class="k">=</span> <span class="nv">node</span><span class="o">.</span><span class="py">asInstanceOf</span><span class="o">[</span><span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Any</span><span class="o">]]</span>

    <span class="nc">Article</span><span class="o">(</span>
      <span class="n">title</span> <span class="k">=</span> <span class="nf">ad</span><span class="o">(</span><span class="s">"title"</span><span class="o">).</span><span class="py">asInstanceOf</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span>
      <span class="n">text</span> <span class="k">=</span> <span class="nv">ad</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="s">"text"</span><span class="o">).</span><span class="py">flatMap</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">asInstanceOf</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]])</span>
    <span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>As you can see, you need to provide a <code class="language-plaintext highlighter-rouge">ResultMarshaller</code> for the desired format and then use a marshaled value to create a domain object based on it. Many instances of <code class="language-plaintext highlighter-rouge">FromInput</code> are already provided out-of-the-box. For instance <code class="language-plaintext highlighter-rouge">FromInput[Map[String, Any]]</code> supports map-like data-structure format. All supported JSON libraries also provide <code class="language-plaintext highlighter-rouge">FromInput[JsValue]</code> so that you can use JSON AST instead of working with <code class="language-plaintext highlighter-rouge">Map[String, Any]</code>.</p>

<p>Moreover, libraries like sangria-play-json and sangria-spray-json already provide support for codecs like <code class="language-plaintext highlighter-rouge">Reads</code> and <code class="language-plaintext highlighter-rouge">JsonFormat</code>.
This means that your domain objects are automatically supported as long as you have <code class="language-plaintext highlighter-rouge">Reads</code> or <code class="language-plaintext highlighter-rouge">JsonFormat</code> defined for them.
For instance, this example should compile and work just fine without an explicit <code class="language-plaintext highlighter-rouge">FromInput</code> declaration:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sangria.marshalling.playJson._</span>
<span class="k">import</span> <span class="nn">play.api.libs.json._</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Article</span><span class="o">(</span><span class="n">title</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">text</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">articleFormat</span> <span class="k">=</span> <span class="nv">Json</span><span class="o">.</span><span class="py">format</span><span class="o">[</span><span class="kt">Article</span><span class="o">]</span>

<span class="k">val</span> <span class="nv">ArticleType</span><span class="k">:</span> <span class="kt">InputObjectType</span><span class="o">[</span><span class="kt">Article</span><span class="o">]</span> <span class="k">=</span> <span class="nc">InputObjectType</span><span class="o">[</span><span class="kt">Article</span><span class="o">](</span><span class="s">"Article"</span><span class="o">,</span> <span class="nc">List</span><span class="o">(</span>
  <span class="nc">InputField</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">),</span>
  <span class="nc">InputField</span><span class="o">(</span><span class="s">"text"</span><span class="o">,</span> <span class="nc">OptionInputType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">))))</span>

<span class="k">val</span> <span class="nv">arg</span><span class="k">:</span> <span class="kt">Argument</span><span class="o">[</span><span class="kt">Article</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Argument</span><span class="o">[</span><span class="kt">Article</span> <span class="kt">@@</span> <span class="kt">InputObjectResult</span><span class="o">](</span><span class="s">"article"</span><span class="o">,</span> <span class="nc">ArticleType</span><span class="o">)</span>
</code></pre></div></div>

<h3 id="query-ast-marshalling">Query AST Marshalling</h3>

<p>A subset of GraphQL grammar that handles input object is also available as a standalone feature. You can read more about it in a following blog post:</p>

<p><a href="https://medium.com/@oleg.ilyenko/graphql-object-notation-8f56194556ea">GraphQL Object Notation</a></p>

<p>This feature allows you to parse and render any <code class="language-plaintext highlighter-rouge">ast.Value</code> independently from GraphQL query. You can also use <code class="language-plaintext highlighter-rouge">graphqlInput</code> macros for this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sangria.renderer.QueryRenderer</span>
<span class="k">import</span> <span class="nn">sangria.macros._</span>
<span class="k">import</span> <span class="nn">sangria.ast</span>

<span class="k">val</span> <span class="nv">parsed</span><span class="k">:</span> <span class="kt">ast.Value</span> <span class="o">=</span>
  <span class="n">graphqlInput</span><span class="s">"""
    {
      id: "1234345"
      version: 2 # changed 2 times
      deliveries: [
        {id: 123, received: false, note: null, state: OPEN}
      ]
    }
  """</span>

<span class="k">val</span> <span class="nv">rendered</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span>
  <span class="nv">QueryRenderer</span><span class="o">.</span><span class="py">render</span><span class="o">(</span><span class="n">parsed</span><span class="o">,</span> <span class="nv">QueryRenderer</span><span class="o">.</span><span class="py">PrettyInput</span><span class="o">)</span>

<span class="nf">println</span><span class="o">(</span><span class="n">rendered</span><span class="o">)</span>
</code></pre></div></div>

<p>It will produce the following output:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="nl">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1234345</span><span class="dl">"</span>
  <span class="nx">version</span><span class="p">:</span> <span class="mi">2</span>
  <span class="nx">deliveries</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">123</span>
    <span class="na">received</span><span class="p">:</span> <span class="kc">false</span>
    <span class="na">note</span><span class="p">:</span> <span class="kc">null</span>
    <span class="na">state</span><span class="p">:</span> <span class="nx">OPEN</span>
  <span class="p">}]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Proper <code class="language-plaintext highlighter-rouge">InputUnmarshaller</code> and <code class="language-plaintext highlighter-rouge">ResultMarshaller</code> are available for it, so you can use <code class="language-plaintext highlighter-rouge">ast.Value</code> as a variable or as a result
of GraphQL query execution.</p>

<p>In addition to parsing, you can also deserialize an <code class="language-plaintext highlighter-rouge">InputDocument</code> based on the <code class="language-plaintext highlighter-rouge">FromInput</code> type class. Here is an example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Comment</span><span class="o">(</span><span class="n">author</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">text</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Article</span><span class="o">(</span><span class="n">title</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">text</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">tags</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">String</span><span class="o">]],</span> <span class="n">comments</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Comment</span><span class="o">]])</span>

<span class="k">val</span> <span class="nv">ArticleType</span><span class="k">:</span> <span class="kt">InputObjectType</span><span class="o">[</span><span class="kt">Article</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>

<span class="k">val</span> <span class="nv">document</span> <span class="k">=</span> <span class="nv">QueryParser</span><span class="o">.</span><span class="py">parseInputDocumentWithVariables</span><span class="o">(</span>
  <span class="s">"""
    {
      title: "foo",
      tags: null,
      comments: []
    }

    {
      title: "Article 2",
      text: "contents 2",
      tags: ["spring", "guitars"],
      comments: [{
        author: "Me"
        text: $comm
      }]
    }
  """</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">vars</span> <span class="k">=</span> <span class="nf">scalaInput</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span>
  <span class="s">"comm"</span> <span class="o">-&gt;</span> <span class="s">"from variable"</span>
<span class="o">))</span>

<span class="k">val</span> <span class="nv">articles</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Article</span><span class="o">]</span> <span class="k">=</span> <span class="nv">document</span><span class="o">.</span><span class="py">to</span><span class="o">(</span><span class="nc">ArticleType</span><span class="o">,</span> <span class="n">vars</span><span class="o">)</span>
</code></pre></div></div>

<p>as a result of this deserialization, you will get following list of <code class="language-plaintext highlighter-rouge">articles</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Vector</span><span class="o">(</span>
  <span class="nc">Article</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">"Hello World!"</span><span class="o">),</span> <span class="nc">None</span><span class="o">,</span> <span class="nv">Vector</span><span class="o">.</span><span class="py">empty</span><span class="o">),</span>
  <span class="nc">Article</span><span class="o">(</span><span class="s">"Article 2"</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">"contents 2"</span><span class="o">),</span>
    <span class="nc">Some</span><span class="o">(</span><span class="nc">Vector</span><span class="o">(</span><span class="s">"spring"</span><span class="o">,</span> <span class="s">"guitars"</span><span class="o">)),</span>
    <span class="nc">Vector</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="nc">Comment</span><span class="o">(</span><span class="s">"Me"</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">"from variable"</span><span class="o">))))))</span>
</code></pre></div></div>

<h3 id="converting-between-formats">Converting Between Formats</h3>

<p>As a natural extension of <code class="language-plaintext highlighter-rouge">ResultMarshaller</code> and <code class="language-plaintext highlighter-rouge">InputUnmarshaller</code> abstractions, sangria allows you to convert between different formats at will.</p>

<p>Here is, for instance, how you can convert circe <code class="language-plaintext highlighter-rouge">Json</code> into sprayJson <code class="language-plaintext highlighter-rouge">JsValue</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sangria.marshalling.circe._</span>
<span class="k">import</span> <span class="nn">sangria.marshalling.sprayJson._</span>
<span class="k">import</span> <span class="nn">sangria.marshalling.MarshallingUtil._</span>

<span class="k">val</span> <span class="nv">circeJson</span> <span class="k">=</span> <span class="nv">Json</span><span class="o">.</span><span class="py">array</span><span class="o">(</span>
  <span class="nv">Json</span><span class="o">.</span><span class="py">empty</span><span class="o">,</span>
  <span class="nv">Json</span><span class="o">.</span><span class="py">int</span><span class="o">(</span><span class="mi">123</span><span class="o">),</span>
  <span class="nv">Json</span><span class="o">.</span><span class="py">array</span><span class="o">(</span><span class="nv">Json</span><span class="o">.</span><span class="py">obj</span><span class="o">(</span><span class="s">"foo"</span> <span class="o">-&gt;</span> <span class="nv">Json</span><span class="o">.</span><span class="py">string</span><span class="o">(</span><span class="s">"bar"</span><span class="o">))))</span>

<span class="k">val</span> <span class="nv">sprayJson</span> <span class="k">=</span> <span class="nv">circeJson</span><span class="o">.</span><span class="py">convertMarshaled</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">]</span>
</code></pre></div></div>

<h3 id="marshalling-api--testkit">Marshalling API &amp; Testkit</h3>

<p>If your favorite library is not supported yet, then it’s pretty easy to create an integration library yourself. All marshalling libraries depend on and implement <code class="language-plaintext highlighter-rouge">sangria-marshalling-api</code>. You can include it together with the testkit like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
  <span class="s">"org.sangria-graphql"</span> <span class="o">%%</span> <span class="s">"sangria-marshalling-api"</span> <span class="o">%</span> <span class="s">"1.0.4"</span><span class="o">,</span>
  <span class="s">"org.sangria-graphql"</span> <span class="o">%%</span> <span class="s">"sangria-marshalling-testkit"</span> <span class="o">%</span> <span class="s">"1.0.3"</span> <span class="o">%</span> <span class="s">"test"</span><span class="o">)</span>
</code></pre></div></div>

<p>After you implemented the actual integration code, you test whether it’s semantically correct with the help of a testkit. Testkit provides a set of ScalaTest-based tests to verify an implementation of marshalling library (so that you don’t need to write tests yourself). Here is an example from spray-json integration library that uses a testkit tests:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SprayJsonSupportSpec</span> <span class="k">extends</span> <span class="nc">WordSpec</span>
                              <span class="k">with</span> <span class="nc">Matchers</span>
                              <span class="k">with</span> <span class="nc">MarshallingBehaviour</span>
                              <span class="k">with</span> <span class="nc">InputHandlingBehaviour</span>
                              <span class="k">with</span> <span class="nc">ParsingBehaviour</span> <span class="o">{</span>

  <span class="k">object</span> <span class="nc">JsonProtocol</span> <span class="k">extends</span> <span class="nc">DefaultJsonProtocol</span> <span class="o">{</span>
    <span class="k">implicit</span> <span class="k">val</span> <span class="nv">commentFormat</span> <span class="k">=</span> <span class="nf">jsonFormat2</span><span class="o">(</span><span class="nv">Comment</span><span class="o">.</span><span class="py">apply</span><span class="o">)</span>
    <span class="k">implicit</span> <span class="k">val</span> <span class="nv">articleFormat</span> <span class="k">=</span> <span class="nf">jsonFormat4</span><span class="o">(</span><span class="nv">Article</span><span class="o">.</span><span class="py">apply</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="s">"SprayJson integration"</span> <span class="n">should</span> <span class="o">{</span>
    <span class="k">import</span> <span class="nn">JsonProtocol._</span>

    <span class="n">behave</span> <span class="n">like</span> <span class="n">`value (un)marshaller`</span><span class="o">(</span><span class="nc">SprayJsonResultMarshaller</span><span class="o">)</span>

    <span class="n">behave</span> <span class="n">like</span> <span class="n">`AST-based input unmarshaller`</span><span class="o">(</span><span class="n">sprayJsonFromInput</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">])</span>
    <span class="n">behave</span> <span class="n">like</span> <span class="n">`AST-based input marshaller`</span><span class="o">(</span><span class="nc">SprayJsonResultMarshaller</span><span class="o">)</span>

    <span class="n">behave</span> <span class="n">like</span> <span class="n">`case class input unmarshaller`</span>
    <span class="n">behave</span> <span class="n">like</span> <span class="n">`case class input marshaller`</span><span class="o">(</span><span class="nc">SprayJsonResultMarshaller</span><span class="o">)</span>

    <span class="n">behave</span> <span class="n">like</span> <span class="n">`input parser`</span><span class="o">(</span><span class="nc">ParseTestSubjects</span><span class="o">(</span>
      <span class="n">complex</span> <span class="k">=</span> <span class="s">"""{"a": [null, 123, [{"foo": "bar"}]], "b": {"c": true, "d": null}}"""</span><span class="o">,</span>
      <span class="n">simpleString</span> <span class="k">=</span> <span class="s">"\"bar\""</span><span class="o">,</span>
      <span class="n">simpleInt</span> <span class="k">=</span> <span class="s">"12345"</span><span class="o">,</span>
      <span class="n">simpleNull</span> <span class="k">=</span> <span class="s">"null"</span><span class="o">,</span>
      <span class="n">list</span> <span class="k">=</span> <span class="s">"[\"bar\", 1, null, true, [1, 2, 3]]"</span><span class="o">,</span>
      <span class="n">syntaxError</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">"[123, FOO BAR"</span><span class="o">)</span>
    <span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="middleware">Middleware</h2>

<p>Sangria supports generic middleware that can be used for different purposes, like performance measurement, metrics collection, security enforcement, etc. on a field and query level.
Moreover it makes it much easier for people to share standard middleware in libraries. Middleware allows you to define callbacks before/after query and field.</p>

<p>Here is a small example of its usage:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FieldMetrics</span> <span class="k">extends</span> <span class="nc">Middleware</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span> <span class="k">with</span> <span class="nc">MiddlewareAfterField</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span> <span class="k">with</span> <span class="nc">MiddlewareErrorField</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">type</span> <span class="kt">QueryVal</span> <span class="o">=</span> <span class="nc">TrieMap</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span>
  <span class="k">type</span> <span class="kt">FieldVal</span> <span class="o">=</span> <span class="nc">Long</span>

  <span class="k">def</span> <span class="nf">beforeQuery</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span> <span class="nc">TrieMap</span><span class="o">()</span>
  <span class="k">def</span> <span class="nf">afterQuery</span><span class="o">(</span><span class="n">queryVal</span><span class="k">:</span> <span class="kt">QueryVal</span><span class="o">,</span> <span class="n">context</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span>
    <span class="nf">reportQueryMetrics</span><span class="o">(</span><span class="n">queryVal</span><span class="o">)</span>

  <span class="k">def</span> <span class="nf">beforeField</span><span class="o">(</span><span class="n">queryVal</span><span class="k">:</span> <span class="kt">QueryVal</span><span class="o">,</span> <span class="n">mctx</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">],</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">Context</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span>
    <span class="nf">continue</span><span class="o">(</span><span class="nv">System</span><span class="o">.</span><span class="py">currentTimeMillis</span><span class="o">())</span>

  <span class="k">def</span> <span class="nf">afterField</span><span class="o">(</span><span class="n">queryVal</span><span class="k">:</span> <span class="kt">QueryVal</span><span class="o">,</span> <span class="n">fieldVal</span><span class="k">:</span> <span class="kt">FieldVal</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Any</span><span class="o">,</span> <span class="n">mctx</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">],</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">Context</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">key</span> <span class="k">=</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">parentType</span><span class="o">.</span><span class="py">name</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">field</span><span class="o">.</span><span class="py">name</span>
    <span class="k">val</span> <span class="nv">list</span> <span class="k">=</span> <span class="nv">queryVal</span><span class="o">.</span><span class="py">getOrElse</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="nc">Nil</span><span class="o">)</span>

    <span class="nv">queryVal</span><span class="o">.</span><span class="py">update</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">list</span> <span class="o">:+</span> <span class="o">(</span><span class="nv">System</span><span class="o">.</span><span class="py">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">fieldVal</span><span class="o">))</span>
    <span class="nc">None</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">fieldError</span><span class="o">(</span><span class="n">queryVal</span><span class="k">:</span> <span class="kt">QueryVal</span><span class="o">,</span> <span class="n">fieldVal</span><span class="k">:</span> <span class="kt">FieldVal</span><span class="o">,</span> <span class="n">error</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">,</span> <span class="n">mctx</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">],</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">Context</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">key</span> <span class="k">=</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">parentType</span><span class="o">.</span><span class="py">name</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">field</span><span class="o">.</span><span class="py">name</span>
    <span class="k">val</span> <span class="nv">list</span> <span class="k">=</span> <span class="nv">queryVal</span><span class="o">.</span><span class="py">getOrElse</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="nc">Nil</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">errors</span> <span class="k">=</span> <span class="nv">queryVal</span><span class="o">.</span><span class="py">getOrElse</span><span class="o">(</span><span class="s">"ERROR"</span><span class="o">,</span> <span class="nc">Nil</span><span class="o">)</span>

    <span class="nv">queryVal</span><span class="o">.</span><span class="py">update</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">list</span> <span class="o">:+</span> <span class="o">(</span><span class="nv">System</span><span class="o">.</span><span class="py">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">fieldVal</span><span class="o">))</span>
    <span class="nv">queryVal</span><span class="o">.</span><span class="py">update</span><span class="o">(</span><span class="s">"ERROR"</span><span class="o">,</span> <span class="n">errors</span> <span class="o">:+</span> <span class="mi">1L</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">result</span> <span class="k">=</span> <span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="n">middleware</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">FieldMetrics</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
</code></pre></div></div>

<p>It will record the execution time of all fields in a query and then report it in some way.</p>

<p>Middleware supports 2 types state that you can use within a middleware instance:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QueryVal</code> - an instance of this type is create at the beginning of the query execution and then propagated to all other middleware methods</li>
  <li><code class="language-plaintext highlighter-rouge">FieldVal</code> - an instance of this type may be returned from <code class="language-plaintext highlighter-rouge">beforeField</code> and will be given as a argument to <code class="language-plaintext highlighter-rouge">afterField</code> and <code class="language-plaintext highlighter-rouge">fieldError</code> for the same field.</li>
</ul>

<p>These two types of state provide a way to avoid shared mutable state in case some intermediate value need to be propagated between different
methods of middleware.</p>

<p><code class="language-plaintext highlighter-rouge">afterField</code> also allows you to transform field values by returning <code class="language-plaintext highlighter-rouge">Some</code> with a transformed value. You can also throw an exception from <code class="language-plaintext highlighter-rouge">beforeField</code> or <code class="language-plaintext highlighter-rouge">afterField</code>
in order to indicate a field error.</p>

<p><code class="language-plaintext highlighter-rouge">beforeField</code> returns <code class="language-plaintext highlighter-rouge">BeforeFieldResult</code> which allows you to add a <code class="language-plaintext highlighter-rouge">MiddlewareAttachment</code>.
This attachment then can be used in resolve function via <code class="language-plaintext highlighter-rouge">Context.attachment</code>/<code class="language-plaintext highlighter-rouge">Context.attachments</code>.</p>

<p>In case several middleware objects are defined for the same execution, <code class="language-plaintext highlighter-rouge">beforeField</code> would be called in the order middleware is defined.
<code class="language-plaintext highlighter-rouge">afterField</code>, on the other hand, would be call in reverse order. To demonstrate this, let’s look at this middleware as an example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Suffixer</span><span class="o">(</span><span class="n">suffix</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Middleware</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span> <span class="k">with</span> <span class="nc">MiddlewareAfterField</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span> <span class="o">{</span>
 <span class="k">type</span> <span class="kt">QueryVal</span> <span class="o">=</span> <span class="nc">Unit</span>
 <span class="k">type</span> <span class="kt">FieldVal</span> <span class="o">=</span> <span class="nc">Unit</span>

 <span class="k">def</span> <span class="nf">beforeQuery</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span> <span class="o">()</span>
 <span class="k">def</span> <span class="nf">afterQuery</span><span class="o">(</span><span class="n">queryVal</span><span class="k">:</span> <span class="kt">QueryVal</span><span class="o">,</span> <span class="n">context</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span> <span class="o">()</span>
 <span class="k">def</span> <span class="nf">beforeField</span><span class="o">(</span><span class="n">cache</span><span class="k">:</span> <span class="kt">QueryVal</span><span class="o">,</span> <span class="n">mctx</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">],</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">Context</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span> <span class="n">continue</span>

 <span class="k">def</span> <span class="nf">afterField</span><span class="o">(</span><span class="n">cache</span><span class="k">:</span> <span class="kt">QueryVal</span><span class="o">,</span> <span class="n">fromCache</span><span class="k">:</span> <span class="kt">FieldVal</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Any</span><span class="o">,</span> <span class="n">mctx</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">],</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">Context</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span>
   <span class="n">value</span> <span class="k">match</span> <span class="o">{</span>
     <span class="k">case</span> <span class="n">s</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">suffix</span><span class="o">)</span>
     <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>it just adds a suffix to a string. When some field in a schema returns value <code class="language-plaintext highlighter-rouge">"v"</code> and we execute query like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="n">middleware</span> <span class="k">=</span> <span class="nc">Suffixer</span><span class="o">(</span><span class="s">" s1"</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Suffixer</span><span class="o">(</span><span class="s">" s2"</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
</code></pre></div></div>

<p>Then the result would be <code class="language-plaintext highlighter-rouge">"v s2 s1"</code>. Here is diagram that shows how different middleware methods are called:</p>

<p><img src="/assets/img/middleware.svg" alt="Middleware execution order" /></p>

<p>In order to ensure generic classification of fields, every field contains a generic list or <code class="language-plaintext highlighter-rouge">FieldTag</code>s which provides a user-defined
meta-information about this field (just to highlight a few examples: <code class="language-plaintext highlighter-rouge">Permission("ViewOrders")</code>, <code class="language-plaintext highlighter-rouge">Authorized</code>, <code class="language-plaintext highlighter-rouge">Measured</code>, <code class="language-plaintext highlighter-rouge">Cached</code>, etc.).
You can find another example of <code class="language-plaintext highlighter-rouge">FieldTag</code> and <code class="language-plaintext highlighter-rouge">Middleware</code> usage in <a href="#authentication-and-authorisation">Authentication and Authorisation</a> section.</p>

<h3 id="middleware-extensions">Middleware Extensions</h3>

<p>GraphQL spec allows <a href="https://facebook.github.io/graphql/#sec-Response-Format">free-form extensions</a> to be added in the GraphQL response.
These are quite useful for things like debug and profiling information, for example. Sangria provides a special middleware trait
<code class="language-plaintext highlighter-rouge">MiddlewareExtension</code> which provides an easy way for <code class="language-plaintext highlighter-rouge">Middleware</code> to add extensions in the GraphQL response.</p>

<p>Here is an example of a very simple middleware that adds a formatted query in the response:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Formatted</span> <span class="k">extends</span> <span class="nc">Middleware</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span> <span class="k">with</span> <span class="nc">MiddlewareExtension</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">type</span> <span class="kt">QueryVal</span> <span class="o">=</span> <span class="nc">Unit</span>
  <span class="k">def</span> <span class="nf">beforeQuery</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span> <span class="o">()</span>
  <span class="k">def</span> <span class="nf">afterQuery</span><span class="o">(</span><span class="n">queryVal</span><span class="k">:</span> <span class="kt">QueryVal</span><span class="o">,</span> <span class="n">context</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span> <span class="o">()</span>

  <span class="k">def</span> <span class="nf">afterQueryExtensions</span><span class="o">(</span>
    <span class="n">queryVal</span><span class="k">:</span> <span class="kt">QueryVal</span><span class="o">,</span>
    <span class="n">context</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">Any</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">]</span>
  <span class="o">)</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Extension</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">import</span> <span class="nn">sangria.marshalling.queryAst._</span>

    <span class="nc">Vector</span><span class="o">(</span><span class="nc">Extension</span><span class="o">(</span>
      <span class="nc">ObjectValue</span><span class="o">(</span><span class="nc">Vector</span><span class="o">(</span>
        <span class="nc">ObjectField</span><span class="o">(</span><span class="s">"formattedQuery"</span><span class="o">,</span>
          <span class="nc">StringValue</span><span class="o">(</span><span class="nv">context</span><span class="o">.</span><span class="py">queryAst</span><span class="o">.</span><span class="py">renderPretty</span><span class="o">))))</span><span class="k">:</span> <span class="kt">Value</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now you can use it by just adding it in the list of middleware during the execution:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="n">middleware</span> <span class="k">=</span> <span class="nc">Formatted</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
</code></pre></div></div>

<p>Here is an example of execution result JSON:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"human"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Luke Skywalker"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"extensions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"formattedQuery"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{</span><span class="se">\n</span><span class="s2">  human(id: </span><span class="se">\"</span><span class="s2">1000</span><span class="se">\"</span><span class="s2">) {</span><span class="se">\n</span><span class="s2">    name</span><span class="se">\n</span><span class="s2">  }</span><span class="se">\n</span><span class="s2">}"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="profiling-graphql-query-execution">Profiling GraphQL Query Execution</h3>

<p>With middleware, Sangria provides a very convenient way to instrument GraphQL query execution and introduce profiling logic. Out-of-the-box
Sangria provides a simple mechanism to log slow queries and show profiling information. To use it, your need to add <code class="language-plaintext highlighter-rouge">sangria-slowlog</code> dependency:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"org.sangria-graphql"</span> <span class="o">%%</span> <span class="s">"sangria-slowlog"</span> <span class="o">%</span> <span class="s">"3.0.0"</span>
</code></pre></div></div>

<p>Library provides a middleware that logs instrumented query information if execution exceeds specific threshold. An example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">sangria.slowlog.SlowLog</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span>
  <span class="n">middleware</span> <span class="k">=</span> <span class="nc">SlowLog</span><span class="o">(</span><span class="n">logger</span><span class="o">,</span> <span class="n">threshold</span> <span class="k">=</span> <span class="mi">10</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
</code></pre></div></div>

<p>If query execution takes more than 10 seconds to execute, then you will see similar info in the logs:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [Execution Metrics] duration: 12362ms, validation: 0ms, reducers: 0ms</span>
<span class="c">#</span>
<span class="c"># $id = "1000"</span>
query Test<span class="o">(</span><span class="nv">$id</span>: String!<span class="o">)</span> <span class="o">{</span>
  <span class="c"># [Query] count: 1, time: 2ms</span>
  <span class="c">#</span>
  <span class="c"># $id = "1000"</span>
  human<span class="o">(</span><span class="nb">id</span>: <span class="nv">$id</span><span class="o">)</span> <span class="o">{</span>
    <span class="c"># [Human] count: 1, time: 0ms</span>
    name

    <span class="c"># [Human] count: 1, time: 11916ms</span>
    appearsIn

    <span class="c"># [Human] count: 1, time: 358ms</span>
    friends <span class="o">{</span>
      <span class="c"># [Droid] count: 2, min: 0ms, max: 0ms, mean: 0ms, p75: 0ms, p95: 0ms, p99: 0ms</span>
      <span class="c"># [Human] count: 2, min: 0ms, max: 0ms, mean: 0ms, p75: 0ms, p95: 0ms, p99: 0ms</span>
      name
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">sangria-slowlog</code> has full support for GraphQL fragments and polymorphic types, so you will always see metrics for concrete types.</p>

<p>In addition to logging, <code class="language-plaintext highlighter-rouge">sangria-slowlog</code> also supports graphql extensions. Extensions will add a profiling info in the response under
<code class="language-plaintext highlighter-rouge">extensions</code> top-level field. In the most basic form, you can use it like this (this approach also disables the logging):</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="n">middleware</span> <span class="k">=</span> <span class="nv">SlowLog</span><span class="o">.</span><span class="py">extension</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
</code></pre></div></div>

<p>After middleware is added, you will see following JSON in the response:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"human"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Luke Skywalker"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"appearsIn"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"NEWHOPE"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EMPIRE"</span><span class="p">,</span><span class="w"> </span><span class="s2">"JEDI"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"friends"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Han Solo"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Leia Organa"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"C-3PO"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"R2-D2"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"extensions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"metrics"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"executionMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">362</span><span class="p">,</span><span class="w">
      </span><span class="nl">"validationMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"reducersMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"# [Execution Metrics] duration: 362ms, validation: 0ms, reducers: 0ms</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2"># $id = </span><span class="se">\"</span><span class="s2">1000</span><span class="se">\"\n</span><span class="s2">query Test($id: String!) {</span><span class="se">\n</span><span class="s2">  # [Query] count: 1, time: 2ms</span><span class="se">\n</span><span class="s2">  #</span><span class="se">\n</span><span class="s2">  # $id = </span><span class="se">\"</span><span class="s2">1000</span><span class="se">\"\n</span><span class="s2">  human(id: $id) {</span><span class="se">\n</span><span class="s2">    # [Human] count: 1, time: 0ms</span><span class="se">\n</span><span class="s2">    name</span><span class="se">\n\n</span><span class="s2">    # [Human] count: 1, time: 216ms</span><span class="se">\n</span><span class="s2">    appearsIn</span><span class="se">\n\n</span><span class="s2">    # [Human] count: 1, time: 358ms</span><span class="se">\n</span><span class="s2">    friends {</span><span class="se">\n</span><span class="s2">      # [Droid] count: 2, min: 0ms, max: 0ms, mean: 0ms, p75: 0ms, p95: 0ms, p99: 0ms</span><span class="se">\n</span><span class="s2">      # [Human] count: 2, min: 0ms, max: 0ms, mean: 0ms, p75: 0ms, p95: 0ms, p99: 0ms</span><span class="se">\n</span><span class="s2">      name</span><span class="se">\n</span><span class="s2">    }</span><span class="se">\n</span><span class="s2">  }</span><span class="se">\n</span><span class="s2">}"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"types"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Human"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"friends"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"minMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">358</span><span class="p">,</span><span class="w">
            </span><span class="nl">"maxMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">358</span><span class="p">,</span><span class="w">
            </span><span class="nl">"meanMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">358</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p75Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">358</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p95Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">358</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p99Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">358</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"appearsIn"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"minMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">216</span><span class="p">,</span><span class="w">
            </span><span class="nl">"maxMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">216</span><span class="p">,</span><span class="w">
            </span><span class="nl">"meanMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">216</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p75Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">216</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p95Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">216</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p99Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">216</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
            </span><span class="nl">"minMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"maxMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"meanMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p75Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p95Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p99Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"Query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"human"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"minMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"maxMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"meanMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p75Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p95Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p99Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"Droid"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"minMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"maxMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"meanMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p75Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p95Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"p99Ms"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>All <code class="language-plaintext highlighter-rouge">SlowLog</code> methods accept <code class="language-plaintext highlighter-rouge">addExtentions</code> argument which allows you to include these extensions along the way.</p>

<p>With a small tweaking, you can also include “Profile” button in GraphiQL. On the server you just need to conditionally include
<code class="language-plaintext highlighter-rouge">SlowLog.extension</code> middleware to make it work. Here is an example of how this integration might look like:</p>

<div class="video">
  <iframe width="561" height="315" src="https://www.youtube.com/embed/OMa3SXC2mjA" frameborder="0" allowfullscreen=""></iframe>
  <div class="video-description">
    <span class="video-title">Example of interactive GraphQL profiling</span>
  </div>
</div>

<h2 id="query-reducers">Query Reducers</h2>

<p>Sometimes it can be helpful to perform some analysis on a query before executing it. An example is complexity analysis: it aggregates the complexity
of all fields in the query and then rejects the query without executing it if complexity is too high. Another example is gathering all <code class="language-plaintext highlighter-rouge">Permission</code>
field tags and then fetching extra user auth data from an external service if query contains protected fields. This need to be done before the query
starts to execute.</p>

<p>Sangria provides a mechanism for this kind of query analysis with <code class="language-plaintext highlighter-rouge">QueryReducer</code>. The query reducer implementation will go through all of the fields
in the query and aggregate them to a single value. <code class="language-plaintext highlighter-rouge">Executor</code> will then call <code class="language-plaintext highlighter-rouge">reduceCtx</code> with this aggregated value which gives you an
opportunity to perform some logic and update the <code class="language-plaintext highlighter-rouge">Ctx</code> before query is executed.</p>

<p>Out-of-the-box sangria comes with several <code class="language-plaintext highlighter-rouge">QueryReducer</code>s for common use-cases:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QueryReducer.measureComplexity</code> - measures a complexity of the query</li>
  <li><code class="language-plaintext highlighter-rouge">QueryReducer.rejectComplexQueries</code> - rejects queries with complexity above provided threshold</li>
  <li><code class="language-plaintext highlighter-rouge">QueryReducer.collectTags</code> - collects <code class="language-plaintext highlighter-rouge">FieldTag</code>s based on a partial function</li>
  <li><code class="language-plaintext highlighter-rouge">QueryReducer.measureDepth</code> - measures max query depth</li>
  <li><code class="language-plaintext highlighter-rouge">QueryReducer.rejectMaxDepth</code> - rejects queries that are deeper than provided threshold</li>
  <li><code class="language-plaintext highlighter-rouge">QueryReducer.hasIntrospection</code> - verifies whether query contains an introspection fields</li>
  <li><code class="language-plaintext highlighter-rouge">QueryReducer.rejectIntrospection</code> - rejects queries that contain an introspection fields. This may be useful for production environments where introspection can potentially be abused.</li>
</ul>

<p>Here is a small example of <code class="language-plaintext highlighter-rouge">QueryReducer.collectTags</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">fetchUserProfile</span> <span class="k">=</span> <span class="nv">QueryReducer</span><span class="o">.</span><span class="py">collectTags</span><span class="o">[</span><span class="kt">MyContext</span>, <span class="kt">String</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Permission</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">name</span>
<span class="o">}</span> <span class="o">{</span> <span class="o">(</span><span class="n">permissionNames</span><span class="o">,</span> <span class="n">ctx</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="nf">if</span> <span class="o">(</span><span class="nv">permissionNames</span><span class="o">.</span><span class="py">nonEmpty</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">userProfile</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">UserProfile</span><span class="o">]</span> <span class="k">=</span> <span class="nv">externalService</span><span class="o">.</span><span class="py">getUserProfile</span><span class="o">()</span>

    <span class="nv">userProfile</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">profile</span> <span class="k">=&gt;</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">copy</span><span class="o">(</span><span class="n">profile</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">profile</span><span class="o">))</span>
  <span class="o">}</span> <span class="k">else</span>
    <span class="n">ctx</span>
<span class="o">}</span>

<span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span>
  <span class="n">userContext</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MyContext</span><span class="o">,</span>
  <span class="n">queryReducers</span> <span class="k">=</span> <span class="n">fetchUserProfile</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
</code></pre></div></div>

<p>This allows you to avoid fetching a user profile if it’s not needed based on the query fields. You can find more information about the <code class="language-plaintext highlighter-rouge">QueryReducer</code>
that analyses query complexity in the <a href="#query-complexity-analysis">Query Complexity Analysis</a> section.</p>

<h2 id="scalar-types">Scalar Types</h2>

<p>Sangria supports all standard GraphQL scalars like <code class="language-plaintext highlighter-rouge">String</code>, <code class="language-plaintext highlighter-rouge">Int</code>, <code class="language-plaintext highlighter-rouge">ID</code>, etc. In addition, sangria introduces the following built-in scalar types:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Long</code> - a 64 bit integer value which is represented as a <code class="language-plaintext highlighter-rouge">Long</code> in Scala code</li>
  <li><code class="language-plaintext highlighter-rouge">BigInt</code> - similar to <code class="language-plaintext highlighter-rouge">Int</code> scalar values, but allows you to transfer big integer values and represents them in code as Scala’s <code class="language-plaintext highlighter-rouge">BigInt</code> class</li>
  <li><code class="language-plaintext highlighter-rouge">BigDecimal</code> - similar to <code class="language-plaintext highlighter-rouge">Float</code> scalar values, but allows you to transfer big decimal values and represents them in code as Scala’s <code class="language-plaintext highlighter-rouge">BigDecimal</code> class</li>
</ul>

<h3 id="custom-scalar-types">Custom Scalar Types</h3>

<p>You can also create your own custom scalar types. The input and output of scalar types should always be a value that the GraphQL grammar supports, like string,
number, boolean, etc. Here is an example of a <code class="language-plaintext highlighter-rouge">DateTime</code> (from joda-time) scalar type implementation:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">object</span> <span class="nc">DateCoercionViolation</span> <span class="k">extends</span> <span class="nc">ValueCoercionViolation</span><span class="o">(</span><span class="s">"Date value expected"</span><span class="o">)</span>

<span class="k">def</span> <span class="nf">parseDate</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Try</span><span class="o">(</span><span class="k">new</span> <span class="nc">DateTime</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="nv">DateTimeZone</span><span class="o">.</span><span class="py">UTC</span><span class="o">))</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">date</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Right</span><span class="o">(</span><span class="n">date</span><span class="o">)</span>
  <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="nc">DateCoercionViolation</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">DateTimeType</span> <span class="k">=</span> <span class="nc">ScalarType</span><span class="o">[</span><span class="kt">DateTime</span><span class="o">](</span><span class="s">"DateTime"</span><span class="o">,</span>
  <span class="n">coerceOutput</span> <span class="k">=</span> <span class="o">(</span><span class="n">d</span><span class="o">,</span> <span class="n">caps</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">caps</span><span class="o">.</span><span class="py">contains</span><span class="o">(</span><span class="nc">DateSupport</span><span class="o">))</span> <span class="nv">d</span><span class="o">.</span><span class="py">toDate</span>
    <span class="k">else</span> <span class="nv">ISODateTimeFormat</span><span class="o">.</span><span class="py">dateTime</span><span class="o">().</span><span class="py">print</span><span class="o">(</span><span class="n">d</span><span class="o">),</span>
  <span class="n">coerceUserInput</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">s</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nf">parseDate</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="nc">DateCoercionViolation</span><span class="o">)</span>
  <span class="o">},</span>
  <span class="n">coerceInput</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nv">ast</span><span class="o">.</span><span class="py">StringValue</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nf">parseDate</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="nc">DateCoercionViolation</span><span class="o">)</span>
  <span class="o">})</span>
</code></pre></div></div>

<p>Some marshalling formats natively support <code class="language-plaintext highlighter-rouge">java.util.Date</code>, so we check for marshaller capabilities here and either return a <code class="language-plaintext highlighter-rouge">Date</code> or
a <code class="language-plaintext highlighter-rouge">String</code> in ISO format.</p>

<h3 id="scalar-type-alias">Scalar Type Alias</h3>

<p>Sometime you want to use a standard scalar type, but add a validation on top of it which may be also represented by different scala type.
Example can be a <code class="language-plaintext highlighter-rouge">UserId</code> value class that represent a <code class="language-plaintext highlighter-rouge">String</code>-based user ID or <code class="language-plaintext highlighter-rouge">Int Refined Positive</code> from <a href="https://github.com/fthomas/refined">refined scala library</a>.</p>

<p>This is exactly what scalar aliases allow you to do. Here is how you can define a scalar alias for mentioned scenarios:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">implicit</span> <span class="k">val</span> <span class="nv">UserIdType</span> <span class="k">=</span> <span class="nc">ScalarAlias</span><span class="o">[</span><span class="kt">UserId</span>, <span class="kt">String</span><span class="o">](</span>
  <span class="nc">StringType</span><span class="o">,</span> <span class="nv">_</span><span class="o">.</span><span class="py">id</span><span class="o">,</span> <span class="n">id</span> <span class="k">=&gt;</span> <span class="nc">Right</span><span class="o">(</span><span class="nc">UserId</span><span class="o">(</span><span class="n">id</span><span class="o">)))</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">PositiveIntType</span> <span class="k">=</span> <span class="nc">ScalarAlias</span><span class="o">[</span><span class="kt">Int</span> <span class="kt">Refined</span> <span class="kt">Positive</span>, <span class="kt">Int</span><span class="o">](</span>
  <span class="nc">IntType</span><span class="o">,</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">,</span> <span class="n">i</span> <span class="k">=&gt;</span> <span class="n">refineV</span><span class="o">[</span><span class="kt">Positive</span><span class="o">](</span><span class="n">i</span><span class="o">).</span><span class="py">left</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="nc">RefineViolation</span><span class="o">))</span>
</code></pre></div></div>

<p>You can use <code class="language-plaintext highlighter-rouge">UserIdType</code> and <code class="language-plaintext highlighter-rouge">PositiveIntType</code> in all places where you can use a scalar types. In introspection results they would be seen as
just <code class="language-plaintext highlighter-rouge">String</code> and <code class="language-plaintext highlighter-rouge">Int</code>, but behind the scenes values would be validated and transformed in correspondent scala types.</p>

<h2 id="deprecation-tracking">Deprecation Tracking</h2>

<p>GraphQL schema allows you to declare fields and enum values as deprecated. When you execute a query, you can provide your custom implementation of the
<code class="language-plaintext highlighter-rouge">DeprecationTracker</code> trait to the <code class="language-plaintext highlighter-rouge">Executor</code> in order to track deprecated fields and enum values (you can, for instance, log all usages or send metrics to graphite):</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">DeprecationTracker</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">deprecatedFieldUsed</span><span class="o">[</span><span class="kt">Ctx</span><span class="o">](</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">Context</span><span class="o">[</span><span class="kt">Ctx</span>, <span class="k">_</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span>
  <span class="k">def</span> <span class="nf">deprecatedEnumValueUsed</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">Ctx</span><span class="o">](</span><span class="n">enum</span><span class="k">:</span> <span class="kt">EnumType</span><span class="o">[</span><span class="kt">T</span><span class="o">],</span> <span class="n">value</span><span class="k">:</span> <span class="kt">T</span><span class="o">,</span> <span class="n">userContext</span><span class="k">:</span> <span class="kt">Ctx</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="authentication-and-authorisation">Authentication and Authorisation</h2>

<p>Even though sangria does not provide security primitives explicitly, it’s pretty straightforward to implement it in different ways. It’s a pretty common
requirement of modern web-applications, so this section was written to demonstrate several possible approaches of handling authentication and authorisation.</p>

<p>First let’s define some basic infrastructure for this example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">userName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">permissions</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>

<span class="k">trait</span> <span class="nc">UserRepo</span> <span class="o">{</span>
  <span class="cm">/** Gives back a token or sessionId or anything else that identifies the user session  */</span>
  <span class="k">def</span> <span class="nf">authenticate</span><span class="o">(</span><span class="n">userName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">password</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>

  <span class="cm">/** Gives `User` object with his/her permissions */</span>
  <span class="k">def</span> <span class="nf">authorise</span><span class="o">(</span><span class="n">token</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">ColorRepo</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">colors</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">addColor</span><span class="o">(</span><span class="n">color</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In order to indicate an auth error, we need to define some exceptions:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">AuthenticationException</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exception</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">AuthorisationException</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exception</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
</code></pre></div></div>

<p>We also want the user to see proper error messages in a response, so let’s define an error handler for this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">errorHandler</span> <span class="k">=</span> <span class="nc">ExceptionHandler</span> <span class="o">{</span>
  <span class="nf">case</span> <span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="nc">AuthenticationException</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="nc">HandledException</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
  <span class="nf">case</span> <span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="nc">AuthorisationException</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="nc">HandledException</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now that we defined a base for a secure application, let’s create a context class, which will provide GraphQL schema with all necessary helper functions:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">SecureContext</span><span class="o">(</span><span class="n">token</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">userRepo</span><span class="k">:</span> <span class="kt">UserRepo</span><span class="o">,</span> <span class="n">colorRepo</span><span class="k">:</span> <span class="kt">ColorRepo</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">login</span><span class="o">(</span><span class="n">userName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">password</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nv">userRepo</span><span class="o">.</span><span class="py">authenticate</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span> <span class="nf">getOrElse</span> <span class="o">(</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">AuthenticationException</span><span class="o">(</span><span class="s">"UserName or password is incorrect"</span><span class="o">))</span>

  <span class="k">def</span> <span class="nf">authorised</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">permissions</span><span class="k">:</span> <span class="kt">String*</span><span class="o">)(</span><span class="n">fn</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=&gt;</span> <span class="n">T</span><span class="o">)</span> <span class="k">=</span>
    <span class="nv">token</span><span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="nv">userRepo</span><span class="o">.</span><span class="py">authorise</span><span class="o">).</span><span class="py">fold</span><span class="o">(</span><span class="k">throw</span> <span class="nc">AuthorisationException</span><span class="o">(</span><span class="s">"Invalid token"</span><span class="o">))</span> <span class="o">{</span> <span class="n">user</span> <span class="k">=&gt;</span>
      <span class="nf">if</span> <span class="o">(</span><span class="nv">permissions</span><span class="o">.</span><span class="py">forall</span><span class="o">(</span><span class="nv">user</span><span class="o">.</span><span class="py">permissions</span><span class="o">.</span><span class="py">contains</span><span class="o">))</span> <span class="nf">fn</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>
      <span class="k">else</span> <span class="k">throw</span> <span class="nc">AuthorisationException</span><span class="o">(</span><span class="s">"You do not have permission to do this operation"</span><span class="o">)</span>
    <span class="o">}</span>

  <span class="k">def</span> <span class="nf">ensurePermissions</span><span class="o">(</span><span class="n">permissions</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
    <span class="nv">token</span><span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="nv">userRepo</span><span class="o">.</span><span class="py">authorise</span><span class="o">).</span><span class="py">fold</span><span class="o">(</span><span class="k">throw</span> <span class="nc">AuthorisationException</span><span class="o">(</span><span class="s">"Invalid token"</span><span class="o">))</span> <span class="o">{</span> <span class="n">user</span> <span class="k">=&gt;</span>
      <span class="nf">if</span> <span class="o">(!</span><span class="nv">permissions</span><span class="o">.</span><span class="py">forall</span><span class="o">(</span><span class="nv">user</span><span class="o">.</span><span class="py">permissions</span><span class="o">.</span><span class="py">contains</span><span class="o">))</span>
        <span class="k">throw</span> <span class="nc">AuthorisationException</span><span class="o">(</span><span class="s">"You do not have permission to do this operation"</span><span class="o">)</span>
    <span class="o">}</span>

  <span class="k">def</span> <span class="nf">user</span> <span class="k">=</span> <span class="nv">token</span><span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="nv">userRepo</span><span class="o">.</span><span class="py">authorise</span><span class="o">).</span><span class="py">fold</span><span class="o">(</span><span class="k">throw</span> <span class="nc">AuthorisationException</span><span class="o">(</span><span class="s">"Invalid token"</span><span class="o">))(</span><span class="n">identity</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now we should be able to execute queries:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Executor</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="n">queryAst</span><span class="o">,</span>
  <span class="n">userContext</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SecureContext</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">userRepo</span><span class="o">,</span> <span class="n">colorRepo</span><span class="o">),</span>
  <span class="n">exceptionHandler</span> <span class="k">=</span> <span class="n">errorHandler</span><span class="o">)</span>
</code></pre></div></div>

<p>As a last step, we need to define a schema. You can do it in two different ways:</p>

<ul>
  <li>Auth can be enforced in the <code class="language-plaintext highlighter-rouge">resolve</code> function itself</li>
  <li>You can use <code class="language-plaintext highlighter-rouge">Middleware</code> and <code class="language-plaintext highlighter-rouge">FieldTag</code>s to ensure that user has permissions to access fields</li>
</ul>

<h3 id="resolve-based-auth">Resolve-Based Auth</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">UserNameArg</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"userName"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">PasswordArg</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">ColorArg</span> <span class="k">=</span> <span class="nc">Argument</span><span class="o">(</span><span class="s">"color"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">UserType</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">(</span><span class="s">"User"</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="kt">SecureContext</span>, <span class="kt">User</span><span class="o">](</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"userName"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">userName</span><span class="o">),</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"permissions"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ListType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">)),</span>
    <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">authorised</span><span class="o">(</span><span class="s">"VIEW_PERMISSIONS"</span><span class="o">)</span> <span class="o">{</span> <span class="k">_</span> <span class="k">=&gt;</span>
      <span class="nv">ctx</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">permissions</span>
    <span class="o">})</span>
<span class="o">))</span>

<span class="k">val</span> <span class="nv">QueryType</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">(</span><span class="s">"Query"</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="kt">SecureContext</span>, <span class="kt">Unit</span><span class="o">](</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"me"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">UserType</span><span class="o">),</span> <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">authorised</span><span class="o">()(</span><span class="n">user</span> <span class="k">=&gt;</span> <span class="n">user</span><span class="o">)),</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"colors"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ListType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">)),</span>
    <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">authorised</span><span class="o">(</span><span class="s">"VIEW_COLORS"</span><span class="o">)</span> <span class="o">{</span> <span class="k">_</span> <span class="k">=&gt;</span>
      <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">colorRepo</span><span class="o">.</span><span class="py">colors</span>
    <span class="o">})</span>
<span class="o">))</span>

<span class="k">val</span> <span class="nv">MutationType</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">(</span><span class="s">"Mutation"</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="kt">SecureContext</span>, <span class="kt">Unit</span><span class="o">](</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"login"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">),</span>
    <span class="n">arguments</span> <span class="k">=</span> <span class="nc">UserNameArg</span> <span class="o">::</span> <span class="nc">PasswordArg</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
    <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="nc">UpdateCtx</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">login</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">arg</span><span class="o">(</span><span class="nc">UserNameArg</span><span class="o">),</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">arg</span><span class="o">(</span><span class="nc">PasswordArg</span><span class="o">)))</span> <span class="o">{</span> <span class="n">token</span> <span class="k">=&gt;</span>
      <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">copy</span><span class="o">(</span><span class="n">token</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">token</span><span class="o">))</span>
    <span class="o">}),</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"addColor"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ListType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">)),</span>
    <span class="n">arguments</span> <span class="k">=</span> <span class="nc">ColorArg</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
    <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">authorised</span><span class="o">(</span><span class="s">"EDIT_COLORS"</span><span class="o">)</span> <span class="o">{</span> <span class="k">_</span> <span class="k">=&gt;</span>
      <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">colorRepo</span><span class="o">.</span><span class="py">addColor</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">arg</span><span class="o">(</span><span class="nc">ColorArg</span><span class="o">))</span>
      <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">colorRepo</span><span class="o">.</span><span class="py">colors</span>
    <span class="o">})</span>
<span class="o">))</span>

<span class="k">def</span> <span class="nf">schema</span> <span class="k">=</span> <span class="nc">Schema</span><span class="o">(</span><span class="nc">QueryType</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">MutationType</span><span class="o">))</span>
</code></pre></div></div>

<p>As you can see on this example, we are using context object to authorise user with the <code class="language-plaintext highlighter-rouge">authorised</code> function. An interesting thing to notice
here is that the <code class="language-plaintext highlighter-rouge">login</code> field uses the <code class="language-plaintext highlighter-rouge">UpdateCtx</code> action in order make login information available for sibling mutation fields. This makes queries
like this possible:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">mutation</span> <span class="nx">LoginAndMutate</span> <span class="p">{</span>
  <span class="nx">login</span><span class="p">(</span><span class="nx">userName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">admin</span><span class="dl">"</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">secret</span><span class="dl">"</span><span class="p">)</span>

  <span class="nx">withMagenta</span><span class="p">:</span> <span class="nx">addColor</span><span class="p">(</span><span class="nx">color</span><span class="p">:</span> <span class="dl">"</span><span class="s2">magenta</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">withOrange</span><span class="p">:</span> <span class="nx">addColor</span><span class="p">(</span><span class="nx">color</span><span class="p">:</span> <span class="dl">"</span><span class="s2">orange</span><span class="dl">"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we login and add colors in the same GraphQL query. It will produce a result like this one:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"login"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a4d7fc91-e490-446e-9d4c-90b5bb22e51d"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"withMagenta"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="s2">"green"</span><span class="p">,</span><span class="w"> </span><span class="s2">"blue"</span><span class="p">,</span><span class="w"> </span><span class="s2">"magenta"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"withOrange"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="s2">"green"</span><span class="p">,</span><span class="w"> </span><span class="s2">"blue"</span><span class="p">,</span><span class="w"> </span><span class="s2">"magenta"</span><span class="p">,</span><span class="w"> </span><span class="s2">"orange"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>If the user does not have sufficient permissions, they will see a result like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"me"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"userName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"john"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"permissions"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"colors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="s2">"green"</span><span class="p">,</span><span class="w"> </span><span class="s2">"blue"</span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"errors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"You do not have permission to do this operation"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"me.permissions"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"locations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"line"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
          </span><span class="nl">"column"</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="middleware-based-auth">Middleware-Based Auth</h3>

<p>An alternative approach is to use middleware. This can provide a more declarative way to define field permissions.</p>

<p>First let’s define <code class="language-plaintext highlighter-rouge">FieldTag</code>s:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">object</span> <span class="nc">Authorised</span> <span class="k">extends</span> <span class="nc">FieldTag</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Permission</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">FieldTag</span>
</code></pre></div></div>

<p>This allows us to define a schema like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">UserType</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">(</span><span class="s">"User"</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="kt">SecureContext</span>, <span class="kt">User</span><span class="o">](</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"userName"</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">userName</span><span class="o">),</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"permissions"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ListType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">)),</span>
    <span class="n">tags</span> <span class="k">=</span> <span class="nc">Permission</span><span class="o">(</span><span class="s">"VIEW_PERMISSIONS"</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
    <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">value</span><span class="o">.</span><span class="py">permissions</span><span class="o">)</span>
<span class="o">))</span>

<span class="k">val</span> <span class="nv">QueryType</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">(</span><span class="s">"Query"</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="kt">SecureContext</span>, <span class="kt">Unit</span><span class="o">](</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"me"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">UserType</span><span class="o">),</span> <span class="n">tags</span> <span class="k">=</span> <span class="nc">Authorised</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span><span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">user</span><span class="o">),</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"colors"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ListType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">)),</span>
    <span class="n">tags</span> <span class="k">=</span> <span class="nc">Permission</span><span class="o">(</span><span class="s">"VIEW_COLORS"</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span> <span class="n">resolve</span> <span class="k">=</span> <span class="nv">_</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">colorRepo</span><span class="o">.</span><span class="py">colors</span><span class="o">)</span>
<span class="o">))</span>

<span class="k">val</span> <span class="nv">MutationType</span> <span class="k">=</span> <span class="nc">ObjectType</span><span class="o">(</span><span class="s">"Mutation"</span><span class="o">,</span> <span class="n">fields</span><span class="o">[</span><span class="kt">SecureContext</span>, <span class="kt">Unit</span><span class="o">](</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"login"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">),</span>
    <span class="n">arguments</span> <span class="k">=</span> <span class="nc">UserNameArg</span> <span class="o">::</span> <span class="nc">PasswordArg</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
    <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="nc">UpdateCtx</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">login</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">arg</span><span class="o">(</span><span class="nc">UserNameArg</span><span class="o">),</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">arg</span><span class="o">(</span><span class="nc">PasswordArg</span><span class="o">)))</span> <span class="o">{</span> <span class="n">token</span> <span class="k">=&gt;</span>
      <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">copy</span><span class="o">(</span><span class="n">token</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">token</span><span class="o">))</span>
    <span class="o">}),</span>
  <span class="nc">Field</span><span class="o">(</span><span class="s">"addColor"</span><span class="o">,</span> <span class="nc">OptionType</span><span class="o">(</span><span class="nc">ListType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">)),</span>
    <span class="n">arguments</span> <span class="k">=</span> <span class="nc">ColorArg</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
    <span class="n">tags</span> <span class="k">=</span> <span class="nc">Permission</span><span class="o">(</span><span class="s">"EDIT_COLORS"</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
    <span class="n">resolve</span> <span class="k">=</span> <span class="n">ctx</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">colorRepo</span><span class="o">.</span><span class="py">addColor</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">arg</span><span class="o">(</span><span class="nc">ColorArg</span><span class="o">))</span>
      <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span><span class="o">.</span><span class="py">colorRepo</span><span class="o">.</span><span class="py">colors</span>
    <span class="o">})</span>
<span class="o">))</span>

<span class="k">def</span> <span class="nf">schema</span> <span class="k">=</span> <span class="nc">Schema</span><span class="o">(</span><span class="nc">QueryType</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">MutationType</span><span class="o">))</span>
</code></pre></div></div>

<p>As you can see, security constraints are now defined as field’s <code class="language-plaintext highlighter-rouge">tags</code>. In order to enforce these security constraints we need implement <code class="language-plaintext highlighter-rouge">Middleware</code> like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">SecurityEnforcer</span> <span class="k">extends</span> <span class="nc">Middleware</span><span class="o">[</span><span class="kt">SecureContext</span><span class="o">]</span> <span class="k">with</span> <span class="nc">MiddlewareBeforeField</span><span class="o">[</span><span class="kt">SecureContext</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">type</span> <span class="kt">QueryVal</span> <span class="o">=</span> <span class="nc">Unit</span>
  <span class="k">type</span> <span class="kt">FieldVal</span> <span class="o">=</span> <span class="nc">Unit</span>

  <span class="k">def</span> <span class="nf">beforeQuery</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">SecureContext</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span> <span class="o">()</span>
  <span class="k">def</span> <span class="nf">afterQuery</span><span class="o">(</span><span class="n">queryVal</span><span class="k">:</span> <span class="kt">QueryVal</span><span class="o">,</span> <span class="n">context</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">SecureContext</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span> <span class="o">()</span>

  <span class="k">def</span> <span class="nf">beforeField</span><span class="o">(</span><span class="n">queryVal</span><span class="k">:</span> <span class="kt">QueryVal</span><span class="o">,</span> <span class="n">mctx</span><span class="k">:</span> <span class="kt">MiddlewareQueryContext</span><span class="o">[</span><span class="kt">SecureContext</span>, <span class="k">_</span>, <span class="k">_</span><span class="o">],</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">Context</span><span class="o">[</span><span class="kt">SecureContext</span>, <span class="k">_</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">permissions</span> <span class="k">=</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">field</span><span class="o">.</span><span class="py">tags</span><span class="o">.</span><span class="py">collect</span> <span class="o">{</span><span class="k">case</span> <span class="nc">Permission</span><span class="o">(</span><span class="n">p</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">p</span><span class="o">}</span>
    <span class="k">val</span> <span class="nv">requireAuth</span> <span class="k">=</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">field</span><span class="o">.</span><span class="py">tags</span> <span class="n">contains</span> <span class="nc">Authorised</span>
    <span class="k">val</span> <span class="nv">securityCtx</span> <span class="k">=</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">ctx</span>

    <span class="nf">if</span> <span class="o">(</span><span class="n">requireAuth</span><span class="o">)</span>
      <span class="nv">securityCtx</span><span class="o">.</span><span class="py">user</span>

    <span class="nf">if</span> <span class="o">(</span><span class="nv">permissions</span><span class="o">.</span><span class="py">nonEmpty</span><span class="o">)</span>
      <span class="nv">securityCtx</span><span class="o">.</span><span class="py">ensurePermissions</span><span class="o">(</span><span class="n">permissions</span><span class="o">)</span>

    <span class="n">continue</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="graphql-federation">GraphQL federation</h2>

<p>If you want to use <a href="https://www.apollographql.com/docs/federation/">GraphQL federation</a>, you can use sangria to provide a service subgraph.
For that, use the <a href="https://github.com/sangria-graphql/sangria-federated/">sangria-federated</a> library that supports Federation v1 and v2.</p>

<h2 id="helpers">Helpers</h2>

<p>There are quite a few helpers available which you may find useful in different situations.</p>

<h3 id="introspection-result-parsing">Introspection Result Parsing</h3>

<p>Sometimes you would like to work with the results of an introspection query. This can be necessary in some client-side tools, for instance. Instead of working
directly with JSON (or other raw representations), you can parse it into a set of case classes that allow you to easily work with the whole schema introspection.</p>

<p>You can find a parser function in <code class="language-plaintext highlighter-rouge">sangria.introspection.IntrospectionParser</code>.</p>

<h3 id="determine-a-query-operation-type">Determine a Query Operation Type</h3>

<p>Sometimes it can be very useful to know the type of query operation. For example you need it if you want to return a different response for subscription queries. <code class="language-plaintext highlighter-rouge">ast.Document</code> exposes <code class="language-plaintext highlighter-rouge">operationType</code> and <code class="language-plaintext highlighter-rouge">operation</code> for this.</p>

    </div>

    <nav class="col-md-3 bs-docs-sidebar" id="sidebar"></nav>
  </div>
</div>

<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'sangria-graphql/sangria'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>


  <!-- Placed at the end of the document so the pages load faster -->
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/bootstrap/js/bootstrap.min.js"></script>
<script src="/assets/js/main.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-65759630-1', 'sangria-graphql.github.io');
  ga('send', 'pageview');

</script>


</body>
</html>